---
title: "analysis"
output: html_document
date: "2023-08-15"
---

```{r setup, include=FALSE}
library(ggplot2)
library(ggrepel)
library(EMMREML)
library(reshape2)
library(cobs)
library(cowplot)
library(stringr)
library(viridis)

#bioc packages:
library(edgeR)
library(qvalue)

library(parallel)
library(GGally)

library(UpSetR)
library(mashr)

##cibersort
library(e1071)
library(preprocessCore)
library(edgeR)
library(gridExtra)




```

```{r scripts and dirs}

workDir <- gitDir <- "~/Documents/giterdone/"

dataDir <- paste0(workDir,"data/")
figDir <- paste0(workDir,"figures/")
outDir <- paste0(workDir,"output/")

dir.create(dataDir)
dir.create(figDir)
dir.create(outDir)

source(paste0(gitDir,"meerkatPaper/rScripts/gatherData.R"))
source(paste0(gitDir,"meerkatPaper/rScripts/generateResiduals.R"))
source(paste0(gitDir,"meerkatPaper/rScripts/runEmmreml.R"))
source(paste0(gitDir,"meerkatPaper/rScripts/runResponseEmreml.R"))
source(paste0(gitDir,"meerkatPaper/rScripts/perm.fdr.R"))
source(paste0(gitDir,"meerkatPaper/rScripts/compLMMBeta.R"))
source(paste0(gitDir,"meerkatPaper/rScripts/gsea.R"))


```


gather data for a given model:
Treatment (LPS)
Sex (F)
Batch (All, Batch2020, Batch2021)
```{r using gatherData}
batchList <- "allBatches"

for (focalSex in c("M","F")) {
    for (minGenes in c(10000)) {
      for (minLogCPM in c(5,7,"status")) {
        for (singTrt in c(T,F)) {
          if (singTrt) {
            for (focalTreatment in c("LPS","Dex","Gard","Ctrl")) {
              gatherData(workDir = workDir, 
                         batchList = batchList,
                         focalSex = focalSex,
                         focalTreatment = focalTreatment,
                         minGenes = minGenes,
                         minLogCPM = minLogCPM,
                         singleTrt = singTrt)
            }
          } else {
            for (focalTreatment in c("LPS","Dex","Gard")) {
              gatherData(workDir = workDir, 
                         batchList = batchList,
                         focalSex = focalSex,
                         focalTreatment = focalTreatment,
                         minGenes = minGenes,
                         minLogCPM = minLogCPM,
                         singleTrt = singTrt)
          }
        } 
      }
    }
  }
}

for (focalSex in c("F","M")) {
  for (minLogCPM in c(5,7,"status")) {
    print(paste0(focalSex," ",minLogCPM))
    gatherData(workDir =  workDir, batchList = "allBatches", focalSex = focalSex, focalTreatment = "allTrt",
               minGenes = 10000, minLogCPM = minLogCPM, singleTrt = FALSE, combineTrt = TRUE)
  }
}
```


```{r using genResids}
### and now generate residuals

# workDir <- workDir
# batchList <- c("allBatches")
# focalSex <- "F"
# focalTreatment <- "LPS"
# minLogCPM <- 5
# minGenes <- 10000
# singleTrt <- FALSE
# combineTrt <- FALSE
 

for (focalSex in c("M","F")) {
    for (minGenes in c(10000)) {
      for (minLogCPM in c(5,7,"status")) {
        for (singTrt in c(F,T)) {
          if (singTrt) {
            for (focalTreatment in c("LPS","Dex","Gard","Ctrl")) {
              gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
              ## run some genResids for TRTonly by Model
              if (focalTreatment %in% c("LPS","Ctrl")) {
                for (modelName in c("F","P","R")) {
                  if (!(modelName == "P" & focalSex == "M")) {
                    genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
                  }
                }
              } else {
                for (modelName in c("G","Q","S")) {
                  if (!(modelName == "Q" & focalSex == "M")) {
                    genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
                  }
                }
              }
            }
          } else if (combineTrt){
            gatherSubset <- paste0(batchList,"_",focalSex,"_allTrt_",minGenes,"genes_",minLogCPM,"lCPM")
            ## run some genResids for combined treatment
            for (modelName in c("G","Q","S")) {
              if (!(modelName == "S" & focalSex == "M")) {
                genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
              }
            }
          } else {
            for (focalTreatment in c("LPS","Dex","Gard")) {
              gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"_",minGenes,"genes_",minLogCPM,"lCPM")
              ### run some genResids for TRT-Ctrl
              if (focalTreatment %in% c("LPS")) {
                for (modelName in c("F","P","R")) {
                  if (!(modelName == "P" & focalSex == "M")) {
                    genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
                  }
                }
              } else {
                for (modelName in c("G","Q","S")) {
                  if (!(modelName == "Q" & focalSex == "M")) {
                    genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
                  }
                }
              }
            }
          }
        }
      }
    }
}


for (focalSex in c("F","M")) {
  for (minLogCPM in c(5,7,"status")) {
    print(paste0(focalSex," ",minLogCPM))
    gatherSubset <- paste0(batchList,"_",focalSex,"_allTrt_",minGenes,"genes_",minLogCPM,"lCPM")
    for (modelName in c("G","Q","S")) {
      if (!(modelName == "Q" & focalSex == "M")) {
        genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
      }
    }
  }
}
              
```

generate weight residuals
```{r using genResids}
### and now generate residuals

# workDir <- workDir
# batchList <- c("allBatches")
# focalSex <- "F"
# focalTreatment <- "LPS"
# minLogCPM <- 5
# minGenes <- 10000
# singleTrt <- FALSE
# combineTrt <- FALSE

#P <- T
#Q <- U
#R <- V
#S <- W
 

for (focalSex in c("M","F")) {
    for (minGenes in c(10000)) {
      for (minLogCPM in c(5,7,"status")) {
        for (singTrt in c(F,T)) {
          if (singTrt) {
            for (focalTreatment in c("LPS","Dex","Gard","Ctrl")) {
              gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
              ## run some genResids for TRTonly by Model
              if (focalTreatment %in% c("LPS","Ctrl")) {
                for (modelName in c("F","T","V")) {
                  
                    genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
                  
                }
              } else {
                for (modelName in c("G","U","W")) {
                  
                    genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
                  
                }
              }
            }
          } else if (combineTrt){
            gatherSubset <- paste0(batchList,"_",focalSex,"_allTrt_",minGenes,"genes_",minLogCPM,"lCPM")
            ## run some genResids for combined treatment
            for (modelName in c("G","U","W")) {
              
                genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
              
            }
          } else {
            for (focalTreatment in c("LPS","Dex","Gard")) {
              gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"_",minGenes,"genes_",minLogCPM,"lCPM")
              ### run some genResids for TRT-Ctrl
              if (focalTreatment %in% c("LPS")) {
                for (modelName in c("F","T","V")) {
                  
                    genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
                  
                }
              } else {
                for (modelName in c("G","U","W")) {
                  
                    genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
                  
                }
              }
            }
          }
        }
      }
    }
}


```

generate residuals - original
```{r using genResids}
### and now generate residuals

# workDir <- workDir
# batchList <- c("allBatches")
# focalSex <- "F"
# focalTreatment <- "LPS"
# minLogCPM <- 5
# minGenes <- 10000
# singleTrt <- FALSE
# combineTrt <- FALSE
 

for (focalSex in c("M","F")) {
    for (minGenes in c(10000)) {
      for (minLogCPM in c(5,7,"status")) {
        for (singTrt in c(F,T)) {
          if (singTrt) {
            for (focalTreatment in c("LPS","Dex","Gard","Ctrl")) {
              gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
              ## run some genResids for TRTonly by Model
              if (focalTreatment %in% c("LPS","Ctrl")) {
                for (modelName in c("F","P","R")) {
                  if (!(modelName == "P" & focalSex == "M")) {
                    genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
                  }
                }
              } else {
                for (modelName in c("G","Q","S")) {
                  if (!(modelName == "Q" & focalSex == "M")) {
                    genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
                  }
                }
              }
            }
          } else if (combineTrt){
            gatherSubset <- paste0(batchList,"_",focalSex,"_allTrt_",minGenes,"genes_",minLogCPM,"lCPM")
            ## run some genResids for combined treatment
            for (modelName in c("G","Q","S")) {
              if (!(modelName == "S" & focalSex == "M")) {
                genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
              }
            }
          } else {
            for (focalTreatment in c("LPS","Dex","Gard")) {
              gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"_",minGenes,"genes_",minLogCPM,"lCPM")
              ### run some genResids for TRT-Ctrl
              if (focalTreatment %in% c("LPS")) {
                for (modelName in c("F","P","R")) {
                  if (!(modelName == "P" & focalSex == "M")) {
                    genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
                  }
                }
              } else {
                for (modelName in c("G","Q","S")) {
                  if (!(modelName == "Q" & focalSex == "M")) {
                    genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
                  }
                }
              }
            }
          }
        }
      }
    }
}


for (focalSex in c("F","M")) {
  for (minLogCPM in c(5,7,"status")) {
    print(paste0(focalSex," ",minLogCPM))
    gatherSubset <- paste0(batchList,"_",focalSex,"_allTrt_",minGenes,"genes_",minLogCPM,"lCPM")
    for (modelName in c("G","Q","S")) {
      if (!(modelName == "Q" & focalSex == "M")) {
        genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
      }
    }
  }
}
              
```



```{r using runEmreml treatment control models}
batchList <- "allBatches"
minGenes <- 10000
#finishedModels <- vector()

### testing single
for (focalSex in c("F","M")) {
  for (focalTreatment in c("LPS","Dex","Gard")) {
    for (minLogCPM in c(5,7,"status")) {
      print(paste0(focalSex," - ",focalTreatment," - ",minLogCPM))
      gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"_",minGenes,"genes_",minLogCPM,"lCPM")
      if (focalTreatment == "LPS") {
        #modelList <- c("F","T","V")
        modelList <- c("F")
        noMaleModel <- "P"
      } else {
        #modelList <- c("G","U","W")
        modelList <- c("G")
        noMaleModel <- "Q"
      }
      
      for (modelName in modelList) {
        #if this hasn't been run before
        if (!paste0(gatherSubset,"_",modelName) %in% finishedModels) {
        if (!(modelName == noMaleModel & focalSex == "M")) {
          if (focalSex == "F") {
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic", Kmat = TRUE, Kfile = "~/Dropbox (Personal)/meerkats/KMPsamples/KMPrelatedness_matrix.RDS")
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicPreg", Kmat = TRUE, Kfile = "~/Dropbox (Personal)/meerkats/KMPsamples/KMPrelatedness_matrix.RDS")
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic+Weight", Kmat = TRUE, Kfile = "~/Dropbox (Personal)/meerkats/KMPsamples/KMPrelatedness_matrix.RDS")
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicPreg+Weight", Kmat = TRUE, Kfile = "~/Dropbox (Personal)/meerkats/KMPsamples/KMPrelatedness_matrix.RDS")
          } else {
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic", Kmat = TRUE, Kfile = "~/Dropbox (Personal)/meerkats/KMPsamples/KMPrelatedness_matrix.RDS")
            #add weight
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic+Weight", Kmat = TRUE, Kfile = "~/Dropbox (Personal)/meerkats/KMPsamples/KMPrelatedness_matrix.RDS")
          }
        }
        finishedModels <- c(finishedModels,paste0(gatherSubset,"_",modelName))
        }
      }
    }
  }
}

### treatment only models

batchList <- "allBatches"
minGenes <- 10000
finishedModels <- vector()

### testing single
for (focalSex in c("F","M")) {
  for (focalTreatment in c("LPS","Dex","Gard","Ctrl")) {
    for (minLogCPM in c(5,7,"status")) {
      print(paste0(focalSex," - ",focalTreatment," - ",minLogCPM))
      gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
      if (focalTreatment %in% c("LPS","Ctrl")) {
        #modelList <- c("F","T","V")
        modelList <- c("F")
        noMaleModel <- "P"
      } else {
        #modelList <- c("G","U","W")
        modelList <- c("G")
        noMaleModel <- "Q"
      }
      
      for (modelName in modelList) {
        #if this hasn't been run before
        if (!paste0(gatherSubset,"_",modelName) %in% finishedModels) {
        if (!(modelName == noMaleModel & focalSex == "M")) {
          if (focalSex == "F") {
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic", Kmat = TRUE, Kfile = "~/Dropbox (Personal)/meerkats/KMPsamples/KMPrelatedness_matrix.RDS")
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicPreg", Kmat = TRUE, Kfile = "~/Dropbox (Personal)/meerkats/KMPsamples/KMPrelatedness_matrix.RDS")
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic+Weight", Kmat = TRUE, Kfile = "~/Dropbox (Personal)/meerkats/KMPsamples/KMPrelatedness_matrix.RDS")
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicPreg+Weight", Kmat = TRUE, Kfile = "~/Dropbox (Personal)/meerkats/KMPsamples/KMPrelatedness_matrix.RDS")
          } else {
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic", Kmat = TRUE, Kfile = "~/Dropbox (Personal)/meerkats/KMPsamples/KMPrelatedness_matrix.RDS")
            #add weight
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic+Weight", Kmat = TRUE, Kfile = "~/Dropbox (Personal)/meerkats/KMPsamples/KMPrelatedness_matrix.RDS")
          }
        }
        finishedModels <- c(finishedModels,paste0(gatherSubset,"_",modelName))
        }
      }
    }
  }
}


#all treatment samples together
#run some emreml

for (focalSex in c("F","M")) {
  for (minLogCPM in c(5,7,"status")) {
    print(paste0(focalSex," ",minLogCPM))
    gatherSubset <- paste0(batchList,"_",focalSex,"_allTrt_",minGenes,"genes_",minLogCPM,"lCPM")
    if (focalSex == "F") {
      #for (modelName in c("G","Q","S")) {
      for (modelName in c("G")) {
        print(paste0(focalSex," ",minLogCPM," ",modelName))
        #runEmreml(workDir =  workDir, gatherSubset = gatherSubset, model = modelName, LM = "allTrtF", Kmat = TRUE, Kfile = "~/Dropbox (Personal)/meerkats/KMPsamples/KMPrelatedness_matrix.RDS")
        runEmreml(workDir =  workDir, gatherSubset = gatherSubset, model = modelName, LM = "allTrtF+Weight", Kmat = TRUE, Kfile = "~/Dropbox (Personal)/meerkats/KMPsamples/KMPrelatedness_matrix.RDS")
        }
      } else {
      #for (modelName in c("G","S")) {
        for (modelName in c("G")) {
        print(paste0(focalSex," ",minLogCPM," ",modelName))
        #runEmreml(workDir =  workDir, gatherSubset = gatherSubset, model = modelName, LM = "allTrtM", Kmat = TRUE, Kfile = "~/Dropbox (Personal)/meerkats/KMPsamples/KMPrelatedness_matrix.RDS")
        runEmreml(workDir =  workDir, gatherSubset = gatherSubset, model = modelName, LM = "allTrtM+Weight", Kmat = TRUE, Kfile = "~/Dropbox (Personal)/meerkats/KMPsamples/KMPrelatedness_matrix.RDS")
      }
    }
  }
}


```


### Weight control emmreml

```{r using runEmreml treatment control models}
#trt-control

batchList <- "allBatches"
minGenes <- 10000
finishedModels <- vector()

### testing single
for (focalSex in c("F","M")) {
  for (focalTreatment in c("LPS","Dex","Gard")) {
    for (minLogCPM in c(5,7,"status")) {
      gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"_",minGenes,"genes_",minLogCPM,"lCPM")
      if (focalTreatment == "LPS") {
        modelList <- c("F","P","R")
        noMaleModel <- "P"
      } else {
        modelList <- c("G","Q","S")
        noMaleModel <- "Q"
      }
      
      for (modelName in modelList) {
        #if this hasn't been run before
        if (!paste0(gatherSubset,"_",modelName) %in% finishedModels) {
        if (!(modelName == noMaleModel & focalSex == "M")) {
          if (focalSex == "F") {
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicPreg")
            #add weight
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicPreg+Weight")
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nestedWPreg")
            #add weight
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nestedWPreg+Weight")
          } else {
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic")
            #add weight
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic+Weight")
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nested")
            #add weight
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nested+Weight")
          }

        }
        finishedModels <- c(finishedModels,paste0(gatherSubset,"_",modelName))
        }
      }
    }
  }
}


#treatment only

batchList <- "allBatches"
minGenes <- 10000
finishedModels <- vector()

### testing single
for (focalSex in c("F","M")) {
  for (focalTreatment in c("LPS","Dex","Gard","Ctrl")) {
    for (minLogCPM in c(5,7,"status")) {
      gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
      if (focalTreatment %in% c("LPS","Ctrl")) {
        modelList <- c("F","P","R")
        noMaleModel <- "P"
      } else {
        modelList <- c("G","Q","S")
        noMaleModel <- "Q"
      }
      
      for (modelName in modelList) {
        #if this hasn't been run before
        if (!paste0(gatherSubset,"_",modelName) %in% finishedModels) {
        if (!(modelName == noMaleModel & focalSex == "M")) {
          if (focalSex == "F") {
            #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicPreg")
            #add weight
            #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicPreg+Weight")
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicPregWeightOnly")
          } else {
            #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic")
            #add weight
            #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic+Weight")
          }

        }
        finishedModels <- c(finishedModels,paste0(gatherSubset,"_",modelName))
        }
      }
    }
  }
}

```



```{r nest weight within status}
#nested weights

batchList <- "allBatches"
minGenes <- 10000
finishedModels <- vector()

### testing single
for (focalSex in c("F","M")) {
  for (focalTreatment in c("LPS","Dex","Gard","Ctrl")) {
    for (minLogCPM in c(5,7,"status")) {
      gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
      if (focalTreatment %in% c("LPS","Ctrl")) {
        modelList <- c("F","P","R")
        noMaleModel <- "P"
      } else {
        modelList <- c("G","Q","S")
        noMaleModel <- "Q"
      }
      
      for (modelName in modelList) {
        #if this hasn't been run before
        if (!paste0(gatherSubset,"_",modelName) %in% finishedModels) {
        if (!(modelName == noMaleModel & focalSex == "M")) {
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nestedWeight")
        }
        finishedModels <- c(finishedModels,paste0(gatherSubset,"_",modelName))
        }
      }
    }
  }
}
```


```{r response emmreml}

batchList <- "allBatches"
minGenes <- 10000
finishedModels <- vector()

#LMList <- c("basicResp","basicResp+Weight","basicResp+Preg","basicResp+Preg+Weight","respNestedPreg")
LMList <- "respNestedWeight"
#breaking for Dex / Model G / basicResp -- but i really only care about LPS 

### testing single
for (focalSex in c("F")) {
  for (focalTreatment in c("LPS","Dex","Gard")) {
    #for (minLogCPM in c(5,7,"status")) {
    for (minLogCPM in c(5)) {
      gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"_",minGenes,"genes_",minLogCPM,"lCPM")
      if (focalTreatment %in% c("LPS","Ctrl")) {
        modelList <- c("F","P","R")
        noMaleModel <- "P"
      } else {
        modelList <- c("G","Q","S")
        noMaleModel <- "Q"
      }
      modelName <- modelList[1]
      for (modelName in modelList) {
        #if this hasn't been run before
        if (!paste0(gatherSubset,"_",modelName) %in% finishedModels) {
        if (!(modelName == noMaleModel & focalSex == "M")) {
          lmModel <- LMList[1]
          for (lmModel in LMList) {
            runResponseEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = lmModel)
          }
        }
        finishedModels <- c(finishedModels,paste0(gatherSubset,"_",modelName))
        }
      }
    }
  }
}
```


```{r testing filter issue}
#having an issue where the "filtered counts" object doesn't match the meta or counts object, the wrong individuals are used

workDir <- workDir
batchList <- c("allBatches")
focalSex <- "F"
focalTreatment <- "LPS"
minLogCPM <- 5
minGenes <- 10000
singleTrt <- TRUE
combineTrt <- FALSE
 
if (singleTrt) {
 gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
} else if (combineTrt) {
 gatherSubset <- paste0(batchList,"_",focalSex,"_allTrt_",minGenes,"genes_",minLogCPM,"lCPM")
} else {
 gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"_",minGenes,"genes_",minLogCPM,"lCPM")
}

LM <- "basicPreg+Weight"



# gatherData(workDir = workDir, 
#          batchList = batchList,
#          focalSex = focalSex,
#          focalTreatment = focalTreatment,
#          minGenes = minGenes,
#          minLogCPM = minLogCPM,
#          singleTrt = singTrt)
# 
# genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
for (modelName in c("F","P","R")) {
  runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicPreg+Weight")
}
```





```{r treatment control}
batchList <- "allBatches"
### testing single
for (focalSex in c("F")) {
  for (focalTreatment in c("LPS","Dex","Gard")) {
    for (minGenes in c(10000)) {
      for (minLogCPM in c(5)) {
        gatherData(workDir = workDir,
                   batchList = batchList,
                   focalSex = focalSex,
                   focalTreatment = focalTreatment,
                   minGenes = minGenes,
                   minLogCPM = minLogCPM,
                   singleTrt = FALSE)
        
        gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"_",minGenes,"genes_",minLogCPM,"lCPM")
        
        for (modelName in c("F","G")) {
          genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
        }
        
        for (modelName in c("F","G")) {
          runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic")
          runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nested")
        }
      }
    }
  }
}
```


```{r single treatment only}
batchList <- "allBatches"
### testing single
for (focalSex in c("F","M")) {
  for (focalTreatment in c("LPS","Dex","Gard","Ctrl")) {
    for (minGenes in c(10000)) {
      for (minLogCPM in c(5,7)) {

        gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
        
        for (modelName in c("C","D","F","G")) {
          genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
        }
        
        for (modelName in c("F","G")) {
          runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic")
        }
      }
    }
  }
}
```


```{r loop to fully run models}
minGenes <- 10000
batchList <- "allBatches"

for (minLogCPM in c(5)) {
  for (focalSex in c("M")) {
    for (focalTreatment in c("LPS","Ctrl","Dex","Gard")) {
      modelName <- "F"
    
      #treatment only
      gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
      gatherData(workDir = workDir, batchList = batchList, focalSex = focalSex, focalTreatment = focalTreatment,
                   minGenes = minGenes, minLogCPM = minLogCPM, singleTrt = TRUE)
        
      genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
      runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic")
      runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicSeason")

      if (focalTreatment != "Ctrl") {
        #trt-ctrl
        gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"_",minGenes,"genes_",minLogCPM,"lCPM")
        gatherData(workDir = workDir, batchList = batchList, focalSex = focalSex, focalTreatment = focalTreatment,
                   minGenes = minGenes, minLogCPM = minLogCPM, singleTrt = FALSE)
        
        genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
        runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nested")
      }
    }
  }
}

minGenes <- 10000
batchList <- "allBatches"


#check the different pregnancy 35 day v 70 day
for (minLogCPM in c(5)) {
  for (focalSex in c("F")) {
    for (focalTreatment in c("Dex","Gard","LPS")) {
      
      modelName <- "G"
      if (focalTreatment %in% c("LPS","Ctrl")) {
        modelName <- "F"
      }
      
      gatherData(workDir = workDir, batchList = batchList, focalSex = focalSex, focalTreatment = focalTreatment,
                   minGenes = minGenes, minLogCPM = minLogCPM)
      #treatment only
      gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"_",minGenes,"genes_",minLogCPM,"lCPM")
      genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
      runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic")

    }
  }
}

#check the nested pregnancy model
for (minLogCPM in c(7)) {
  for (focalSex in c("F")) {
    for (focalTreatment in c("Dex","Gard","LPS","Ctrl")) {
      
      modelName <- "G"
      if (focalTreatment %in% c("LPS","Ctrl")) {
        modelName <- "F"
      }
      
      #treatment only
      gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
      
      runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nestedPreg")

    }
  }
}

#check the nested status model
for (minLogCPM in c(5,7)) {
  for (focalSex in c("F")) {
    for (focalTreatment in c("Dex","Gard","LPS","Ctrl")) {
      
      modelName <- "G"
      if (focalTreatment %in% c("LPS","Ctrl")) {
        modelName <- "F"
      }
      
      #treatment only
      gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
      
      runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nestedStatus")

    }
  }
}


```


```{r control for Preg models}
minGenes <- 10000
batchList <- "allBatches"

for (minLogCPM in c(5,7)) {
  for (focalSex in c("F")) {
    for (focalTreatment in c("LPS","Ctrl","Dex","Gard")) {
      if (focalTreatment %in% c("LPS","Ctrl")) {
        for (modelName in c("F","P")) {
          gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
          
          print(gatherSubset)
        
          #genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
          
          #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic")
          runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicPreg")
          #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nestedPreg")
          #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nestedStatus")

        }
      } else {
        for (modelName in c("G","Q")) {
          gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
          
          print(gatherSubset)
        
          #genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
          
          #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic")
          runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicPreg")
          #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nestedPreg")
          #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nestedStatus")

        }
      }
    }
  }
}
```

```{r control for Status models}
minGenes <- 10000
batchList <- "allBatches"

for (minLogCPM in c(5,7)) {
  for (focalSex in c("F")) {
    for (focalTreatment in c("LPS","Ctrl","Dex","Gard")) {
      if (focalTreatment %in% c("LPS","Ctrl")) {
        for (modelName in c("R")) {
          gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
          
          print(gatherSubset)
        
          genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
          
          #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic")
          runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicPreg")
          #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nestedPreg")
          #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nestedStatus")

        }
      } else {
        for (modelName in c("S")) {
          gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
          
          print(gatherSubset)
        
          genResids(workDir = workDir, gatherSubset = gatherSubset, model = modelName)
          
          #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic")
          runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicPreg")
          #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nestedPreg")
          #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nestedStatus")

        }
      }
    }
  }
}
```

all in one model (all treatments at once)
```{r}

for (focalSex in c("F","M")) {
  for (minLogCPM in c(5,7)) {
    print(paste0(focalSex," ",minLogCPM))
    gatherData(workDir =  workDir, batchList = "allBatches", focalSex = focalSex, focalTreatment = "Ctrl",
               minGenes = 10000, minLogCPM = minLogCPM, singleTrt = FALSE, combineTrt = TRUE)
  }
}

#tech variables controlling for Preg *or* Status

for (focalSex in c("M")) {
  for (minLogCPM in c(5,7)) {
    batchList <- "allBatches"
    focalSex <- focalSex
    minGenes <- 10000
    minLogCPM <- minLogCPM
    gatherSubset <- paste0(batchList,"_",focalSex,"_allTrt_",minGenes,"genes_",minLogCPM,"lCPM")
    print(paste0(focalSex," ",minLogCPM))
    if (focalSex == F) {
      for (modelName in c("G","Q","S")) {
        genResids(workDir =  workDir, gatherSubset = gatherSubset, model = modelName)
        }
      } else {
      for (modelName in c("G","S")) {
        genResids(workDir =  workDir, gatherSubset = gatherSubset, model = modelName)
      }
    }
  }
}


#run some emreml

#males - status only, both G and S

#females - all of  G, Q, and S
for (focalSex in c("F","M")) {
  for (minLogCPM in c(7,5)) {
    batchList <- "allBatches"
    focalSex <- focalSex
    minGenes <- 10000
    minLogCPM <- minLogCPM
    gatherSubset <- paste0(batchList,"_",focalSex,"_allTrt_",minGenes,"genes_",minLogCPM,"lCPM")
    print(paste0(focalSex," ",minLogCPM))
    if (focalSex == "F") {
      for (modelName in c("G","Q","S")) {
        runEmreml(workDir =  workDir, gatherSubset = gatherSubset, model = modelName, LM = "allTrtF")
        }
      } else {
      for (modelName in c("G","S")) {
        runEmreml(workDir =  workDir, gatherSubset = gatherSubset, model = modelName, LM = "allTrtM")
      }
    }
  }
}

```

```{r using gatherData}

batchList <- "allBatches"

for (focalSex in c("F")) {
  for (focalTreatment in c("LPS","Dex","Gard","Ctrl")) {
    for (minGenes in c(10000)) {
      for (minLogCPM in c("status")) {
        gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
        
        #gatherData(workDir = workDir, batchList = batchList, focalSex = focalSex, focalTreatment = focalTreatment,
        #           minGenes = minGenes, minLogCPM = minLogCPM, singleTrt = TRUE)
        if (focalTreatment %in% c("LPS","Ctrl")) {
          for (modelName in c("P")) {
            #genResids(workDir =  workDir, gatherSubset = gatherSubset, model = modelName)
            #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic")
            #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicPreg")
          }
        } else {
          for (modelName in c("Q")) {
            #genResids(workDir =  workDir, gatherSubset = gatherSubset, model = modelName)
            #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic")
            #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basicPreg")
          }
        }
        
        if (focalTreatment != "Ctrl") {
          gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"_",minGenes,"genes_",minLogCPM,"lCPM")
          #gatherData(workDir = workDir, batchList = batchList, focalSex = focalSex, focalTreatment = focalTreatment,
          #           minGenes = minGenes, minLogCPM = minLogCPM, singleTrt = FALSE)
          
        if (focalTreatment %in% c("LPS","Ctrl")) {
          for (modelName in c("P")) {
            #genResids(workDir =  workDir, gatherSubset = gatherSubset, model = modelName)
            #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic")
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nestedWPreg")
          }
        } else {
          for (modelName in c("Q")) {
            #genResids(workDir =  workDir, gatherSubset = gatherSubset, model = modelName)
            #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic")
            runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nestedWPreg")
          }
        }

        }
      }
    }
  }
}
```



```{r run some perms}

batchList <- "allBatches"
focalSex <- "F"
focalTreatment <- "LPS"
minGenes <- 10000
minLogCPM <- 5
modelName <- "F"
singleTrt = TRUE

gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")

modelFemreml <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPSonly_10000genes_5lCPM_modelF_basic_emmreml_status_perm007")

for (permNum in 1:10) {
  runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "basic",
            perms = TRUE, permVar = "status", permNum = permNum)
}

```


```{r count FDR}
modelFemreml <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelF_nested_emmreml")

sum(qvalue(modelFemreml$pval_treatment)$qvalues < .2)
sum(qvalue(modelFemreml$pval_treatment)$qvalues < .1)
sum(qvalue(modelFemreml$pval_treatment)$qvalues < .05)
sum(qvalue(modelFemreml$pval_treatment)$qvalues < .01)

sum(qvalue(modelFemreml$pval_TrtxStatus)$qvalues < .2)
sum(qvalue(modelFemreml$pval_TrtxStatus)$qvalues < .1)
sum(qvalue(modelFemreml$pval_TrtxStatus)$qvalues < .05)
sum(qvalue(modelFemreml$pval_TrtxStatus)$qvalues < .01)

modelDemreml <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelD_nested_emmreml")

sum(qvalue(modelDemreml$pval_treatment)$qvalues < .2)
sum(qvalue(modelDemreml$pval_treatment)$qvalues < .1)
sum(qvalue(modelDemreml$pval_treatment)$qvalues < .05)
sum(qvalue(modelDemreml$pval_treatment)$qvalues < .01)

sum(qvalue(modelDemreml$pval_TrtxStatus)$qvalues < .2)
sum(qvalue(modelDemreml$pval_TrtxStatus)$qvalues < .1)
sum(qvalue(modelDemreml$pval_TrtxStatus)$qvalues < .05)
sum(qvalue(modelDemreml$pval_TrtxStatus)$qvalues < .01)


modelBemreml <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelB_basic_emmreml")

sum(qvalue(modelBemreml$pval_treatment)$qvalues < .2)
sum(qvalue(modelBemreml$pval_treatment)$qvalues < .1)
sum(qvalue(modelBemreml$pval_treatment)$qvalues < .05)
sum(qvalue(modelBemreml$pval_treatment)$qvalues < .01)

sum(qvalue(modelBemreml$pval_status)$qvalues < .2)
sum(qvalue(modelBemreml$pval_status)$qvalues < .1)
sum(qvalue(modelBemreml$pval_status)$qvalues < .05)
sum(qvalue(modelBemreml$pval_status)$qvalues < .01)


modelFemremlmale <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_M_LPS_10000genes_4lCPM_modelF_nested_emmreml")

sum(qvalue(modelFemremlmale$pval_treatment)$qvalues < .2)
sum(qvalue(modelFemremlmale$pval_treatment)$qvalues < .1)
sum(qvalue(modelFemremlmale$pval_treatment)$qvalues < .05)
sum(qvalue(modelFemremlmale$pval_treatment)$qvalues < .01)

```

```{r plot permutation p-values}
batchList <- "allBatches"
focalSex <- "F"
focalTreatment <- "LPS"
minGenes <- 10000
minLogCPM <- 4
modelName <- "F"
gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"_",minGenes,"genes_",minLogCPM,"lCPM")

modelDir <- paste0(figDir,gatherSubset,"/model",modelName)

LM <- "nested"
permVar <- "treatment"; LMvar <- "treatment"
permVar <- "status"; LMvar <- "TrtxStatus"
#permVar <- "status"; LMvar <- "CtrlxStatus"

totalPerms <- 10
#get Emreml
emremlOut <- read.table(paste0(outDir,gatherSubset,"_model",modelName,"_",LM,"_emmreml"))

#plot standard p-value
ggplot(data = emremlOut, aes_string(x = paste0("pval_",LMvar))) +
  geom_histogram(bins = 100)

#allBatches_F_LPS_10000genes_4lCPM_modelF_nested_emmreml_treatment_perm001
permRun <- 8

permPvals <- vector()

for (permRun in 1:totalPerms) {
  #get permutations
  permEmreml <- read.table(paste0(outDir,gatherSubset,"_model",modelName,"_",LM,"_emmreml_",
                                  permVar,"_perm",formatC(permRun,width = 3, flag = "0")))
  
  permCol <- which(colnames(permEmreml) == paste0("pval_",LMvar))
  
  permPvals <- c(permPvals,permEmreml[,permCol])
}

#permutation pvals divided by number of runs should match emreml

( length(permPvals) / totalPerms ) == dim(emremlOut)[1]

emremlOut <- perm.fdr(input_df = emremlOut,
                      perm_df = permPvals,
                      Pvals_col_name = paste0("pval_",LMvar),
                      name = LMvar)



ggplot() +
  geom_histogram(aes_string(x = permPvals), bins = 100, fill = "tomato", alpha = .5) +
  xlab(paste0("permuted p-value - ",LMvar)) + 
  ggtitle(paste0(modelName," - ",LM," | ",permVar," permutations"), 
          subtitle = paste0(totalPerms," permutation runs"))
ggsave(paste0(modelDir,"/perms/",LM,"_pval_",LMvar,"_wPerms.png"), width = 6, height = 4)

fdrCol <- which(colnames(emremlOut) == paste0("fdr_",LMvar))

ggplot() +
  geom_histogram(aes(x = emremlOut[,permCol], y = ..density..), fill = "dodgerblue2", bins = 100, alpha = .5) +
  geom_density(aes(x = permPvals, y = ..density..), adjust = .25, fill = "tomato", color = "tomato", alpha = .25) +
  annotate("text", x = Inf, y = Inf, vjust = 1, hjust = 1,
           label = paste0("# Genes < FDR\n",
                          sum(emremlOut[,fdrCol] < .01)," | 0.01\n",
                          sum(emremlOut[,fdrCol] < .10)," | 0.10\n",
                          sum(emremlOut[,fdrCol] < .20)," | 0.20")) +
  xlab(paste0("p-value - ",LMvar)) + ggtitle(paste0(modelName," - ",LM),
                                             subtitle = paste0(totalPerms," permutation runs | permuted p-value density plot in red"))
ggsave(paste0(modelDir,"/",LM,"_pval_",LMvar,"_wPerms.png"), width = 6, height = 4)




```






rerun permutations with just top 25%
```{r}
batchList <- "allBatches"
focalSex <- "F"
focalTreatment <- "LPS"
minGenes <- 10000
minLogCPM <- 4
modelName <- "F"
gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"_",minGenes,"genes_",minLogCPM,"lCPM")

modelDir <- paste0(figDir,gatherSubset,"/model",modelName)

LM <- "nested"

totalPerms <- 10
#get Emreml
emremlOut <- read.table(paste0(outDir,gatherSubset,"_model",modelName,"_",LM,"_emmreml"))



rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPS_10000genes_4lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

emremlOut$GE <- 0

for (r in 1:dim(emremlOut)[1]){
  emremlOut$GE[r] <- meanGE[which(rownames(emremlOut)[r] == names(meanGE))]
}

emremlOut$GE4 <- ntile(emremlOut$GE, 4)

### only top 25%
top25binary <- emremlOut$GE4 == 4

emremlTop <- emremlOut[top25binary,]

LMvar <- "CtrlxStatus"
permPvals <- vector()

for (permRun in 1:totalPerms) {
  #get permutations
  permEmreml <- read.table(paste0(outDir,gatherSubset,"_model",modelName,"_",LM,"_emmreml_",
                                  permVar,"_perm",formatC(permRun,width = 3, flag = "0")))
  
  permCol <- which(colnames(permEmreml) == paste0("pval_",LMvar))
  
  permPvals <- c(permPvals,permEmreml[top25binary,permCol])
}

emremlTop <- perm.fdr(input_df = emremlTop,
                      perm_df = permPvals,
                      Pvals_col_name = paste0("pval_",LMvar),
                      name = LMvar)


ggplot() +
  geom_histogram(aes_string(x = permPvals), bins = 100, fill = "tomato", alpha = .5) +
  xlab(paste0("permuted p-value - ",LMvar)) + 
  ggtitle(paste0(modelName," - ",LM," | ",permVar," permutations"), 
          subtitle = paste0(totalPerms," permutation runs"," | top 25% of genes by GE"))
ggsave(paste0(modelDir,"/perms/",LM,"_pval_",LMvar,"_wPerms_top25percent.png"), width = 6, height = 4)

fdrCol <- which(colnames(emremlTop) == paste0("fdr_",LMvar))

ggplot() +
  geom_histogram(aes(x = emremlTop[,permCol], y = ..density..), fill = "dodgerblue2", bins = 100, alpha = .5) +
  geom_density(aes(x = permPvals, y = ..density..), adjust = .25, fill = "tomato", color = "tomato", alpha = .25) +
  annotate("text", x = Inf, y = Inf, vjust = 1, hjust = 1,
           label = paste0("# Genes < FDR\n",
                          sum(emremlTop[,fdrCol] < .01)," | 0.01\n",
                          sum(emremlTop[,fdrCol] < .10)," | 0.10\n",
                          sum(emremlTop[,fdrCol] < .20)," | 0.20")) +
  xlab(paste0("p-value - ",LMvar)) + ggtitle(paste0(modelName," - ",LM," | top 25% of genes by GE"),
                                             subtitle = paste0(totalPerms," permutation runs | permuted p-value density plot in red"))
ggsave(paste0(modelDir,"/",LM,"_pval_",LMvar,"_wPerms_top25percent.png"), width = 6, height = 4)



```





```{r are significant genes high expression}
rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_5lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

emremlOut$GE <- 0

for (r in 1:dim(emremlOut)[1]){
  emremlOut$GE[r] <- meanGE[which(rownames(emremlOut)[r] == names(meanGE))]
}


emremlOut$GE4 <- ntile(emremlOut$GE, 4)
emremlOut$GE10 <- ntile(emremlOut$GE, 10)

ggplot() +
  geom_histogram(aes(head(emremlOut, n = 27)$GE4))
```


does mash "uncover" more signal?
for the main variables of interest:
treatment
status
pregnancy (interested in why pregnancy is different in trt v control)
DomxPreg
SubxPreg

```{r}
#which model(s)
batchList <- "allBatches"
focalSex <- "F"
minGenes <- 10000
minLogCPM <- 5

#which variable
compVariable <- "treatment"

for (compVariable in c("treatment","status","preg","DomxPreg","SubxPreg")) {
  
  if (compVariable == "treatment") {
    allConditions <- c("LPS","Dex","Gard")
    gatherText <- "_"
  } else {
    allConditions <- c("Ctrl","LPS","Dex","Gard")
    gatherText <- "only_"
  }
  
  if (compVariable %in% c("treatment","status")) {
    LM <- "basic"
  } else if (compVariable %in% c("preg")) {
    LM <- "basicPreg"
  } else if (compVariable %in% c("DomxPreg","SubxPreg")) {
    LM <- "nestedPreg"
  }
  
  mashResults <- readRDS(file = paste0(outDir,"mashR_output_method2_",compVariable))
  mashGenes <- rownames(mashResults[[1]]$PosteriorMean)
    
  mashLFSR <- mashResults[[1]]$lfsr
  mashBetas <- mashResults[[1]]$PosteriorMean
  
  mremlQVal <- mashLFSR
  mremlQVal[1:dim(mashLFSR)[1],1:length(allConditions)] <- 0
  
  mremlBetas <- mashBetas
  mremlBetas[1:dim(mashBetas)[1],1:length(allConditions)] <- 0
  
  for (focalTreatment in allConditions) {
    gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,gatherText,minGenes,"genes_",minLogCPM,"lCPM")
    
    if (focalTreatment %in% c("Ctrl","LPS")){
      modelName <- "F"
    } else {
      modelName <- "G"
    }
    
    mremlResults <- read.table(paste0(outDir,gatherSubset,"_model",modelName,"_",LM,"_emmreml"))
    
    #limit to mash genes
    mremlResults <- mremlResults[rownames(mremlResults) %in% mashGenes,]
    
    #qvalue for FDR
    mremlQResults <- qvalue(mremlResults[,which(colnames(mremlResults) == paste0("pval_",compVariable))])
    mremlQVal[,which(allConditions == focalTreatment)] <- mremlQResults$qvalues
    
    #gather betas while we're here
    mremlBetas[,which(allConditions == focalTreatment)] <- mremlResults[,which(colnames(mremlResults) == paste0("beta_",compVariable))]
    
    assign(x = paste0("mremlResults_",focalTreatment), value = mremlResults)
  
  }
  
  #dataframe, look through env challenge info for dataframe and code
  
  fdrLimits <- c(.01,.05,.1,.2)
  
  #plot to check
  #loop through all treatments
  
  for (t in 1:length(allConditions)){
    lmTreat <- allConditions[t]
    ggplot() +
      geom_point(aes(y = mashLFSR[,t], x = mremlQVal[,t]), alpha = .5) +
      xlab("emmreml qvalues") + ylab("mash lfsr") +
      ggtitle(paste0(lmTreat," mash v. emmreml fdr")) +
      xlim(c(0,1)) + ylim(c(0,1))
    
    ggsave(paste0(figDir,"mash/",compVariable,"_",lmTreat,"__mashVemmreml_pvals.png"),
           height = 4, width = 6)
    
    plotR <- cor.test(mashBetas[,t], x = mremlBetas[,t])
    ggplot() +
      geom_abline(slope = 1, intercept = 0, alpha = 1/3) +
      geom_point(aes(y = mashBetas[,t], x = mremlBetas[,t]), alpha = .25) +
      geom_smooth(aes(y = mashBetas[,t], x = mremlBetas[,t]),
                  method = "lm", formula = "y~x", alpha = .25) +
      xlab("emmreml betas") + ylab("mash betas") +
      ggtitle(paste0(lmTreat," mash v. emmreml betas"),
              subtitle = paste0("R = ",signif(plotR$estimate, digits = 3)))
    
    ggsave(paste0(figDir,"mash/",compVariable,"_",lmTreat,"__mashVemmreml_betas.png"),
           height = 4, width = 6)
  }
  
  ### loop through the lfsr/fdr cutoffs and plot the raw numbers:
  fdrHits <- data.frame(matrix(ncol = 2*length(fdrLimits), nrow = length(allConditions)))
  colnames(fdrHits) <- c(paste0("emmreml\n",fdrLimits),paste0("mash\n",fdrLimits))
  rownames(fdrHits) <- allConditions
  
  
  for (fThresh in fdrLimits) {
    count <- which(fdrLimits == fThresh)
    fdrHits[,(count + length(fdrLimits))] <- colSums(mashLFSR < fThresh)
    fdrHits[,count] <- colSums(mremlQVal < fThresh)
  }
  
  fdrHits <- cbind.data.frame(rownames(fdrHits),fdrHits)
  colnames(fdrHits)[1] <- "Trt"
  
  full_val_range <- fdrHits %>% 
      ungroup %>%
      select_if(is.numeric) %>% 
      range
  
  fdrHits %>% gt() %>%
    tab_header(
      title = md(paste0(compVariable," Significant Genes")),
      subtitle = "emreml & mash, by FDR"
    ) %>%
    data_color(
      columns = colnames(fdrHits)[-1],
      colors = scales::col_numeric(
        palette = paletteer::paletteer_d(
          palette = "ggsci::red_material"
        ) %>% as.character(),
        domain = full_val_range
      ),
      alpha = 0.8
    ) %>%
    gtsave(paste0(figDir,"mash/",compVariable,"_FDRsigGenes.png"))
}
```


count significant genes
```{r}
for (threshold in c(0.01,0.05,0.1,0.2)) {
  mrmlResultsallCond <- data.frame(condition$shortName)
  
  mrmlResultsallCond$agRecGroupCent <- 0
  #mrmlResultsallCond$agRecMeanCent <- 0
  mrmlResultsallCond$groomGroupCent <- 0
  #mrmlResultsallCond$groomMeanCent <- 0
  mrmlResultsallCond$eloGroupCent <- 0
  #mrmlResultsallCond$eloMeanCent <- 0
  
  #behav <- "elo"
  #centering <- "GroupCent"
  for (behav in c("groom","elo","agRec")) {
    
    
    colNum <- which(colnames(mrmlResultsallCond) == paste0(behav,"GroupCent"))
    
    #c <- 1
    for (c in 1:dim(mrmlResultsallCond)[1]) {
      #mrml_Condition_groomGroupCent_Calbicans
      
      #read in FDR output
      m <- read.table((paste0(workDir,"fdrOutput/mrml_Condition_",behav,"GroupCent_",mrmlResultsallCond$condition.shortName[c],"_wFDR")))
      mrmlResultsallCond[c, colNum] <- sum(m[,16] < threshold)
       
      
      #m <- read.table((paste0(workDir,"fdrOutput/mrml_Condition_",behav,"MeanCent_",mrmlResultsallCond$condition.shortName[c],"_wFDR")))
      #mrmlResultsallCond[c, (colNum + 1)] <- sum(m[,16] < threshold)
    }
  }
  
  ### get the color range for ALL CELLS, called full_val_range, then use that instead of "domain = NULL" 
  full_val_range <- mrmlResultsallCond %>% 
    ungroup %>%
    select_if(is.numeric) %>% 
    range
  
  
  mrmlResultsallCond %>% gt() %>%
    tab_header(
      title = md(paste0("emreml Significant Genes at ",threshold," FDR")),
      subtitle = "condition-by-condition analysis"
    ) %>%
    data_color(
      columns = colnames(mrmlResultsallCond)[-1],
      colors = scales::col_numeric(
        palette = paletteer::paletteer_d(
          palette = "ggsci::red_material"
        ) %>% as.character(),
        domain = full_val_range
      ),
      alpha = 0.8
    ) %>%
    gtsave(paste0(figDir,"allConditions_sigGeneCount_mremlFDR_dropClin_t",threshold,".png"))
}

```



are the A and B models similar to the models
```{r compare betas across models}

#write a function to compare two sets of betas
#inputs - for X and Y 
#           emreml dataframe
#           column title (not "beta" just "treatment")
#           genes by meanGE (just one)
#
#           output folder

emremlX <- "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelF_nested_emmreml"
colnameX <- "treatment"
Xtitle <- "Batch2021"

emremlY <- "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2020_F_LPS_10000genes_4lCPM_modelF_nested_emmreml"
colnameY <- "treatment"
Ytitle <- "Batch2020"

figBetaDir <- paste0(figDir,"betaComp")
dir.create(figBetaDir)


rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPS_10000genes_4lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)
topNpercent <- 25



rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPS_10000genes_4lCPM_counts.RDS")
emreml2020batch <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2020_F_LPS_10000genes_4lCPM_modelF_nested_emmreml")
emreml2021batch <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelF_nested_emmreml")


compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2020_F_LPS_10000genes_4lCPM_modelF_nested_emmreml", 
            colnameX = "treatment", Xtitle = "Batch2021",
            emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelF_nested_emmreml",
            colnameY = "treatment", Ytitle = "Batch2020",
            figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent <- 25)

for (emrmlVar in c("treatment",
                   "CtrlxStatus",
                   "TrtxStatus")) {
  compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_M_LPS_10000genes_4lCPM_modelF_nested_emmreml", 
              colnameX = emrmlVar, Xtitle = "allBatchesM",
              emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPS_10000genes_4lCPM_modelF_nested_emmreml",
              colnameY = emrmlVar, Ytitle = "allBatchesF",
              figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent <- 25)
}

```

```{r qqplots for treatment}
figqqDir <- paste0(figDir,"qqPlots")
dir.create(figqqDir)

emremlallbatch <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPS_10000genes_4lCPM_modelF_nested_emmreml")
rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPS_10000genes_4lCPM_counts.RDS")
tempMeta <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPS_10000genes_4lCPM_metadata.RDS")

for (geTrt in c("Ctrl","LPS")) {
  
  meanGE <- rowMeans(rnaCounts[,tempMeta$Trt == geTrt])
  
  emremlallbatch$GE <- 0
  
  for (r in 1:dim(emremlallbatch)[1]){
    emremlallbatch$GE[r] <- meanGE[which(rownames(emremlallbatch)[r] == names(meanGE))]
  }
  
  emremlallbatch$GE2 <- ntile(emremlallbatch$GE, 2)
  emremlallbatch$GE4 <- ntile(emremlallbatch$GE, 4)
  emremlallbatch$GE10 <- ntile(emremlallbatch$GE, 10)
  
  #generate a dataframe, with columns: gene name, GEdivision, GEtile, qqActual, qqExpected
  geneNames <- vector()
  GEdivision <- vector()
  GEtile <- vector()
  qqActual <- vector()
  qqExpected <- vector()
  
  emremlallbatchTrtSort <- emremlallbatch[order(emremlallbatch$pval_treatment),]
  #no quantile
  geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
  GEdivision <- c(GEdivision,rep("1",dim(emremlallbatchTrtSort)[1]))
  GEtile <- c(GEtile,rep(1,dim(emremlallbatchTrtSort)[1]))
  qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_treatment))
  qqExpected <- c(qqExpected,-log10(1:length(emremlallbatch$pval_treatment) / length(emremlallbatch$pval_treatment)))
  
  
  #Q2
  for (quantNum in 1:max(emremlallbatch$GE2)) {
    
    emremlallbatchQuant <- subset(emremlallbatch, GE2 == quantNum)
    
    emremlallbatchTrtSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_treatment),]
    
    geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
    GEdivision <- c(GEdivision,rep("2",dim(emremlallbatchTrtSort)[1]))
    GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchTrtSort)[1]))
    qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_treatment))
    qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchTrtSort$pval_treatment) / length(emremlallbatchTrtSort$pval_treatment)))
  }
  
  #Q4
  
  for (quantNum in 1:max(emremlallbatch$GE4)) {
    
    emremlallbatchQuant <- subset(emremlallbatch, GE4 == quantNum)
    
    emremlallbatchTrtSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_treatment),]
    
    geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
    GEdivision <- c(GEdivision,rep("4",dim(emremlallbatchTrtSort)[1]))
    GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchTrtSort)[1]))
    qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_treatment))
    qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchTrtSort$pval_treatment) / length(emremlallbatchTrtSort$pval_treatment)))
  }
  
  #Q10
  
  for (quantNum in 1:max(emremlallbatch$GE10)) {
    
    emremlallbatchQuant <- subset(emremlallbatch, GE10 == quantNum)
    
    emremlallbatchTrtSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_treatment),]
    
    geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
    GEdivision <- c(GEdivision,rep("10",dim(emremlallbatchTrtSort)[1]))
    GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchTrtSort)[1]))
    qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_treatment))
    qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchTrtSort$pval_treatment) / length(emremlallbatchTrtSort$pval_treatment)))
  }
  
  qqTreatment <- cbind.data.frame(geneNames,GEdivision,GEtile,qqActual,qqExpected)
  
  qqTreatment$GEdivTile <- paste0(qqTreatment$GEdivision,"_",qqTreatment$GEtile)
  
  qqTreatment$GEdivTile <- factor(qqTreatment$GEdivTile, 
                                  levels = c("1_1","2_1","2_2","4_1","4_2","4_3","4_4",
                                             "10_1","10_2","10_3","10_4","10_5","10_6","10_7","10_8","10_9","10_10"))
  
  ggplot(data = subset(qqTreatment, GEdivision == "1"), aes(x = qqExpected,
                                 y = qqActual,
                                 col = GEdivTile)) +
    geom_abline(slope = 1, intercept = 0) +
    geom_point() +
    labs(col = "GE_nTile") +
    ggtitle("Treatment p-value qqPlot",
            subtitle = paste0("Female, LPS, All Batches, min logCPM > 4, nGenes=",
                              dim(subset(qqTreatment, GEdivision == "1"))[1])) +
    ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")
  
  ggsave(filename = paste0(figqqDir,"/Female_LPS_allBatches__TreatmentPval_GE1tile_ge",geTrt,".png"),
         width = 6, height = 4)
  
  ggplot(data = subset(qqTreatment, GEdivision == "2"), aes(x = qqExpected,
                                 y = qqActual,
                                 col = GEdivTile)) +
    geom_abline(slope = 1, intercept = 0) +
    geom_point() +
    labs(col = "GE_nTile") +
    ggtitle("Treatment p-value qqPlot",
            subtitle = paste0("Female, LPS, All Batches, min logCPM > 4, nGenes=",
                              dim(subset(qqTreatment, GEdivision == "1"))[1])) +
    ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")
  
  ggsave(filename = paste0(figqqDir,"/Female_LPS_allBatches__TreatmentPval_GE2tile_ge",geTrt,".png"),
         width = 6, height = 4)
  
  ggplot(data = subset(qqTreatment, GEdivision == "4"), aes(x = qqExpected,
                                 y = qqActual,
                                 col = GEdivTile)) +
    geom_abline(slope = 1, intercept = 0) +
    geom_point() +
    labs(col = "GE_nTile") +
    ggtitle("Treatment p-value qqPlot",
            subtitle = paste0("Female, LPS, All Batches, min logCPM > 4, nGenes=",
                              dim(subset(qqTreatment, GEdivision == "1"))[1])) +
    ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")
  
  ggsave(filename = paste0(figqqDir,"/Female_LPS_allBatches__TreatmentPval_GE4tile_ge",geTrt,".png"),
         width = 6, height = 4)
  
  ggplot(data = subset(qqTreatment, GEdivision == "10"), aes(x = qqExpected,
                                 y = qqActual,
                                 col = GEdivTile)) +
    geom_abline(slope = 1, intercept = 0) +
    geom_point() +
    labs(col = "GE_nTile") +
    ggtitle("Treatment p-value qqPlot",
            subtitle = paste0("Female, LPS, All Batches, min logCPM > 4, nGenes=",
                              dim(subset(qqTreatment, GEdivision == "1"))[1])) +
    ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")
  
  ggsave(filename = paste0(figqqDir,"/Female_LPS_allBatches__TreatmentPval_GE10tile_ge",geTrt,".png"),
         width = 6, height = 4)
}
```

```{r qqplots for status within treated samples FEMALE}
emremlallbatch <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPS_10000genes_4lCPM_modelF_nested_emmreml")
rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPS_10000genes_4lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

emremlallbatch$GE <- 0

for (r in 1:dim(emremlallbatch)[1]){
  emremlallbatch$GE[r] <- meanGE[which(rownames(emremlallbatch)[r] == names(meanGE))]
}

emremlallbatch$GE2 <- ntile(emremlallbatch$GE, 2)
emremlallbatch$GE4 <- ntile(emremlallbatch$GE, 4)
emremlallbatch$GE6 <- ntile(emremlallbatch$GE, 6)
emremlallbatch$GE10 <- ntile(emremlallbatch$GE, 10)

#generate a dataframe, with columns: gene name, GEdivision, GEtile, qqActual, qqExpected
geneNames <- vector()
GEdivision <- vector()
GEtile <- vector()
qqActual <- vector()
qqExpected <- vector()

emremlallbatchTrtSort <- emremlallbatch[order(emremlallbatch$pval_TrtxStatus),]
#no quantile
geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
GEdivision <- c(GEdivision,rep("1",dim(emremlallbatchTrtSort)[1]))
GEtile <- c(GEtile,rep(1,dim(emremlallbatchTrtSort)[1]))
qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_TrtxStatus))
qqExpected <- c(qqExpected,-log10(1:length(emremlallbatch$pval_TrtxStatus) / length(emremlallbatch$pval_TrtxStatus)))


#Q2
for (quantNum in 1:max(emremlallbatch$GE2)) {
  
  emremlallbatchQuant <- subset(emremlallbatch, GE2 == quantNum)
  
  emremlallbatchTrtSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_TrtxStatus),]
  
  geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
  GEdivision <- c(GEdivision,rep("2",dim(emremlallbatchTrtSort)[1]))
  GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchTrtSort)[1]))
  qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_TrtxStatus))
  qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchTrtSort$pval_TrtxStatus) / length(emremlallbatchTrtSort$pval_TrtxStatus)))
}

#Q4

for (quantNum in 1:max(emremlallbatch$GE4)) {
  
  emremlallbatchQuant <- subset(emremlallbatch, GE4 == quantNum)
  
  emremlallbatchTrtSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_TrtxStatus),]
  
  geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
  GEdivision <- c(GEdivision,rep("4",dim(emremlallbatchTrtSort)[1]))
  GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchTrtSort)[1]))
  qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_TrtxStatus))
  qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchTrtSort$pval_TrtxStatus) / length(emremlallbatchTrtSort$pval_TrtxStatus)))
}

#Q10

for (quantNum in 1:max(emremlallbatch$GE10)) {
  
  emremlallbatchQuant <- subset(emremlallbatch, GE10 == quantNum)
  
  emremlallbatchTrtSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_TrtxStatus),]
  
  geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
  GEdivision <- c(GEdivision,rep("10",dim(emremlallbatchTrtSort)[1]))
  GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchTrtSort)[1]))
  qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_TrtxStatus))
  qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchTrtSort$pval_TrtxStatus) / length(emremlallbatchTrtSort$pval_TrtxStatus)))
}

qqTreatment <- cbind.data.frame(geneNames,GEdivision,GEtile,qqActual,qqExpected)

qqTreatment$GEdivTile <- paste0(qqTreatment$GEdivision,"_",qqTreatment$GEtile)

qqTreatment$GEdivTile <- factor(qqTreatment$GEdivTile, 
                                levels = c("1_1","2_1","2_2","4_1","4_2","4_3","4_4",
                                           "10_1","10_2","10_3","10_4","10_5","10_6","10_7","10_8","10_9","10_10"))

ggplot(data = subset(qqTreatment, GEdivision == "1"), aes(x = qqExpected,
                               y = qqActual,
                               col = GEdivTile)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  labs(col = "GE_nTile") +
  ggtitle("Status:LPS+ p-value qqPlot",
          subtitle = paste0("Female, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1])) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")

ggsave(filename = paste0(figqqDir,"/Female_LPS_allBatches__StatusTrtPval_GE1tile.png"),
       width = 6, height = 4)

ggplot(data = subset(qqTreatment, GEdivision == "2"), aes(x = qqExpected,
                               y = qqActual,
                               col = GEdivTile)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  labs(col = "GE_nTile") +
  ggtitle("Status:LPS+ p-value qqPlot",
          subtitle = paste0("Female, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1])) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")

ggsave(filename = paste0(figqqDir,"/Female_LPS_allBatches__StatusTrtPval_GE2tile.png"),
       width = 6, height = 4)

ggplot(data = subset(qqTreatment, GEdivision == "4"), aes(x = qqExpected,
                               y = qqActual,
                               col = GEdivTile)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  labs(col = "GE_nTile") +
  ggtitle("Status:LPS+ p-value qqPlot",
          subtitle = paste0("Female, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1])) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")

ggsave(filename = paste0(figqqDir,"/Female_LPS_allBatches__StatusTrtPval_GE4tile.png"),
       width = 6, height = 4)

ggplot(data = subset(qqTreatment, GEdivision == "10"), aes(x = qqExpected,
                               y = qqActual,
                               col = GEdivTile)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  labs(col = "GE_nTile") +
  ggtitle("Status:LPS+ p-value qqPlot",
          subtitle = paste0("Female, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1])) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")

ggsave(filename = paste0(figqqDir,"/Female_LPS_allBatches__StatusTrtPval_GE10tile.png"),
       width = 6, height = 4)

#add histograms
qqHist <- subset(qqTreatment, GEdivision == "4")

qqHist$pvalActual <- 10^-qqHist$qqActual

qqHist$GEdivTile <- factor(qqHist$GEdivTile, levels = c("4_4","4_3","4_2","4_1"))

ggplot(data = qqHist, aes(x = pvalActual, fill = GEdivTile)) +
  geom_histogram(position = "identity", bins = 100, alpha = 2/3) + ylim(c(0,60)) +
  ggtitle("Status:LPS+ p-values",
          subtitle = paste0("Female, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1]))

ggsave(filename = paste0(figqqDir,"/Female_LPS_allBatches__StatusTrtPval_Hist.png"),
       width = 6, height = 4)

plot1 <- ggplot(data = subset(qqHist, GEdivTile == "4_1"), aes(x = pvalActual)) +
  geom_histogram(position = "identity", bins = 100, alpha = .9) + ylim(c(0,60)) +
  ggtitle("Status:LPS+ p-values | 0-25% GE")

plot2 <- ggplot(data = subset(qqHist, GEdivTile == "4_2"), aes(x = pvalActual)) +
  geom_histogram(position = "identity", bins = 100, alpha = .9) + ylim(c(0,60)) +
  ggtitle("Status:LPS+ p-values | 25-50% GE")

plot3 <- ggplot(data = subset(qqHist, GEdivTile == "4_3"), aes(x = pvalActual)) +
  geom_histogram(position = "identity", bins = 100, alpha = .9) + ylim(c(0,60)) +
  ggtitle("Status:LPS+ p-values | 50-75% GE")

plot4 <- ggplot(data = subset(qqHist, GEdivTile == "4_4"), aes(x = pvalActual)) +
  geom_histogram(position = "identity", bins = 100, alpha = .9) + ylim(c(0,60)) +
  ggtitle("Status:LPS+ p-values | 75-100% GE")

plot_grid(plot1,plot2,plot3,plot4)

ggsave(filename = paste0(figqqDir,"/Female_LPS_allBatches__StatusTrtPval_HistTile.png"),
       width = 6, height = 4)

```

```{r qqplots for status within treated samples MALE}
emremlallbatch <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_M_LPS_10000genes_4lCPM_modelF_nested_emmreml")
rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_M_LPS_10000genes_4lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

emremlallbatch$GE <- 0

for (r in 1:dim(emremlallbatch)[1]){
  emremlallbatch$GE[r] <- meanGE[which(rownames(emremlallbatch)[r] == names(meanGE))]
}

emremlallbatch$GE2 <- ntile(emremlallbatch$GE, 2)
emremlallbatch$GE4 <- ntile(emremlallbatch$GE, 4)
emremlallbatch$GE6 <- ntile(emremlallbatch$GE, 6)
emremlallbatch$GE10 <- ntile(emremlallbatch$GE, 10)

#generate a dataframe, with columns: gene name, GEdivision, GEtile, qqActual, qqExpected
geneNames <- vector()
GEdivision <- vector()
GEtile <- vector()
qqActual <- vector()
qqExpected <- vector()

emremlallbatchTrtSort <- emremlallbatch[order(emremlallbatch$pval_TrtxStatus),]
#no quantile
geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
GEdivision <- c(GEdivision,rep("1",dim(emremlallbatchTrtSort)[1]))
GEtile <- c(GEtile,rep(1,dim(emremlallbatchTrtSort)[1]))
qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_TrtxStatus))
qqExpected <- c(qqExpected,-log10(1:length(emremlallbatch$pval_TrtxStatus) / length(emremlallbatch$pval_TrtxStatus)))


#Q2
for (quantNum in 1:max(emremlallbatch$GE2)) {
  
  emremlallbatchQuant <- subset(emremlallbatch, GE2 == quantNum)
  
  emremlallbatchTrtSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_TrtxStatus),]
  
  geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
  GEdivision <- c(GEdivision,rep("2",dim(emremlallbatchTrtSort)[1]))
  GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchTrtSort)[1]))
  qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_TrtxStatus))
  qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchTrtSort$pval_TrtxStatus) / length(emremlallbatchTrtSort$pval_TrtxStatus)))
}

#Q4

for (quantNum in 1:max(emremlallbatch$GE4)) {
  
  emremlallbatchQuant <- subset(emremlallbatch, GE4 == quantNum)
  
  emremlallbatchTrtSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_TrtxStatus),]
  
  geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
  GEdivision <- c(GEdivision,rep("4",dim(emremlallbatchTrtSort)[1]))
  GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchTrtSort)[1]))
  qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_TrtxStatus))
  qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchTrtSort$pval_TrtxStatus) / length(emremlallbatchTrtSort$pval_TrtxStatus)))
}

#Q10

for (quantNum in 1:max(emremlallbatch$GE10)) {
  
  emremlallbatchQuant <- subset(emremlallbatch, GE10 == quantNum)
  
  emremlallbatchTrtSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_TrtxStatus),]
  
  geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
  GEdivision <- c(GEdivision,rep("10",dim(emremlallbatchTrtSort)[1]))
  GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchTrtSort)[1]))
  qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_TrtxStatus))
  qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchTrtSort$pval_TrtxStatus) / length(emremlallbatchTrtSort$pval_TrtxStatus)))
}

qqTreatment <- cbind.data.frame(geneNames,GEdivision,GEtile,qqActual,qqExpected)

qqTreatment$GEdivTile <- paste0(qqTreatment$GEdivision,"_",qqTreatment$GEtile)

qqTreatment$GEdivTile <- factor(qqTreatment$GEdivTile, 
                                levels = c("1_1","2_1","2_2","4_1","4_2","4_3","4_4",
                                           "10_1","10_2","10_3","10_4","10_5","10_6","10_7","10_8","10_9","10_10"))


ggplot(data = subset(qqTreatment, GEdivision == "1"), aes(x = qqExpected,
                               y = qqActual,
                               col = GEdivTile)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  labs(col = "GE_nTile") +
  ggtitle("Status:LPS+ p-value qqPlot",
          subtitle = paste0("Male, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1])) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")

ggsave(filename = paste0(figqqDir,"/Male_LPS_allBatches__StatusTrtPval_GE1tile.png"),
       width = 6, height = 4)

ggplot(data = subset(qqTreatment, GEdivision == "2"), aes(x = qqExpected,
                               y = qqActual,
                               col = GEdivTile)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  labs(col = "GE_nTile") +
  ggtitle("Status:LPS+ p-value qqPlot",
          subtitle = paste0("Male, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1])) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")

ggsave(filename = paste0(figqqDir,"/Male_LPS_allBatches__StatusTrtPval_GE2tile.png"),
       width = 6, height = 4)

ggplot(data = subset(qqTreatment, GEdivision == "4"), aes(x = qqExpected,
                               y = qqActual,
                               col = GEdivTile)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  labs(col = "GE_nTile") +
  ggtitle("Status:LPS+ p-value qqPlot",
          subtitle = paste0("Male, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1])) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")

ggsave(filename = paste0(figqqDir,"/Male_LPS_allBatches__StatusTrtPval_GE4tile.png"),
       width = 6, height = 4)

ggplot(data = subset(qqTreatment, GEdivision == "10"), aes(x = qqExpected,
                               y = qqActual,
                               col = GEdivTile)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  labs(col = "GE_nTile") +
  ggtitle("Status:LPS+ p-value qqPlot",
          subtitle = paste0("Male, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1])) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")

ggsave(filename = paste0(figqqDir,"/Male_LPS_allBatches__StatusTrtPval_GE10tile.png"),
       width = 6, height = 4)

```



```{r qqplots for status within control samples FEMALE}
emremlallbatch <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPS_10000genes_4lCPM_modelF_nested_emmreml")
rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPS_10000genes_4lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

emremlallbatch$GE <- 0

for (r in 1:dim(emremlallbatch)[1]){
  emremlallbatch$GE[r] <- meanGE[which(rownames(emremlallbatch)[r] == names(meanGE))]
}

emremlallbatch$GE2 <- ntile(emremlallbatch$GE, 2)
emremlallbatch$GE4 <- ntile(emremlallbatch$GE, 4)
emremlallbatch$GE6 <- ntile(emremlallbatch$GE, 6)
emremlallbatch$GE10 <- ntile(emremlallbatch$GE, 10)

#generate a dataframe, with columns: gene name, GEdivision, GEtile, qqActual, qqExpected
geneNames <- vector()
GEdivision <- vector()
GEtile <- vector()
qqActual <- vector()
qqExpected <- vector()

emremlallbatchTrtSort <- emremlallbatch[order(emremlallbatch$pval_CtrlxStatus),]
#no quantile
geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
GEdivision <- c(GEdivision,rep("1",dim(emremlallbatchTrtSort)[1]))
GEtile <- c(GEtile,rep(1,dim(emremlallbatchTrtSort)[1]))
qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_CtrlxStatus))
qqExpected <- c(qqExpected,-log10(1:length(emremlallbatch$pval_CtrlxStatus) / length(emremlallbatch$pval_CtrlxStatus)))


#Q2
for (quantNum in 1:max(emremlallbatch$GE2)) {
  
  emremlallbatchQuant <- subset(emremlallbatch, GE2 == quantNum)
  
  emremlallbatchTrtSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_CtrlxStatus),]
  
  geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
  GEdivision <- c(GEdivision,rep("2",dim(emremlallbatchTrtSort)[1]))
  GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchTrtSort)[1]))
  qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_CtrlxStatus))
  qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchTrtSort$pval_CtrlxStatus) / length(emremlallbatchTrtSort$pval_CtrlxStatus)))
}

#Q4

for (quantNum in 1:max(emremlallbatch$GE4)) {
  
  emremlallbatchQuant <- subset(emremlallbatch, GE4 == quantNum)
  
  emremlallbatchTrtSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_CtrlxStatus),]
  
  geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
  GEdivision <- c(GEdivision,rep("4",dim(emremlallbatchTrtSort)[1]))
  GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchTrtSort)[1]))
  qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_CtrlxStatus))
  qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchTrtSort$pval_CtrlxStatus) / length(emremlallbatchTrtSort$pval_CtrlxStatus)))
}

#Q10

for (quantNum in 1:max(emremlallbatch$GE10)) {
  
  emremlallbatchQuant <- subset(emremlallbatch, GE10 == quantNum)
  
  emremlallbatchTrtSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_CtrlxStatus),]
  
  geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
  GEdivision <- c(GEdivision,rep("10",dim(emremlallbatchTrtSort)[1]))
  GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchTrtSort)[1]))
  qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_CtrlxStatus))
  qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchTrtSort$pval_CtrlxStatus) / length(emremlallbatchTrtSort$pval_CtrlxStatus)))
}

qqTreatment <- cbind.data.frame(geneNames,GEdivision,GEtile,qqActual,qqExpected)

qqTreatment$GEdivTile <- paste0(qqTreatment$GEdivision,"_",qqTreatment$GEtile)

qqTreatment$GEdivTile <- factor(qqTreatment$GEdivTile, 
                                levels = c("1_1","2_1","2_2","4_1","4_2","4_3","4_4",
                                           "10_1","10_2","10_3","10_4","10_5","10_6","10_7","10_8","10_9","10_10"))


ggplot(data = subset(qqTreatment, GEdivision == "1"), aes(x = qqExpected,
                               y = qqActual,
                               col = GEdivTile)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  labs(col = "GE_nTile") +
  ggtitle("Status:NegCtrl p-value qqPlot",
          subtitle = paste0("Female, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1])) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")

ggsave(filename = paste0(figqqDir,"/Female_LPS_allBatches__StatusNegCtrlPval_GE1tile.png"),
       width = 6, height = 4)

ggplot(data = subset(qqTreatment, GEdivision == "2"), aes(x = qqExpected,
                               y = qqActual,
                               col = GEdivTile)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  labs(col = "GE_nTile") +
  ggtitle("Status:NegCtrl p-value qqPlot",
          subtitle = paste0("Female, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1])) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")

ggsave(filename = paste0(figqqDir,"/Female_LPS_allBatches__StatusNegCtrlPval_GE2tile.png"),
       width = 6, height = 4)

ggplot(data = subset(qqTreatment, GEdivision == "4"), aes(x = qqExpected,
                               y = qqActual,
                               col = GEdivTile)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  labs(col = "GE_nTile") +
  ggtitle("Status:NegCtrl p-value qqPlot",
          subtitle = paste0("Female, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1])) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")

ggsave(filename = paste0(figqqDir,"/Female_LPS_allBatches__StatusNegCtrlPval_GE4tile.png"),
       width = 6, height = 4)

ggplot(data = subset(qqTreatment, GEdivision == "10"), aes(x = qqExpected,
                               y = qqActual,
                               col = GEdivTile)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  labs(col = "GE_nTile") +
  ggtitle("Status:NegCtrl p-value qqPlot",
          subtitle = paste0("Female, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1])) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")

ggsave(filename = paste0(figqqDir,"/Female_LPS_allBatches__StatusNegCtrlPval_GE10tile.png"),
       width = 6, height = 4)

#add histograms
qqHist <- subset(qqTreatment, GEdivision == "4")

qqHist$pvalActual <- 10^-qqHist$qqActual

qqHist$GEdivTile <- factor(qqHist$GEdivTile, levels = c("4_4","4_3","4_2","4_1"))

ggplot(data = qqHist, aes(x = pvalActual, fill = GEdivTile)) +
  geom_histogram(position = "identity", bins = 100, alpha = 2/3) + ylim(c(0,60)) +
  ggtitle("Status:NegCtrl p-values",
          subtitle = paste0("Female, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1]))

ggsave(filename = paste0(figqqDir,"/Female_LPS_allBatches__StatusNegCtrlPval_Hist.png"),
       width = 6, height = 4)

plot1 <- ggplot(data = subset(qqHist, GEdivTile == "4_1"), aes(x = pvalActual)) +
  geom_histogram(position = "identity", bins = 100, alpha = .9) + ylim(c(0,60)) +
  ggtitle("Status:NegCtrl p-values | 0-25% GE")

plot2 <- ggplot(data = subset(qqHist, GEdivTile == "4_2"), aes(x = pvalActual)) +
  geom_histogram(position = "identity", bins = 100, alpha = .9) + ylim(c(0,60)) +
  ggtitle("Status:NegCtrl p-values | 25-50% GE")

plot3 <- ggplot(data = subset(qqHist, GEdivTile == "4_3"), aes(x = pvalActual)) +
  geom_histogram(position = "identity", bins = 100, alpha = .9) + ylim(c(0,60)) +
  ggtitle("Status:NegCtrl p-values | 50-75% GE")

plot4 <- ggplot(data = subset(qqHist, GEdivTile == "4_4"), aes(x = pvalActual)) +
  geom_histogram(position = "identity", bins = 100, alpha = .9) + ylim(c(0,60)) +
  ggtitle("Status:NegCtrl p-values | 75-100% GE")

plot_grid(plot1,plot2,plot3,plot4)

ggsave(filename = paste0(figqqDir,"/Female_LPS_allBatches__StatusNegCtrlPval_HistTile.png"),
       width = 6, height = 4)
```


```{r qqplots for status within control samples MALE}
emremlallbatch <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_M_LPS_10000genes_4lCPM_modelF_nested_emmreml")
rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_M_LPS_10000genes_4lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

emremlallbatch$GE <- 0

for (r in 1:dim(emremlallbatch)[1]){
  emremlallbatch$GE[r] <- meanGE[which(rownames(emremlallbatch)[r] == names(meanGE))]
}

emremlallbatch$GE2 <- ntile(emremlallbatch$GE, 2)
emremlallbatch$GE4 <- ntile(emremlallbatch$GE, 4)
emremlallbatch$GE6 <- ntile(emremlallbatch$GE, 6)
emremlallbatch$GE10 <- ntile(emremlallbatch$GE, 10)

#generate a dataframe, with columns: gene name, GEdivision, GEtile, qqActual, qqExpected
geneNames <- vector()
GEdivision <- vector()
GEtile <- vector()
qqActual <- vector()
qqExpected <- vector()

emremlallbatchTrtSort <- emremlallbatch[order(emremlallbatch$pval_CtrlxStatus),]
#no quantile
geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
GEdivision <- c(GEdivision,rep("1",dim(emremlallbatchTrtSort)[1]))
GEtile <- c(GEtile,rep(1,dim(emremlallbatchTrtSort)[1]))
qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_CtrlxStatus))
qqExpected <- c(qqExpected,-log10(1:length(emremlallbatch$pval_CtrlxStatus) / length(emremlallbatch$pval_CtrlxStatus)))


#Q2
for (quantNum in 1:max(emremlallbatch$GE2)) {
  
  emremlallbatchQuant <- subset(emremlallbatch, GE2 == quantNum)
  
  emremlallbatchTrtSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_CtrlxStatus),]
  
  geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
  GEdivision <- c(GEdivision,rep("2",dim(emremlallbatchTrtSort)[1]))
  GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchTrtSort)[1]))
  qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_CtrlxStatus))
  qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchTrtSort$pval_CtrlxStatus) / length(emremlallbatchTrtSort$pval_CtrlxStatus)))
}

#Q4

for (quantNum in 1:max(emremlallbatch$GE4)) {
  
  emremlallbatchQuant <- subset(emremlallbatch, GE4 == quantNum)
  
  emremlallbatchTrtSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_CtrlxStatus),]
  
  geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
  GEdivision <- c(GEdivision,rep("4",dim(emremlallbatchTrtSort)[1]))
  GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchTrtSort)[1]))
  qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_CtrlxStatus))
  qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchTrtSort$pval_CtrlxStatus) / length(emremlallbatchTrtSort$pval_CtrlxStatus)))
}

#Q10

for (quantNum in 1:max(emremlallbatch$GE10)) {
  
  emremlallbatchQuant <- subset(emremlallbatch, GE10 == quantNum)
  
  emremlallbatchTrtSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_CtrlxStatus),]
  
  geneNames <- c(geneNames,rownames(emremlallbatchTrtSort))
  GEdivision <- c(GEdivision,rep("10",dim(emremlallbatchTrtSort)[1]))
  GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchTrtSort)[1]))
  qqActual <- c(qqActual,-log10(emremlallbatchTrtSort$pval_CtrlxStatus))
  qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchTrtSort$pval_CtrlxStatus) / length(emremlallbatchTrtSort$pval_CtrlxStatus)))
}

qqTreatment <- cbind.data.frame(geneNames,GEdivision,GEtile,qqActual,qqExpected)

qqTreatment$GEdivTile <- paste0(qqTreatment$GEdivision,"_",qqTreatment$GEtile)

qqTreatment$GEdivTile <- factor(qqTreatment$GEdivTile, 
                                levels = c("1_1","2_1","2_2","4_1","4_2","4_3","4_4",
                                           "10_1","10_2","10_3","10_4","10_5","10_6","10_7","10_8","10_9","10_10"))


ggplot(data = subset(qqTreatment, GEdivision == "1"), aes(x = qqExpected,
                               y = qqActual,
                               col = GEdivTile)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  labs(col = "GE_nTile") +
  ggtitle("Status:NegCtrl p-value qqPlot",
          subtitle = paste0("Male, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1])) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")

ggsave(filename = paste0(figqqDir,"/Male_LPS_allBatches__StatusBegCtrlPval_GE1tile.png"),
       width = 6, height = 4)

ggplot(data = subset(qqTreatment, GEdivision == "2"), aes(x = qqExpected,
                               y = qqActual,
                               col = GEdivTile)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  labs(col = "GE_nTile") +
  ggtitle("Status:NegCtrl p-value qqPlot",
          subtitle = paste0("Male, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1])) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")

ggsave(filename = paste0(figqqDir,"/Male_LPS_allBatches__StatusBegCtrlPval_GE2tile.png"),
       width = 6, height = 4)

ggplot(data = subset(qqTreatment, GEdivision == "4"), aes(x = qqExpected,
                               y = qqActual,
                               col = GEdivTile)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  labs(col = "GE_nTile") +
  ggtitle("Status:NegCtrl p-value qqPlot",
          subtitle = paste0("Male, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1])) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")

ggsave(filename = paste0(figqqDir,"/Male_LPS_allBatches__StatusBegCtrlPval_GE4tile.png"),
       width = 6, height = 4)

ggplot(data = subset(qqTreatment, GEdivision == "10"), aes(x = qqExpected,
                               y = qqActual,
                               col = GEdivTile)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_point() +
  labs(col = "GE_nTile") +
  ggtitle("Status:NegCtrl p-value qqPlot",
          subtitle = paste0("Male, LPS, All Batches, min logCPM > 4, nGenes=",
                            dim(subset(qqTreatment, GEdivision == "1"))[1])) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")

ggsave(filename = paste0(figqqDir,"/Male_LPS_allBatches__StatusBegCtrlPval_GE10tile.png"),
       width = 6, height = 4)

```

```{r qq plot male v female}
emremlMale <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_M_allTrt_10000genes_5lCPM_modelG_allTrtM_emmreml")
emremlFemale <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_allTrt_10000genes_5lCPM_modelQ_allTrtF_emmreml")

qqActualMale <- sort(-log10(emremlMale$pval_status))
qqExpectedMale <- sort(-log10(1:length(emremlMale$pval_status) / length(emremlMale$pval_status)))

qqActualFemale <- sort(-log10(emremlFemale$pval_status))
qqExpectedFemale <- sort(-log10(1:length(emremlFemale$pval_status) / length(emremlFemale$pval_status)))

ggplot() +
  geom_abline(slope = 1, intercept = 0, col = "gray60") +
  geom_point(aes(x = qqExpectedMale,
                 y = qqActualMale), col = "dodgerblue") +
    geom_point(aes(x = qqExpectedFemale,
                 y = qqActualFemale), col = "salmon") +
  ggtitle("Status p-value qqPlot",
          subtitle = paste0("All Trt, All Batches, min logCPM > 5")) +
  ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")
ggsave(paste0(figDir,"qqplot_male_v_female_statusEffect.png"), width = 4, height = 4)

```


compare the Batch 1 and Batch 2 status effect, by treatment/control and by male/female
```{r}
#UChicB2 v B1 - Female only - LPS

#Batch 1
batch1emreml <- read.table("~/Dropbox (Personal)/meerkats/RNA/2020_sept_largeBatch/output/LPS_Fonly__emmreml")

batch1ModelAbasic <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2020_F_LPS_10000genes_4lCPM_modelA_basic_emmreml")
batch1ModelAnested <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2020_F_LPS_10000genes_4lCPM_modelA_nested_emmreml")

#Batch 2
batch2emreml <- read.table("~/Dropbox (Personal)/meerkats/RNA/2021_july/output/trtCtrl_LPS_UChicago_F/trtCtrl_LPS_UChicago_F_statusTrtNest_model_emmreml")

batch2ModelBbasic <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelB_basic_emmreml")
batch2ModelBnested <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelB_nested_emmreml")



### batch 2020 v. batch 2020 1A

sharedGenes <- intersect(rownames(batch1emreml),rownames(batch1ModelAnested))

batch1emreml$geneName <- rownames(batch1emreml)
batch1ModelAnested$geneName <- rownames(batch1ModelAnested)

compareLPSemreml <- merge(batch1emreml,batch1ModelAnested, by = "geneName", suffixes = c(".b1",".b1a"))


ggplot(compareLPSemreml, aes(x = beta_treatment.b1,
                             y = beta_treatment.b1a)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 1A v. Batch 1 LPS Trt Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_treatment.b1a, 
                                                 x = compareLPSemreml$beta_treatment.b1)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_treatment.b1a, 
                                                      x = compareLPSemreml$beta_treatment.b1)$p.value, digits = 3)))

ggplot(compareLPSemreml, aes(x = beta_TrtStatus,
                             y = beta_TrtxStatus)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 1A v. Batch 1 Trt:Status Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_TrtxStatus, 
                                                 x = compareLPSemreml$beta_TrtStatus)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_TrtxStatus, 
                                                      x = compareLPSemreml$beta_TrtStatus)$p.value, digits = 3)))

ggplot(compareLPSemreml, aes(x = beta_NCStatus,
                             y = beta_CtrlxStatus)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 1A v. Batch 1 Ctrl:Status Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_CtrlxStatus, 
                                                 x = compareLPSemreml$beta_NCStatus)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_CtrlxStatus, 
                                                      x = compareLPSemreml$beta_NCStatus)$p.value, digits = 3)))

#GE Strength
geStrength <- rowMeans(countsDF)

geStrengthShared <- geStrength[names(geStrength) %in% sharedGenes]

all(names(geStrengthShared) == compareLPSemreml$geneName)

compareLPSemreml$GE <- geStrengthShared

#top25% cutoff
geCutoff <- quantile(compareLPSemreml$GE)[4]

compareLPSemremlHighGE <- subset(compareLPSemreml, GE > geCutoff)

ggplot(compareLPSemremlHighGE, aes(x = beta_treatment.b1,
                             y = beta_treatment.b1a)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 1A v. Batch 1 LPS Trt Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_treatment.b1a, 
                                                 x = compareLPSemremlHighGE$beta_treatment.b1)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_treatment.b1a, 
                                                      x = compareLPSemremlHighGE$beta_treatment.b1)$p.value, digits = 3)))

ggplot(compareLPSemremlHighGE, aes(x = beta_TrtStatus,
                             y = beta_TrtxStatus)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 1A v. Batch 1 Trt:Status Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_TrtxStatus, 
                                                 x = compareLPSemremlHighGE$beta_TrtStatus)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_TrtxStatus, 
                                                      x = compareLPSemremlHighGE$beta_TrtStatus)$p.value, digits = 3)))

ggplot(compareLPSemremlHighGE, aes(x = beta_NCStatus,
                             y = beta_CtrlxStatus)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 1A v. Batch 1 Ctrl:Status Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_CtrlxStatus, 
                                                 x = compareLPSemremlHighGE$beta_NCStatus)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_CtrlxStatus, 
                                                      x = compareLPSemremlHighGE$beta_NCStatus)$p.value, digits = 3)))



### batch 2021 v. batch 2021 B

sharedGenes <- intersect(rownames(batch2emreml),rownames(batch2ModelBnested))

batch2emreml$geneName <- rownames(batch2emreml)
batch2ModelBnested$geneName <- rownames(batch2ModelBnested)

compareLPSemreml <- merge(batch2emreml,batch2ModelBnested, by = "geneName", suffixes = c(".b2",".b2b"))


ggplot(compareLPSemreml, aes(x = beta_treatment.b2,
                             y = beta_treatment.b2b)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2B v. Batch 2 LPS Trt Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_treatment.b2b, 
                                                 x = compareLPSemreml$beta_treatment.b2)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_treatment.b2b, 
                                                      x = compareLPSemreml$beta_treatment.b2)$p.value, digits = 3)))

ggplot(compareLPSemreml, aes(x = beta_TrtxStatus.b2,
                             y = beta_TrtxStatus.b2b)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2B v. Batch 2 Trt:Status Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_TrtxStatus.b2b, 
                                                 x = compareLPSemreml$beta_TrtxStatus.b2)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_TrtxStatus.b2b, 
                                                      x = compareLPSemreml$beta_TrtxStatus.b2)$p.value, digits = 3)))

ggplot(compareLPSemreml, aes(x = beta_CtrlxStatus.b2,
                             y = beta_CtrlxStatus.b2b)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2B v. Batch 2 Ctrl:Status Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_CtrlxStatus.b2b, 
                                                 x = compareLPSemreml$beta_CtrlxStatus.b2)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_CtrlxStatus.b2b, 
                                                      x = compareLPSemreml$beta_CtrlxStatus.b2)$p.value, digits = 3)))

#GE Strength
geStrength <- rowMeans(countsDF)

geStrengthShared <- geStrength[names(geStrength) %in% sharedGenes]

all(names(geStrengthShared) == compareLPSemreml$geneName)

compareLPSemreml$GE <- geStrengthShared

#top25% cutoff
geCutoff <- quantile(compareLPSemreml$GE)[4]

compareLPSemremlHighGE <- subset(compareLPSemreml, GE > geCutoff)

ggplot(compareLPSemremlHighGE, aes(x = beta_treatment.b2,
                             y = beta_treatment.b2b)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2B v. Batch 2 LPS Trt Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_treatment.b2b, 
                                                 x = compareLPSemremlHighGE$beta_treatment.b2)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_treatment.b2b, 
                                                      x = compareLPSemremlHighGE$beta_treatment.b2)$p.value, digits = 3)))

ggplot(compareLPSemremlHighGE, aes(x = beta_TrtxStatus.b2,
                             y = beta_TrtxStatus.b2b)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2B v. Batch 2 Trt:Status Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_TrtxStatus.b2b, 
                                                 x = compareLPSemremlHighGE$beta_TrtxStatus.b2)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_TrtxStatus.b2b, 
                                                      x = compareLPSemremlHighGE$beta_TrtxStatus.b2)$p.value, digits = 3)))

ggplot(compareLPSemremlHighGE, aes(x = beta_CtrlxStatus.b2,
                             y = beta_CtrlxStatus.b2b)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2B v. Batch 2 Ctrl:Status Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_CtrlxStatus.b2b, 
                                                 x = compareLPSemremlHighGE$beta_CtrlxStatus.b2)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_CtrlxStatus.b2b, 
                                                      x = compareLPSemremlHighGE$beta_CtrlxStatus.b2)$p.value, digits = 3)))
```


compare QQ plots of status before and after controlling for pregnancy (or vice-versa)
```{r qqplots for status controlling for preg}
treatment <- "LPS"
for (treatment in c("Ctrl","LPS","Dex","Gard")) {
  #model Var is the variable to check the effect of before and after controlling for the OTHER variable
  modelVar <- "Status"
  for (modelVar in c("Preg","Status")) {

  
  
    if (modelVar == "Status") {
      modelTitle <- "modeling Preg as Tech Var."
    } else {
      modelTitle <- "modeling Status as Tech Var."
    }
    
    #LPS/Ctrl
    #P: F + Preg
    #Dex/Guard
    #Q: G + Preg
    
    #R: F + Status
    #S: G + Status
    
    if (modelVar == "Preg") {
      ctrlModel <- "R"
      origModel <- "F"
    } else { #if it is Status
      ctrlModel <- "P"
      origModel <- "F"
    }
    
    
    if (treatment %in% c("Dex","Gard")) {
      if (origModel == "F") {
        origModel <- "G"
      }
      if (ctrlModel == "R") {
        ctrlModel <- "S"
      }
      if (ctrlModel == "P") {
        ctrlModel <- "Q"
      }
    }
    
    #Q control for preg directly
    #
    emremlOrigAll <- read.table(paste0(outDir,"allBatches_F_",
                                       treatment,"only_10000genes_5lCPM_model",
                                       origModel,"_basicPreg_emmreml"))
    emremlCtrlAll <- read.table(paste0(outDir,"allBatches_F_",
                                       treatment,"only_10000genes_5lCPM_model",
                                       ctrlModel,"_basicPreg_emmreml"))
    
    emremlOrigTop <- read.table(paste0(outDir,"allBatches_F_",
                                       treatment,"only_10000genes_7lCPM_model",
                                       origModel,"_basicPreg_emmreml"))
    emremlCtrlTop <- read.table(paste0(outDir,"allBatches_F_",
                                       treatment,"only_10000genes_7lCPM_model",
                                       ctrlModel,"_basicPreg_emmreml"))
    
    emremlOrigAll$geneID <- rownames(emremlOrigAll)
    emremlCtrlAll$geneID <- rownames(emremlCtrlAll)
    emremlOrigTop$geneID <- rownames(emremlOrigTop)
    emremlCtrlTop$geneID <- rownames(emremlCtrlTop)
    
    emremlAllComp <- merge(emremlOrigAll, emremlCtrlAll, by = "geneID", suffixes = c(".orig",".ctrl"))
    emremlTopComp <- merge(emremlOrigTop, emremlCtrlTop, by = "geneID", suffixes = c(".orig",".ctrl"))
    
    
    #want to compare the betas of modelVar
    ggplot(data = emremlAllComp,
           aes(x = beta_preg.orig,
               y = beta_preg.ctrl)) +
      geom_point() +
      geom_abline(slope = 1, intercept = 0, col = "grey30") +
      xlab("Beta Preg Original Model") +
      ylab("Beta Preg Control Model") +
      ggtitle("All Genes - Preg Beta Comparison",
              subtitle = paste0(modelTitle," - ",treatment," only"))
    ggsave(paste0(figDir,"ctrl_v_original_pregBetas_",treatment,"_",modelVar,"_allGenes.png"),
           width = 6, height = 4)
    
    ggplot(data = emremlAllComp,
           aes(x = beta_status.orig,
               y = beta_status.ctrl)) +
      geom_point() +
      geom_abline(slope = 1, intercept = 0, col = "grey30") +
      xlab("Beta Status Original Model") +
      ylab("Beta Status Control Model") +
      ggtitle("All Genes - Status Beta Comparison",
              subtitle = paste0(modelTitle," - ",treatment," only"))
    ggsave(paste0(figDir,"ctrl_v_original_statusBetas_",treatment,"_",modelVar,"_allGenes.png"),
           width = 6, height = 4)
    
    ggplot(data = emremlTopComp,
           aes(x = beta_preg.orig,
               y = beta_preg.ctrl)) +
      geom_point() +
      geom_abline(slope = 1, intercept = 0, col = "grey30") +
      xlab("Beta Preg Original Model") +
      ylab("Beta Preg Control Model") +
      ggtitle("Top 25% Genes - Preg Beta Comparison",
              subtitle = paste0(modelTitle," - ",treatment," only"))
    ggsave(paste0(figDir,"ctrl_v_original_pregBetas_",treatment,"_",modelVar,"_topGenes.png"),
           width = 6, height = 4)
    
    ggplot(data = emremlTopComp,
           aes(x = beta_status.orig,
               y = beta_status.ctrl)) +
      geom_point() +
      geom_abline(slope = 1, intercept = 0, col = "grey30") +
      xlab("Beta Status Original Model") +
      ylab("Beta Status Control Model") +
      ggtitle("Top 25% Genes - Status Beta Comparison",
              subtitle = paste0(modelTitle," - ",treatment," only"))
    ggsave(paste0(figDir,"ctrl_v_original_statusBetas_",treatment,"_",modelVar,"_topGenes.png"),
           width = 6, height = 4)
    
    #want to compare the QQ plots of modelVar
    results <- "emremlOrigAll"
    for (results in c("emremlOrigAll","emremlCtrlAll","emremlOrigTop","emremlCtrlTop")) {
      emremlResults <- get(results)
      #sort by status
      emremlResults <- emremlResults[order(emremlResults$pval_status),]
      emremlResults$qqExpStatus <- -log10(1:length(emremlResults$pval_status) / length(emremlResults$pval_status))
      emremlResults$qqStatus <- -log10(emremlResults$pval_status)
      
      #sort by preg
      emremlResults <- emremlResults[order(emremlResults$pval_preg),]
      emremlResults$qqExpPreg <- -log10(1:length(emremlResults$pval_status) / length(emremlResults$pval_status))
      emremlResults$qqPreg <- -log10(emremlResults$pval_preg)
      
      assign(x = paste0(results), value = emremlResults)
    }
    
    ggplot() +
      geom_abline(slope = 1, intercept = 0) +
      geom_point(aes(x = emremlOrigAll$qqExpPreg,
                     y = emremlOrigAll$qqPreg), col = "grey") +
      geom_point(aes(x = emremlCtrlAll$qqExpPreg,
                     y = emremlCtrlAll$qqPreg), col = "dodgerblue") +
      xlab("Expected -log10(pval)") +
      ylab("Actual -log10(pval)") +
      ggtitle("All Genes - Pregnancy qq",
              subtitle = paste0(modelTitle," - ",treatment," only"))
    ggsave(paste0(figDir,"qqplots/","ctrl_v_original_",treatment,"_",modelVar,"_nonCtrlVar_allGenes.png"),
           width = 5, height = 5)
    
    ggplot() +
      geom_abline(slope = 1, intercept = 0) +
      geom_point(aes(x = emremlOrigAll$qqExpStatus,
                     y = emremlOrigAll$qqStatus), col = "grey") +
      geom_point(aes(x = emremlCtrlAll$qqExpStatus,
                     y = emremlCtrlAll$qqStatus), col = "dodgerblue") +
      xlab("Expected -log10(pval)") +
      ylab("Actual -log10(pval)") +
      ggtitle("All Genes - Status qq",
              subtitle = paste0(modelTitle," - ",treatment," only"))
    ggsave(paste0(figDir,"qqplots/","ctrl_v_original_",treatment,"_",modelVar,"_ctrlVar_allGenes.png"),
           width = 5, height = 5)
    
    ggplot() +
      geom_abline(slope = 1, intercept = 0) +
      geom_point(aes(x = emremlOrigTop$qqExpPreg,
                     y = emremlOrigTop$qqPreg), col = "grey") +
      geom_point(aes(x = emremlCtrlTop$qqExpPreg,
                     y = emremlCtrlTop$qqPreg), col = "dodgerblue") +
      xlab("Expected -log10(pval)") +
      ylab("Actual -log10(pval)") +
      ggtitle("Top 25% Genes - Pregnancy qq",
              subtitle = paste0(modelTitle," - ",treatment," only"))
    ggsave(paste0(figDir,"qqplots/","ctrl_v_original_",treatment,"_",modelVar,"_nonCtrlVar_topGenes.png"),
           width = 5, height = 5)
    
    ggplot() +
      geom_abline(slope = 1, intercept = 0) +
      geom_point(aes(x = emremlOrigTop$qqExpStatus,
                     y = emremlOrigTop$qqStatus), col = "grey") +
      geom_point(aes(x = emremlCtrlTop$qqExpStatus,
                     y = emremlCtrlTop$qqStatus), col = "dodgerblue") +
      xlab("Expected -log10(pval)") +
      ylab("Actual -log10(pval)") +
      ggtitle("Top 25% Genes - Status qq",
              subtitle = paste0(modelTitle," - ",treatment," only"))
    ggsave(paste0(figDir,"qqplots/","ctrl_v_original_",treatment,"_",modelVar,"_ctrlVar_topGenes.png"),
           width = 5, height = 5)
  
  }
}



```

```{r count FDR}
modelFemreml <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelF_nested_emmreml")

sum(qvalue(modelFemreml$pval_treatment)$qvalues < .2)
sum(qvalue(modelFemreml$pval_treatment)$qvalues < .1)
sum(qvalue(modelFemreml$pval_treatment)$qvalues < .05)
sum(qvalue(modelFemreml$pval_treatment)$qvalues < .01)

sum(qvalue(modelFemreml$pval_TrtxStatus)$qvalues < .2)
sum(qvalue(modelFemreml$pval_TrtxStatus)$qvalues < .1)
sum(qvalue(modelFemreml$pval_TrtxStatus)$qvalues < .05)
sum(qvalue(modelFemreml$pval_TrtxStatus)$qvalues < .01)

modelDemreml <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelD_nested_emmreml")

sum(qvalue(modelDemreml$pval_treatment)$qvalues < .2)
sum(qvalue(modelDemreml$pval_treatment)$qvalues < .1)
sum(qvalue(modelDemreml$pval_treatment)$qvalues < .05)
sum(qvalue(modelDemreml$pval_treatment)$qvalues < .01)

sum(qvalue(modelDemreml$pval_TrtxStatus)$qvalues < .2)
sum(qvalue(modelDemreml$pval_TrtxStatus)$qvalues < .1)
sum(qvalue(modelDemreml$pval_TrtxStatus)$qvalues < .05)
sum(qvalue(modelDemreml$pval_TrtxStatus)$qvalues < .01)


modelBemreml <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelB_basic_emmreml")

sum(qvalue(modelBemreml$pval_treatment)$qvalues < .2)
sum(qvalue(modelBemreml$pval_treatment)$qvalues < .1)
sum(qvalue(modelBemreml$pval_treatment)$qvalues < .05)
sum(qvalue(modelBemreml$pval_treatment)$qvalues < .01)

sum(qvalue(modelBemreml$pval_status)$qvalues < .2)
sum(qvalue(modelBemreml$pval_status)$qvalues < .1)
sum(qvalue(modelBemreml$pval_status)$qvalues < .05)
sum(qvalue(modelBemreml$pval_status)$qvalues < .01)


modelFemremlmale <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_M_LPS_10000genes_4lCPM_modelF_nested_emmreml")

sum(qvalue(modelFemremlmale$pval_treatment)$qvalues < .2)
sum(qvalue(modelFemremlmale$pval_treatment)$qvalues < .1)
sum(qvalue(modelFemremlmale$pval_treatment)$qvalues < .05)
sum(qvalue(modelFemremlmale$pval_treatment)$qvalues < .01)

```



compare the Batch 1 and Batch 2 status effect, by treatment/control and by male/female
```{r}
#UChicB2 v B1 - Female only - LPS

#Batch 1
batch1emreml <- read.table("~/Dropbox (Personal)/meerkats/RNA/2020_sept_largeBatch/output/LPS_Fonly__emmreml")

batch1ModelAbasic <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2020_F_LPS_10000genes_4lCPM_modelA_basic_emmreml")
batch1ModelAnested <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2020_F_LPS_10000genes_4lCPM_modelA_nested_emmreml")

#Batch 2
batch2emreml <- read.table("~/Dropbox (Personal)/meerkats/RNA/2021_july/output/trtCtrl_LPS_UChicago_F/trtCtrl_LPS_UChicago_F_statusTrtNest_model_emmreml")

batch2ModelBbasic <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelB_basic_emmreml")
batch2ModelBnested <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelB_nested_emmreml")



### batch 2020 v. batch 2020 1A

sharedGenes <- intersect(rownames(batch1emreml),rownames(batch1ModelAnested))

batch1emreml$geneName <- rownames(batch1emreml)
batch1ModelAnested$geneName <- rownames(batch1ModelAnested)

compareLPSemreml <- merge(batch1emreml,batch1ModelAnested, by = "geneName", suffixes = c(".b1",".b1a"))


ggplot(compareLPSemreml, aes(x = beta_treatment.b1,
                             y = beta_treatment.b1a)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 1A v. Batch 1 LPS Trt Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_treatment.b1a, 
                                                 x = compareLPSemreml$beta_treatment.b1)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_treatment.b1a, 
                                                      x = compareLPSemreml$beta_treatment.b1)$p.value, digits = 3)))

ggplot(compareLPSemreml, aes(x = beta_TrtStatus,
                             y = beta_TrtxStatus)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 1A v. Batch 1 Trt:Status Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_TrtxStatus, 
                                                 x = compareLPSemreml$beta_TrtStatus)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_TrtxStatus, 
                                                      x = compareLPSemreml$beta_TrtStatus)$p.value, digits = 3)))

ggplot(compareLPSemreml, aes(x = beta_NCStatus,
                             y = beta_CtrlxStatus)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 1A v. Batch 1 Ctrl:Status Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_CtrlxStatus, 
                                                 x = compareLPSemreml$beta_NCStatus)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_CtrlxStatus, 
                                                      x = compareLPSemreml$beta_NCStatus)$p.value, digits = 3)))

#GE Strength
geStrength <- rowMeans(countsDF)

geStrengthShared <- geStrength[names(geStrength) %in% sharedGenes]

all(names(geStrengthShared) == compareLPSemreml$geneName)

compareLPSemreml$GE <- geStrengthShared

#top25% cutoff
geCutoff <- quantile(compareLPSemreml$GE)[4]

compareLPSemremlHighGE <- subset(compareLPSemreml, GE > geCutoff)

ggplot(compareLPSemremlHighGE, aes(x = beta_treatment.b1,
                             y = beta_treatment.b1a)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 1A v. Batch 1 LPS Trt Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_treatment.b1a, 
                                                 x = compareLPSemremlHighGE$beta_treatment.b1)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_treatment.b1a, 
                                                      x = compareLPSemremlHighGE$beta_treatment.b1)$p.value, digits = 3)))

ggplot(compareLPSemremlHighGE, aes(x = beta_TrtStatus,
                             y = beta_TrtxStatus)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 1A v. Batch 1 Trt:Status Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_TrtxStatus, 
                                                 x = compareLPSemremlHighGE$beta_TrtStatus)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_TrtxStatus, 
                                                      x = compareLPSemremlHighGE$beta_TrtStatus)$p.value, digits = 3)))

ggplot(compareLPSemremlHighGE, aes(x = beta_NCStatus,
                             y = beta_CtrlxStatus)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 1A v. Batch 1 Ctrl:Status Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_CtrlxStatus, 
                                                 x = compareLPSemremlHighGE$beta_NCStatus)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_CtrlxStatus, 
                                                      x = compareLPSemremlHighGE$beta_NCStatus)$p.value, digits = 3)))



### batch 2021 v. batch 2021 B

sharedGenes <- intersect(rownames(batch2emreml),rownames(batch2ModelBnested))

batch2emreml$geneName <- rownames(batch2emreml)
batch2ModelBnested$geneName <- rownames(batch2ModelBnested)

compareLPSemreml <- merge(batch2emreml,batch2ModelBnested, by = "geneName", suffixes = c(".b2",".b2b"))


ggplot(compareLPSemreml, aes(x = beta_treatment.b2,
                             y = beta_treatment.b2b)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2B v. Batch 2 LPS Trt Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_treatment.b2b, 
                                                 x = compareLPSemreml$beta_treatment.b2)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_treatment.b2b, 
                                                      x = compareLPSemreml$beta_treatment.b2)$p.value, digits = 3)))

ggplot(compareLPSemreml, aes(x = beta_TrtxStatus.b2,
                             y = beta_TrtxStatus.b2b)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2B v. Batch 2 Trt:Status Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_TrtxStatus.b2b, 
                                                 x = compareLPSemreml$beta_TrtxStatus.b2)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_TrtxStatus.b2b, 
                                                      x = compareLPSemreml$beta_TrtxStatus.b2)$p.value, digits = 3)))

ggplot(compareLPSemreml, aes(x = beta_CtrlxStatus.b2,
                             y = beta_CtrlxStatus.b2b)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2B v. Batch 2 Ctrl:Status Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_CtrlxStatus.b2b, 
                                                 x = compareLPSemreml$beta_CtrlxStatus.b2)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_CtrlxStatus.b2b, 
                                                      x = compareLPSemreml$beta_CtrlxStatus.b2)$p.value, digits = 3)))

#GE Strength
geStrength <- rowMeans(countsDF)

geStrengthShared <- geStrength[names(geStrength) %in% sharedGenes]

all(names(geStrengthShared) == compareLPSemreml$geneName)

compareLPSemreml$GE <- geStrengthShared

#top25% cutoff
geCutoff <- quantile(compareLPSemreml$GE)[4]

compareLPSemremlHighGE <- subset(compareLPSemreml, GE > geCutoff)

ggplot(compareLPSemremlHighGE, aes(x = beta_treatment.b2,
                             y = beta_treatment.b2b)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2B v. Batch 2 LPS Trt Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_treatment.b2b, 
                                                 x = compareLPSemremlHighGE$beta_treatment.b2)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_treatment.b2b, 
                                                      x = compareLPSemremlHighGE$beta_treatment.b2)$p.value, digits = 3)))

ggplot(compareLPSemremlHighGE, aes(x = beta_TrtxStatus.b2,
                             y = beta_TrtxStatus.b2b)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2B v. Batch 2 Trt:Status Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_TrtxStatus.b2b, 
                                                 x = compareLPSemremlHighGE$beta_TrtxStatus.b2)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_TrtxStatus.b2b, 
                                                      x = compareLPSemremlHighGE$beta_TrtxStatus.b2)$p.value, digits = 3)))

ggplot(compareLPSemremlHighGE, aes(x = beta_CtrlxStatus.b2,
                             y = beta_CtrlxStatus.b2b)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2B v. Batch 2 Ctrl:Status Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_CtrlxStatus.b2b, 
                                                 x = compareLPSemremlHighGE$beta_CtrlxStatus.b2)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_CtrlxStatus.b2b, 
                                                      x = compareLPSemremlHighGE$beta_CtrlxStatus.b2)$p.value, digits = 3)))
```


compare the Batch 1 and Batch 2 status effect, by treatment/control and by male/female
```{r}
#UChicB2 v B1 - Female only - LPS

#Batch 1
#batch1emreml <- read.table("~/Dropbox (Personal)/meerkats/RNA/2020_sept_largeBatch/output/LPS_Fonly__emmreml")

#batch1ModelAbasic <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2020_F_LPS_10000genes_4lCPM_modelA_basic_emmreml")
batch1ModelAnested <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2020_F_LPS_10000genes_4lCPM_modelA_nested_emmreml")

#Batch 2
#batch2emreml <- read.table("~/Dropbox (Personal)/meerkats/RNA/2021_july/output/trtCtrl_LPS_UChicago_F/trtCtrl_LPS_UChicago_F_statusTrtNest_model_emmreml")

#batch2ModelBbasic <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelB_basic_emmreml")
batch2ModelBnested <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelB_nested_emmreml")

batch1ModelBnested <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2020_F_LPS_10000genes_4lCPM_modelB_nested_emmreml")



### batch 2020 v. batch 2020 1A

sharedGenes <- intersect(rownames(batch1ModelBnested),rownames(batch2ModelBnested))

batch1ModelBnested$geneName <- rownames(batch1ModelBnested)
batch2ModelBnested$geneName <- rownames(batch2ModelBnested)

compareLPSemreml <- merge(batch1ModelBnested,batch2ModelBnested, by = "geneName", suffixes = c(".b1",".b2"))


ggplot(compareLPSemreml, aes(x = beta_treatment.b1,
                             y = beta_treatment.b2)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2 v. Batch 1 LPS Trt Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_treatment.b1, 
                                                 x = compareLPSemreml$beta_treatment.b2)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_treatment.b1, 
                                                      x = compareLPSemreml$beta_treatment.b2)$p.value, digits = 3)))

ggplot(compareLPSemreml, aes(x = beta_TrtxStatus.b2,
                             y = beta_TrtxStatus.b1)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2 v. Batch 1 Trt:Status Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_TrtxStatus.b2, 
                                                 x = compareLPSemreml$beta_TrtxStatus.b1)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_TrtxStatus.b2, 
                                                      x = compareLPSemreml$beta_TrtxStatus.b1)$p.value, digits = 3)))

ggplot(compareLPSemreml, aes(x = beta_CtrlxStatus.b2,
                             y = beta_CtrlxStatus.b1)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2 v. Batch 1 Ctrl:Status Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_CtrlxStatus.b2, 
                                                 x = compareLPSemreml$beta_CtrlxStatus.b1)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_CtrlxStatus.b2, 
                                                      x = compareLPSemreml$beta_CtrlxStatus.b1)$p.value, digits = 3)))

#GE Strength
geStrength <- rowMeans(countsDF)

geStrengthShared <- geStrength[names(geStrength) %in% sharedGenes]

all(names(geStrengthShared) == compareLPSemreml$geneName)

compareLPSemreml$GE <- geStrengthShared

#top25% cutoff
geCutoff <- quantile(compareLPSemreml$GE)[4]

compareLPSemremlHighGE <- subset(compareLPSemreml, GE > geCutoff)

ggplot(compareLPSemremlHighGE, aes(x = beta_treatment.b1,
                             y = beta_treatment.b2)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2 v. Batch 1 LPS Trt Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_treatment.b2, 
                                                 x = compareLPSemremlHighGE$beta_treatment.b1)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_treatment.b2, 
                                                      x = compareLPSemremlHighGE$beta_treatment.b1)$p.value, digits = 3)))

ggplot(compareLPSemremlHighGE, aes(x = beta_TrtxStatus.b1,
                             y = beta_TrtxStatus.b2)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2 v. Batch 1 Trt:Status Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_TrtxStatus.b2, 
                                                 x = compareLPSemremlHighGE$beta_TrtxStatus.b1)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_TrtxStatus.b2, 
                                                      x = compareLPSemremlHighGE$beta_TrtxStatus.b1)$p.value, digits = 3)))

ggplot(compareLPSemremlHighGE, aes(x = beta_CtrlxStatus.b1,
                             y = beta_CtrlxStatus.b2)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2 v. Batch 1 Ctrl:Status Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_CtrlxStatus.b2, 
                                                 x = compareLPSemremlHighGE$beta_CtrlxStatus.b1)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_CtrlxStatus.b2, 
                                                      x = compareLPSemremlHighGE$beta_CtrlxStatus.b1)$p.value, digits = 3)))




```


compare the Batch 2 and All Baatchs status effect, by treatment/control and by male/female
```{r}
#UChicB2 v B1 - Female only - LPS

#Batch 1
#batch1emreml <- read.table("~/Dropbox (Personal)/meerkats/RNA/2020_sept_largeBatch/output/LPS_Fonly__emmreml")

#batch1ModelAbasic <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2020_F_LPS_10000genes_4lCPM_modelA_basic_emmreml")
batchAllModelCnested <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelF_nested_emmreml")

#Batch 2
#batch2emreml <- read.table("~/Dropbox (Personal)/meerkats/RNA/2021_july/output/trtCtrl_LPS_UChicago_F/trtCtrl_LPS_UChicago_F_statusTrtNest_model_emmreml")

#batch2ModelBbasic <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2021_F_LPS_10000genes_4lCPM_modelB_basic_emmreml")
batch2ModelCnested <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/Batch2020_F_LPS_10000genes_4lCPM_modelF_nested_emmreml")



### batch 2020 v. batch 2020 1A

sharedGenes <- intersect(rownames(batch2ModelCnested),rownames(batchAllModelCnested))

batchAllModelCnested$geneName <- rownames(batchAllModelCnested)
batch2ModelCnested$geneName <- rownames(batch2ModelCnested)

compareLPSemreml <- merge(batch2ModelCnested,batchAllModelCnested, by = "geneName", suffixes = c(".b2",".bAll"))


ggplot(compareLPSemreml, aes(x = beta_treatment.bAll,
                             y = beta_treatment.b2)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2 v. Batch 1 LPS Trt Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_treatment.b2, 
                                                 x = compareLPSemreml$beta_treatment.bAll)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_treatment.b2, 
                                                      x = compareLPSemreml$beta_treatment.bAll)$p.value, digits = 3)))

ggplot(compareLPSemreml, aes(x = beta_TrtxStatus.bAll,
                             y = beta_TrtxStatus.b2)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2 v. Batch 1 Trt:Status Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_TrtxStatus.b2, 
                                                 x = compareLPSemreml$beta_TrtxStatus.bAll)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_TrtxStatus.b2, 
                                                      x = compareLPSemreml$beta_TrtxStatus.bAll)$p.value, digits = 3)))

ggplot(compareLPSemreml, aes(x = beta_CtrlxStatus.b2,
                             y = beta_CtrlxStatus.bAll)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2 v. Batch 1 Ctrl:Status Betas", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemreml$beta_CtrlxStatus.b2, 
                                                 x = compareLPSemreml$beta_CtrlxStatus.bAll)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemreml$beta_CtrlxStatus.b2, 
                                                      x = compareLPSemreml$beta_CtrlxStatus.bAll)$p.value, digits = 3)))

#GE Strength
geStrength <- rowMeans(countsDF)

geStrengthShared <- geStrength[names(geStrength) %in% sharedGenes]

all(names(geStrengthShared) == compareLPSemreml$geneName)

compareLPSemreml$GE <- geStrengthShared

#top25% cutoff
geCutoff <- quantile(compareLPSemreml$GE)[4]

compareLPSemremlHighGE <- subset(compareLPSemreml, GE > geCutoff)

ggplot(compareLPSemremlHighGE, aes(x = beta_treatment.bAll,
                             y = beta_treatment.b2)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2 v. Batch 1 LPS Trt Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_treatment.b2, 
                                                 x = compareLPSemremlHighGE$beta_treatment.bAll)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_treatment.b2, 
                                                      x = compareLPSemremlHighGE$beta_treatment.bAll)$p.value, digits = 3)))

ggplot(compareLPSemremlHighGE, aes(x = beta_TrtxStatus.bAll,
                             y = beta_TrtxStatus.b2)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2 v. Batch 1 Trt:Status Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_TrtxStatus.b2, 
                                                 x = compareLPSemremlHighGE$beta_TrtxStatus.bAll)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_TrtxStatus.b2, 
                                                      x = compareLPSemremlHighGE$beta_TrtxStatus.bAll)$p.value, digits = 3)))

ggplot(compareLPSemremlHighGE, aes(x = beta_CtrlxStatus.bAll,
                             y = beta_CtrlxStatus.b2)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("Batch 2 v. Batch 1 Ctrl:Status Betas | top 25% GE", 
          subtitle = paste0("R=",signif(cor.test(y = compareLPSemremlHighGE$beta_CtrlxStatus.b2, 
                                                 x = compareLPSemremlHighGE$beta_CtrlxStatus.bAll)$estimate, digits = 3),
                                " p=",signif(cor.test(y = compareLPSemremlHighGE$beta_CtrlxStatus.b2, 
                                                      x = compareLPSemremlHighGE$beta_CtrlxStatus.bAll)$p.value, digits = 3)))




```



```{r}

source(paste0(gitDir,"meerkatAnalysis/generateResiduals.R"))

#batchList <- "Batch2020"
focalSex <- "M"
focalTreatment <- "LPS"
minGenes <- 10000
minLogCPM <- 4

gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"_",minGenes,"genes_",minLogCPM,"lCPM")

#genResids(workDir = workDir, gatherSubset = gatherSubset, model = "A")



for (batchList in c("Batch2021","Batch2020","allBatches")) {
  focalSex <- "M"
  focalTreatment <- "LPS"
  minGenes <- 10000
  minLogCPM <- 4
  
  gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"_",minGenes,"genes_",minLogCPM,"lCPM")

  genResids(workDir = workDir, gatherSubset = gatherSubset, model = "F")
  
  #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = "F", LM = "nested")

}


```

21 Feb 2022

```{r are more genes significant for status at higher GE - trt only models}

#add loop through 4 conditions

for (focalTreatment in c("Ctrl","LPS","Dex","Gard")) {

  figqqDir <- paste0(figDir,"qqPlots")
  dir.create(figqqDir)
  
  emremlallbatch <- read.table(paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",focalTreatment,
                                      "only_10000genes_5lCPM_modelF_basic_emmreml"))
  rnaCounts <- readRDS(paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",focalTreatment,
                       "only_10000genes_5lCPM_counts.RDS"))
  meanGE <- rowMeans(rnaCounts)
  
  emremlallbatch$GE <- 0
  
  for (r in 1:dim(emremlallbatch)[1]){
    emremlallbatch$GE[r] <- meanGE[which(rownames(emremlallbatch)[r] == names(meanGE))]
  }
  
  emremlallbatch$GE2 <- ntile(emremlallbatch$GE, 2)
  emremlallbatch$GE4 <- ntile(emremlallbatch$GE, 4)
  emremlallbatch$GE6 <- ntile(emremlallbatch$GE, 6)
  emremlallbatch$GE10 <- ntile(emremlallbatch$GE, 10)
  
  #generate a dataframe, with columns: gene name, GEdivision, GEtile, qqActual, qqExpected
  geneNames <- vector()
  GEdivision <- vector()
  GEtile <- vector()
  qqActual <- vector()
  qqExpected <- vector()
  
  emremlallbatchStatusSort <- emremlallbatch[order(emremlallbatch$pval_status),]
  #no quantile
  geneNames <- c(geneNames,rownames(emremlallbatchStatusSort))
  GEdivision <- c(GEdivision,rep("1",dim(emremlallbatchStatusSort)[1]))
  GEtile <- c(GEtile,rep(1,dim(emremlallbatchStatusSort)[1]))
  qqActual <- c(qqActual,-log10(emremlallbatchStatusSort$pval_status))
  qqExpected <- c(qqExpected,-log10(1:length(emremlallbatch$pval_status) / length(emremlallbatch$pval_status)))
  
  
  #Q2
  for (quantNum in 1:max(emremlallbatch$GE2)) {
    
    emremlallbatchQuant <- subset(emremlallbatch, GE2 == quantNum)
    
    emremlallbatchStatusSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_status),]
    
    geneNames <- c(geneNames,rownames(emremlallbatchStatusSort))
    GEdivision <- c(GEdivision,rep("2",dim(emremlallbatchStatusSort)[1]))
    GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchStatusSort)[1]))
    qqActual <- c(qqActual,-log10(emremlallbatchStatusSort$pval_status))
    qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchStatusSort$pval_status) / length(emremlallbatchStatusSort$pval_status)))
  }
  
  #Q4
  
  for (quantNum in 1:max(emremlallbatch$GE4)) {
    
    emremlallbatchQuant <- subset(emremlallbatch, GE4 == quantNum)
    
    emremlallbatchStatusSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_status),]
    
    geneNames <- c(geneNames,rownames(emremlallbatchStatusSort))
    GEdivision <- c(GEdivision,rep("4",dim(emremlallbatchStatusSort)[1]))
    GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchStatusSort)[1]))
    qqActual <- c(qqActual,-log10(emremlallbatchStatusSort$pval_status))
    qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchStatusSort$pval_status) / length(emremlallbatchStatusSort$pval_status)))
  }
  
  #Q10
  
  for (quantNum in 1:max(emremlallbatch$GE10)) {
    
    emremlallbatchQuant <- subset(emremlallbatch, GE10 == quantNum)
    
    emremlallbatchStatusSort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_status),]
    
    geneNames <- c(geneNames,rownames(emremlallbatchStatusSort))
    GEdivision <- c(GEdivision,rep("10",dim(emremlallbatchStatusSort)[1]))
    GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchStatusSort)[1]))
    qqActual <- c(qqActual,-log10(emremlallbatchStatusSort$pval_status))
    qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchStatusSort$pval_status) / length(emremlallbatchStatusSort$pval_status)))
  }
  
  qqStatus <- cbind.data.frame(geneNames,GEdivision,GEtile,qqActual,qqExpected)
  
  qqStatus$GEdivTile <- paste0(qqStatus$GEdivision,"_",qqStatus$GEtile)
  
  qqStatus$GEdivTile <- factor(qqStatus$GEdivTile, 
                                  levels = c("1_1","2_1","2_2","4_1","4_2","4_3","4_4",
                                             "10_1","10_2","10_3","10_4","10_5","10_6","10_7","10_8","10_9","10_10"))
  
  ggplot(data = subset(qqStatus, GEdivision == "1"), aes(x = qqExpected,
                                 y = qqActual,
                                 col = GEdivTile)) +
    geom_abline(slope = 1, intercept = 0) +
    geom_point() +
    labs(col = "GE_nTile") +
    ggtitle("Status p-value qqPlot",
            subtitle = paste0("Female, ",focalTreatment,", All Batches, min logCPM > 5, nGenes=",
                              dim(subset(qqStatus, GEdivision == "1"))[1])) +
    ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")
  
  ggsave(filename = paste0(figqqDir,"/Female_",focalTreatment,"_allBatches__StatusPval_GE1tile.png"),
         width = 6, height = 4)
  
  ggplot(data = subset(qqStatus, GEdivision == "2"), aes(x = qqExpected,
                                 y = qqActual,
                                 col = GEdivTile)) +
    geom_abline(slope = 1, intercept = 0) +
    geom_point() +
    labs(col = "GE_nTile") +
    ggtitle("Status p-value qqPlot",
            subtitle = paste0("Female, ",focalTreatment,", All Batches, min logCPM > 5, nGenes=",
                              dim(subset(qqStatus, GEdivision == "1"))[1])) +
    ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")
  
  ggsave(filename = paste0(figqqDir,"/Female_",focalTreatment,"_allBatches__StatusPval_GE2tile.png"),
         width = 6, height = 4)
  
  ggplot(data = subset(qqStatus, GEdivision == "4"), aes(x = qqExpected,
                                 y = qqActual,
                                 col = GEdivTile)) +
    geom_abline(slope = 1, intercept = 0) +
    geom_point() +
    labs(col = "GE_nTile") +
    ggtitle("Status p-value qqPlot",
            subtitle = paste0("Female, ",focalTreatment,", All Batches, min logCPM > 5, nGenes=",
                              dim(subset(qqStatus, GEdivision == "1"))[1])) +
    ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")
  
  ggsave(filename = paste0(figqqDir,"/Female_",focalTreatment,"_allBatches__StatusPval_GE4tile.png"),
         width = 6, height = 4)
  
  ggplot(data = subset(qqStatus, GEdivision == "10"), aes(x = qqExpected,
                                 y = qqActual,
                                 col = GEdivTile)) +
    geom_abline(slope = 1, intercept = 0) +
    geom_point() +
    labs(col = "GE_nTile") +
    ggtitle("Status p-value qqPlot",
            subtitle = paste0("Female, ",focalTreatment,", All Batches, min logCPM > 5, nGenes=",
                              dim(subset(qqStatus, GEdivision == "1"))[1])) +
    ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")
  
  ggsave(filename = paste0(figqqDir,"/Female_",focalTreatment,"_allBatches__StatusPval_GE10tile.png"),
         width = 6, height = 4)
  
  ##### add histograms
  
  qqHist <- subset(qqStatus, GEdivision == "4")
  
  qqHist$pvalActual <- 10^-qqHist$qqActual
  
  qqHist$GEdivTile <- factor(qqHist$GEdivTile, levels = c("4_4","4_3","4_2","4_1"))
  
  ggplot(data = qqHist, aes(x = pvalActual, fill = GEdivTile)) +
    geom_histogram(position = "identity", bins = 100, alpha = 2/3) + ylim(c(0,60)) +
    ggtitle(paste0(focalTreatment," Only, Status p-values"),
            subtitle = paste0("Female, ",focalTreatment,", All Batches, min logCPM > 5, nGenes=",
                              dim(subset(qqStatus, GEdivision == "1"))[1]))
  
  ggsave(filename = paste0(figqqDir,"/Female_",focalTreatment,"_allBatches__StatusPval_Hist.png"),
         width = 6, height = 4)
  
  plot1 <- ggplot(data = subset(qqHist, GEdivTile == "4_1"), aes(x = pvalActual)) +
    geom_histogram(position = "identity", bins = 100, alpha = .9) + ylim(c(0,60)) +
    ggtitle(paste0(focalTreatment," Only, Status p-values | 0-25% GE"))
  
  plot2 <- ggplot(data = subset(qqHist, GEdivTile == "4_2"), aes(x = pvalActual)) +
    geom_histogram(position = "identity", bins = 100, alpha = .9) + ylim(c(0,60)) +
    ggtitle(paste0(focalTreatment," Only, Status p-values | 25-50% GE"))
  
  plot3 <- ggplot(data = subset(qqHist, GEdivTile == "4_3"), aes(x = pvalActual)) +
    geom_histogram(position = "identity", bins = 100, alpha = .9) + ylim(c(0,60)) +
    ggtitle(paste0(focalTreatment," Only, Status p-values | 50-75% GE"))
  
  plot4 <- ggplot(data = subset(qqHist, GEdivTile == "4_4"), aes(x = pvalActual)) +
    geom_histogram(position = "identity", bins = 100, alpha = .9) + ylim(c(0,60)) +
    ggtitle(paste0(focalTreatment," Only, Status p-values | 75-100% GE"))
  
  plot_grid(plot1,plot2,plot3,plot4)
  
  ggsave(filename = paste0(figqqDir,"/Female_",focalTreatment,"_allBatches__StatusPval_HistTile.png"),
         width = 6, height = 4)
}
```

```{r are more genes significant for PREGNANCY at higher GE - trt only models}

#add loop through 4 conditions

for (focalTreatment in c("Ctrl","LPS","Dex","Gard")) {

  figqqDir <- paste0(figDir,"qqPlots")
  dir.create(figqqDir)
  
  emremlallbatch <- read.table(paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",focalTreatment,
                                      "only_10000genes_5lCPM_modelF_basicPreg_emmreml"))
  rnaCounts <- readRDS(paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",focalTreatment,
                       "only_10000genes_5lCPM_counts.RDS"))
  meanGE <- rowMeans(rnaCounts)
  
  emremlallbatch$GE <- 0
  
  for (r in 1:dim(emremlallbatch)[1]){
    emremlallbatch$GE[r] <- meanGE[which(rownames(emremlallbatch)[r] == names(meanGE))]
  }
  
  emremlallbatch$GE2 <- ntile(emremlallbatch$GE, 2)
  emremlallbatch$GE4 <- ntile(emremlallbatch$GE, 4)
  emremlallbatch$GE6 <- ntile(emremlallbatch$GE, 6)
  emremlallbatch$GE10 <- ntile(emremlallbatch$GE, 10)
  
  #generate a dataframe, with columns: gene name, GEdivision, GEtile, qqActual, qqExpected
  geneNames <- vector()
  GEdivision <- vector()
  GEtile <- vector()
  qqActual <- vector()
  qqExpected <- vector()
  
  emremlallbatchPregnancySort <- emremlallbatch[order(emremlallbatch$pval_preg),]
  #no quantile
  geneNames <- c(geneNames,rownames(emremlallbatchPregnancySort))
  GEdivision <- c(GEdivision,rep("1",dim(emremlallbatchPregnancySort)[1]))
  GEtile <- c(GEtile,rep(1,dim(emremlallbatchPregnancySort)[1]))
  qqActual <- c(qqActual,-log10(emremlallbatchPregnancySort$pval_preg))
  qqExpected <- c(qqExpected,-log10(1:length(emremlallbatch$pval_preg) / length(emremlallbatch$pval_preg)))
  
  
  #Q2
  for (quantNum in 1:max(emremlallbatch$GE2)) {
    
    emremlallbatchQuant <- subset(emremlallbatch, GE2 == quantNum)
    
    emremlallbatchPregnancySort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_preg),]
    
    geneNames <- c(geneNames,rownames(emremlallbatchPregnancySort))
    GEdivision <- c(GEdivision,rep("2",dim(emremlallbatchPregnancySort)[1]))
    GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchPregnancySort)[1]))
    qqActual <- c(qqActual,-log10(emremlallbatchPregnancySort$pval_preg))
    qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchPregnancySort$pval_preg) / length(emremlallbatchPregnancySort$pval_preg)))
  }
  
  #Q4
  
  for (quantNum in 1:max(emremlallbatch$GE4)) {
    
    emremlallbatchQuant <- subset(emremlallbatch, GE4 == quantNum)
    
    emremlallbatchPregnancySort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_preg),]
    
    geneNames <- c(geneNames,rownames(emremlallbatchPregnancySort))
    GEdivision <- c(GEdivision,rep("4",dim(emremlallbatchPregnancySort)[1]))
    GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchPregnancySort)[1]))
    qqActual <- c(qqActual,-log10(emremlallbatchPregnancySort$pval_preg))
    qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchPregnancySort$pval_preg) / length(emremlallbatchPregnancySort$pval_preg)))
  }
  
  #Q10
  
  for (quantNum in 1:max(emremlallbatch$GE10)) {
    
    emremlallbatchQuant <- subset(emremlallbatch, GE10 == quantNum)
    
    emremlallbatchPregnancySort <- emremlallbatchQuant[order(emremlallbatchQuant$pval_preg),]
    
    geneNames <- c(geneNames,rownames(emremlallbatchPregnancySort))
    GEdivision <- c(GEdivision,rep("10",dim(emremlallbatchPregnancySort)[1]))
    GEtile <- c(GEtile,rep(quantNum,dim(emremlallbatchPregnancySort)[1]))
    qqActual <- c(qqActual,-log10(emremlallbatchPregnancySort$pval_preg))
    qqExpected <- c(qqExpected,-log10(1:length(emremlallbatchPregnancySort$pval_preg) / length(emremlallbatchPregnancySort$pval_preg)))
  }
  
  qqPregnancy <- cbind.data.frame(geneNames,GEdivision,GEtile,qqActual,qqExpected)
  
  qqPregnancy$GEdivTile <- paste0(qqPregnancy$GEdivision,"_",qqPregnancy$GEtile)
  
  qqPregnancy$GEdivTile <- factor(qqPregnancy$GEdivTile, 
                                  levels = c("1_1","2_1","2_2","4_1","4_2","4_3","4_4",
                                             "10_1","10_2","10_3","10_4","10_5","10_6","10_7","10_8","10_9","10_10"))
  
  ggplot(data = subset(qqPregnancy, GEdivision == "1"), aes(x = qqExpected,
                                 y = qqActual,
                                 col = GEdivTile)) +
    geom_abline(slope = 1, intercept = 0) +
    geom_point() +
    labs(col = "GE_nTile") +
    ggtitle("Pregnancy p-value qqPlot",
            subtitle = paste0("Female, ",focalTreatment,", All Batches, min logCPM > 5, nGenes=",
                              dim(subset(qqPregnancy, GEdivision == "1"))[1])) +
    ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")
  
  ggsave(filename = paste0(figqqDir,"/Female_",focalTreatment,"_allBatches__PregnancyPval_GE1tile.png"),
         width = 6, height = 4)
  
  ggplot(data = subset(qqPregnancy, GEdivision == "2"), aes(x = qqExpected,
                                 y = qqActual,
                                 col = GEdivTile)) +
    geom_abline(slope = 1, intercept = 0) +
    geom_point() +
    labs(col = "GE_nTile") +
    ggtitle("Pregnancy p-value qqPlot",
            subtitle = paste0("Female, ",focalTreatment,", All Batches, min logCPM > 5, nGenes=",
                              dim(subset(qqPregnancy, GEdivision == "1"))[1])) +
    ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")
  
  ggsave(filename = paste0(figqqDir,"/Female_",focalTreatment,"_allBatches__PregnancyPval_GE2tile.png"),
         width = 6, height = 4)
  
  ggplot(data = subset(qqPregnancy, GEdivision == "4"), aes(x = qqExpected,
                                 y = qqActual,
                                 col = GEdivTile)) +
    geom_abline(slope = 1, intercept = 0) +
    geom_point() +
    labs(col = "GE_nTile") +
    ggtitle("Pregnancy p-value qqPlot",
            subtitle = paste0("Female, ",focalTreatment,", All Batches, min logCPM > 5, nGenes=",
                              dim(subset(qqPregnancy, GEdivision == "1"))[1])) +
    ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")
  
  ggsave(filename = paste0(figqqDir,"/Female_",focalTreatment,"_allBatches__PregnancyPval_GE4tile.png"),
         width = 6, height = 4)
  
  ggplot(data = subset(qqPregnancy, GEdivision == "10"), aes(x = qqExpected,
                                 y = qqActual,
                                 col = GEdivTile)) +
    geom_abline(slope = 1, intercept = 0) +
    geom_point() +
    labs(col = "GE_nTile") +
    ggtitle("Pregnancy p-value qqPlot",
            subtitle = paste0("Female, ",focalTreatment,", All Batches, min logCPM > 5, nGenes=",
                              dim(subset(qqPregnancy, GEdivision == "1"))[1])) +
    ylab("-log10(pval) Observed") + xlab("-log10(pval) Expected (from flat dist.)")
  
  ggsave(filename = paste0(figqqDir,"/Female_",focalTreatment,"_allBatches__PregnancyPval_GE10tile.png"),
         width = 6, height = 4)
  
  ##### add histograms
  
  qqHist <- subset(qqPregnancy, GEdivision == "4")
  
  qqHist$pvalActual <- 10^-qqHist$qqActual
  
  qqHist$GEdivTile <- factor(qqHist$GEdivTile, levels = c("4_4","4_3","4_2","4_1"))
  
  ggplot(data = qqHist, aes(x = pvalActual, fill = GEdivTile)) +
    geom_histogram(position = "identity", bins = 100, alpha = 2/3) + ylim(c(0,60)) +
    ggtitle(paste0(focalTreatment," Only, Pregnancy p-values"),
            subtitle = paste0("Female, ",focalTreatment,", All Batches, min logCPM > 5, nGenes=",
                              dim(subset(qqPregnancy, GEdivision == "1"))[1]))
  
  ggsave(filename = paste0(figqqDir,"/Female_",focalTreatment,"_allBatches__PregnancyPval_Hist.png"),
         width = 6, height = 4)
  
  plot1 <- ggplot(data = subset(qqHist, GEdivTile == "4_1"), aes(x = pvalActual)) +
    geom_histogram(position = "identity", bins = 100, alpha = .9) + ylim(c(0,60)) +
    ggtitle(paste0(focalTreatment," Only, Pregnancy p-values | 0-25% GE"))
  
  plot2 <- ggplot(data = subset(qqHist, GEdivTile == "4_2"), aes(x = pvalActual)) +
    geom_histogram(position = "identity", bins = 100, alpha = .9) + ylim(c(0,60)) +
    ggtitle(paste0(focalTreatment," Only, Pregnancy p-values | 25-50% GE"))
  
  plot3 <- ggplot(data = subset(qqHist, GEdivTile == "4_3"), aes(x = pvalActual)) +
    geom_histogram(position = "identity", bins = 100, alpha = .9) + ylim(c(0,60)) +
    ggtitle(paste0(focalTreatment," Only, Pregnancy p-values | 50-75% GE"))
  
  plot4 <- ggplot(data = subset(qqHist, GEdivTile == "4_4"), aes(x = pvalActual)) +
    geom_histogram(position = "identity", bins = 100, alpha = .9) + ylim(c(0,60)) +
    ggtitle(paste0(focalTreatment," Only, Pregnancy p-values | 75-100% GE"))
  
  plot_grid(plot1,plot2,plot3,plot4)
  
  ggsave(filename = paste0(figqqDir,"/Female_",focalTreatment,"_allBatches__PregnancyPval_HistTile.png"),
         width = 6, height = 4)
}
```


```{r compare trt only betas with trt-ctrl models}
#lps
compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPSonly_10000genes_5lCPM_modelF_basic_emmreml",
            colnameX = "status", Xtitle = "LPSonly",
            emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPS_10000genes_5lCPM_modelF_nested_emmreml",
            colnameY = "TrtxStatus", Ytitle = "LPSCtrl",
            figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)

#gard
compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Gardonly_10000genes_5lCPM_modelG_basic_emmreml",
            colnameX = "status", Xtitle = "Gardonly",
            emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Gard_10000genes_5lCPM_modelG_nested_emmreml",
            colnameY = "TrtxStatus", Ytitle = "GardCtrl",
            figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)

#dex
compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Dexonly_10000genes_5lCPM_modelG_basic_emmreml",
            colnameX = "status", Xtitle = "Dexonly",
            emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Dex_10000genes_5lCPM_modelG_nested_emmreml",
            colnameY = "TrtxStatus", Ytitle = "DexCtrl",
            figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)


#ctrl-LPS
compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_5lCPM_modelF_basic_emmreml",
            colnameX = "status", Xtitle = "Ctrlonly",
            emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPS_10000genes_5lCPM_modelF_nested_emmreml",
            colnameY = "CtrlxStatus", Ytitle = "LPSCtrl",
            figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)

#ctrl-Gard
compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_5lCPM_modelG_basic_emmreml",
            colnameX = "status", Xtitle = "Ctrlonly",
            emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Gard_10000genes_5lCPM_modelG_nested_emmreml",
            colnameY = "CtrlxStatus", Ytitle = "GardCtrl",
            figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)



```


```{r compare trt only betas across models}

rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_5lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

#lps-gard
compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPSonly_10000genes_5lCPM_modelF_basic_emmreml",
            colnameX = "status", Xtitle = "LPSonly",
            emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Gardonly_10000genes_5lCPM_modelG_basic_emmreml",
            colnameY = "status", Ytitle = "Gardonly",
            figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)

#gard-ctrl
compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Gardonly_10000genes_5lCPM_modelG_basic_emmreml",
            colnameX = "status", Xtitle = "Gardonly",
            emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_5lCPM_modelG_basic_emmreml",
            colnameY = "status", Ytitle = "Ctrlonly",
            figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)

#ctrl-LPS
compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_5lCPM_modelF_basic_emmreml",
            colnameX = "status", Xtitle = "Ctrlonly",
            emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPSonly_10000genes_5lCPM_modelF_basic_emmreml",
            colnameY = "status", Ytitle = "LPSonly",
            figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)

#aall-Dex
compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_5lCPM_modelF_basic_emmreml",
            colnameX = "status", Xtitle = "Ctrlonly",
            emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Dexonly_10000genes_5lCPM_modelF_basic_emmreml",
            colnameY = "status", Ytitle = "Dexonly",
            figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)

compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPSonly_10000genes_5lCPM_modelF_basic_emmreml",
            colnameX = "status", Xtitle = "LPSonly",
            emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Dexonly_10000genes_5lCPM_modelF_basic_emmreml",
            colnameY = "status", Ytitle = "Dexonly",
            figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)

compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Gardonly_10000genes_5lCPM_modelG_basic_emmreml",
            colnameX = "status", Xtitle = "Gardonly",
            emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Dexonly_10000genes_5lCPM_modelF_basic_emmreml",
            colnameY = "status", Ytitle = "Dexonly",
            figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)



```

```{r compare pregnancy betas across models}

rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_5lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

varIndex <- c("Ctrl","LPS","Dex","Gard")

for (varA in c("Ctrl","LPS","Dex","Gard")) {
  varAvalue <- which(varIndex == varA)
  for (varB in c("Ctrl","LPS","Dex","Gard")) {
    varBvalue <- which(varIndex == varB)
    if (varAvalue < varBvalue) {
      modelA <- "modelF"
      modelB <- "modelF"
      if (varA %in% c("Dex","Gard")) {
        modelA <- "modelG"
      }

      if (varB %in% c("Dex","Gard")) {
        modelB <- "modelG"
      }
      
      focalVariable <- "preg"
      #lps-ctrl
      compLMMBeta(emremlX = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_basicPreg_emmreml"),
                  colnameX = focalVariable, Xtitle = paste0(varA,"only"),
                  emremlY = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varB,"only_10000genes_5lCPM_",modelB,"_basicPreg_emmreml"),
                  colnameY = focalVariable, Ytitle = paste0(varB,"only"),
                  figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
      
      for (focalVariable in c("DomxPreg","SubxPreg")) {
        compLMMBeta(emremlX = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_nestedPreg_emmreml"),
                    colnameX = focalVariable, Xtitle = paste0(varA,"only"),
                    emremlY = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varB,"only_10000genes_5lCPM_",modelB,"_nestedPreg_emmreml"),
                    colnameY = focalVariable, Ytitle = paste0(varB,"only"),
                    figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
      }
    }
  }
}

rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_5lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

varIndex <- c("Ctrl","LPS","Dex","Gard")

for (varA in c("Ctrl","LPS","Dex","Gard")) {
      modelA <- "modelF"
      if (varA %in% c("Dex","Gard")) {
        modelA <- "modelG"
      }

        mremlResults <- read.table(paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_nestedPreg_emmreml"))
        
        plotR <- cor.test(mremlResults$beta_DomxPreg, mremlResults$beta_SubxPreg)
        ggplot(data = mremlResults, aes(x = beta_DomxPreg, y = beta_SubxPreg)) +
          geom_point(alpha = .25) +
          geom_smooth(method = "lm", formula = "y~x") +
          ggtitle(paste0(varA," Sub:Preg v. Dom:Preg"),
                  subtitle = paste0("R = ",signif(plotR$estimate, digits = 2)))
        
        ggsave(filename = paste0(figDir,"/betaComp/PregByStatus_",varA,"SubPreg_v_DomPreg_betas.png"),
         width = 6, height = 4)
        
        compLMMBeta(emremlX = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_nestedPreg_emmreml"),
                    colnameX = "DomxPreg", Xtitle = paste0(varA,"only"),
                    emremlY = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_nestedPreg_emmreml"),
                    colnameY = "SubxPreg", Ytitle = paste0(varA,"only"),
                    figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25, labelOutlier = TRUE)
}

#compare the two datasets with signal - Dom LPS v Sub Ctrl

varA <- "LPS"
varB <- "Ctrl"
modelA <- modelB <- "modelF"

compLMMBeta(emremlX = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_nestedPreg_emmreml"),
                    colnameX = "DomxPreg", Xtitle = paste0(varA,"only"),
                    emremlY = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varB,"only_10000genes_5lCPM_",modelB,"_nestedPreg_emmreml"),
                    colnameY = "SubxPreg", Ytitle = paste0(varB,"only"),
                    figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
```

```{r compare pregnancy and status betas across models}

rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_5lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

varIndex <- c("Ctrl","LPS","Dex","Gard")

for (varA in c("Ctrl","LPS","Dex","Gard")) {
  varAvalue <- which(varIndex == varA)
  
  for (varB in c("Ctrl","LPS","Dex","Gard")) {
    varBvalue <- which(varIndex == varB)
    
    if (varAvalue == varBvalue) {
      modelA <- "modelF"
      modelB <- "modelF"
      if (varA %in% c("Dex","Gard")) {
        modelA <- "modelG"
      }

      if (varB %in% c("Dex","Gard")) {
        modelB <- "modelG"
      }
      
      focalVariableA <- "status"
      focalVariableB <- "preg"
      #lps-ctrl
      compLMMBeta(emremlX = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_basicPreg_emmreml"),
                  colnameX = focalVariableA, Xtitle = paste0(varA,"only"),
                  emremlY = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varB,"only_10000genes_5lCPM_",modelB,"_basicPreg_emmreml"),
                  colnameY = focalVariableB, Ytitle = paste0(varB,"only"),
                  figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
      
    }
  }
}


#compare the two datasets with signal - Dom LPS v Sub Ctrl

varA <- "LPS"
varB <- "Ctrl"
modelA <- modelB <- "modelF"

compLMMBeta(emremlX = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_nestedPreg_emmreml"),
                    colnameX = "DomxPreg", Xtitle = paste0(varA,"only"),
                    emremlY = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varB,"only_10000genes_5lCPM_",modelB,"_nestedPreg_emmreml"),
                    colnameY = "SubxPreg", Ytitle = paste0(varB,"only"),
                    figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
```

```{r model raw numbers}

for (minLogCPM in c(5)) {
  for (focalSex in c("F")) {
    for (focalTreatment in c("Dex","Gard","LPS","Ctrl")) {
      
      modelName <- "G"
      if (focalTreatment %in% c("LPS","Ctrl")) {
        modelName <- "F"
      }
      
      #treatment only
      gatherSubset <- paste0(batchList,"_",focalSex,"_",focalTreatment,"only_",minGenes,"genes_",minLogCPM,"lCPM")
      
      #allBatches_M_Gard_10000genes_7lCPM_modelG_dfMeta
      dfMeta <- readRDS(paste0(outDir,gatherSubset,"_model",modelName,"_dfMeta.RDS"))
      
      print(focalTreatment)
      
      print(table(paste0(dfMeta$status_dom_sub,"_",dfMeta$pregStatusBackDate)))
      
      dfMetaUnique <- unique(dfMeta[,colnames(dfMeta) %in% c("status_dom_sub","animal_id","pregStatusBackDate")])
      
      print(table(paste0(dfMetaUnique$status_dom_sub,"_",dfMetaUnique$pregStatusBackDate)))
      #runEmreml(workDir = workDir, gatherSubset = gatherSubset, model = modelName, LM = "nestedStatus")
      
      multiSampleNames <- names(table(dfMetaUnique$animal_id))[table(dfMetaUnique$animal_id) > 1]
      multiSample <- dfMetaUnique[dfMetaUnique$animal_id %in% multiSampleNames,]
      
      print(multiSample[order(multiSample$animal_id),])

    }
  }
}

```

```{r compare status and nested status betas across models}

#NonPregxStatus

rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_5lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

varIndex <- c("Ctrl","LPS","Dex","Gard")

for (varA in c("Ctrl","LPS","Dex","Gard")) {
  varAvalue <- which(varIndex == varA)
  
  for (varB in c("Ctrl","LPS","Dex","Gard")) {
    varBvalue <- which(varIndex == varB)
    
    if (varAvalue == varBvalue) {
      modelA <- "modelF"
      modelB <- "modelF"
      if (varA %in% c("Dex","Gard")) {
        modelA <- "modelG"
      }

      if (varB %in% c("Dex","Gard")) {
        modelB <- "modelG"
      }
      
      focalVariableA <- "preg"
      focalVariableB <- "NonPregxStatus"
      #lps-ctrl
      compLMMBeta(emremlX = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_basicPreg_emmreml"),
                  colnameX = focalVariableA, Xtitle = paste0(varA,"only"),
                  emremlY = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varB,"only_10000genes_5lCPM_",modelB,"_nestedStatus_emmreml"),
                  colnameY = focalVariableB, Ytitle = paste0(varB,"only"),
                  figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
      
    }
  }
}

```


```{r compare weight and status betas across models}

rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_5lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

varIndex <- c("Ctrl","LPS","Dex","Gard")
varA <- varB <- "LPS"

for (varA in c("Ctrl","LPS","Dex","Gard")) {
  varAvalue <- which(varIndex == varA)
  
  for (varB in c("Ctrl","LPS","Dex","Gard")) {
    varBvalue <- which(varIndex == varB)
    
    if (varAvalue == varBvalue) {
      #A = status, remove preg effect
      modelA <- "modelP"
      #B = weight, remove status effect
      modelB <- "modelR"
      
      if (varA %in% c("Dex","Gard")) {
        modelA <- "modelQ"
      }

      if (varB %in% c("Dex","Gard")) {
        modelB <- "modelS"
      }
      
      #status v all weight
      focalVariableA <- "status"
      focalVariableB <- "weight"
      compLMMBeta(emremlX = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_basicPreg+Weight_emmreml"),
                  colnameX = focalVariableA, Xtitle = paste0(varA,"only"),
                  emremlY = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varB,"only_10000genes_5lCPM_",modelB,"_basicPreg+Weight_emmreml"),
                  colnameY = focalVariableB, Ytitle = paste0(varB,"only"),
                  figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
      
      #status v dom weight
      focalVariableB <- "weight.dom"
      compLMMBeta(emremlX = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_basicPreg+Weight_emmreml"),
                  colnameX = focalVariableA, Xtitle = paste0(varA,"only"),
                  emremlY = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varB,"only_10000genes_5lCPM_",modelB,"_nestedWeight_emmreml"),
                  colnameY = focalVariableB, Ytitle = paste0(varB,"only"),
                  figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
      
            #status v dom weight
      focalVariableB <- "weight.sub"
      compLMMBeta(emremlX = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_basicPreg+Weight_emmreml"),
                  colnameX = focalVariableA, Xtitle = paste0(varA,"only"),
                  emremlY = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varB,"only_10000genes_5lCPM_",modelB,"_nestedWeight_emmreml"),
                  colnameY = focalVariableB, Ytitle = paste0(varB,"only"),
                  figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
      
      #sub weight v dom weight
      focalVariableA <- "weight.sub"
      focalVariableB <- "weight.dom"
      compLMMBeta(emremlX = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varB,"only_10000genes_5lCPM_",modelB,"_nestedWeight_emmreml"),
                  colnameX = focalVariableA, Xtitle = paste0(varA,"only"),
                  emremlY = paste0("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_",varB,"only_10000genes_5lCPM_",modelB,"_nestedWeight_emmreml"),
                  colnameY = focalVariableB, Ytitle = paste0(varB,"only"),
                  figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
      
    }
  }
}


```


status & weight
```{r correlation between metadata}
allMeta <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_allTrt_10000genes_5lCPM_metadata.RDS")

#unique weights
shortMeta <- unique(allMeta[,colnames(allMeta) %in% c("animal_id","status_dom_sub","avgWeight60d","avgWeight6mo","sex")])

shortMeta$status_dom_sub <- factor(shortMeta$status_dom_sub, levels = c("S","D"))

shortMeta$status01 <- ifelse(shortMeta$status_dom_sub == "S", 0, 1)

ggplot(shortMeta, aes(x = status_dom_sub, y = avgWeight60d)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y~x")

ggplot(shortMeta, aes(x = status01, y = avgWeight60d)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y~x")

cor.test(shortMeta$status01, shortMeta$avgWeight60d)

fMeta <- shortMeta

allMeta <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_M_allTrt_10000genes_5lCPM_metadata.RDS")

#unique weights
shortMeta <- unique(allMeta[,colnames(allMeta) %in% c("animal_id","status_dom_sub","avgWeight60d","avgWeight6mo","sex")])

shortMeta$avgWeight60d <- ifelse(shortMeta$avgWeight60d == 0, shortMeta$avgWeight6mo, shortMeta$avgWeight60d)

shortMeta$status_dom_sub <- factor(shortMeta$status_dom_sub, levels = c("S","D"))

shortMeta$status01 <- ifelse(shortMeta$status_dom_sub == "S", 0, 1)

ggplot(shortMeta, aes(x = status_dom_sub, y = avgWeight60d)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y~x")

ggplot(shortMeta, aes(x = status01, y = avgWeight60d)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y~x")

cor.test(shortMeta$status01, shortMeta$avgWeight60d)

mMeta <- shortMeta

allShortMeta <- rbind.data.frame(fMeta,mMeta)

allShortMeta$sexStatus <- paste0(allShortMeta$sex,"_",allShortMeta$status_dom_sub)

ggplot(allShortMeta, 
       aes(x = sexStatus, 
           y = avgWeight60d,
           fill = sexStatus)) +
  geom_violin()
```


```{r compare preg and nested status betas across MASH}

#NonPregxStatus

rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_5lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

varIndex <- c("Ctrl","LPS","Gard")

for (varA in c("Ctrl","LPS","Gard")) {
  varAvalue <- which(varIndex == varA)
  
  for (varB in c("Ctrl","LPS","Gard")) {
    varBvalue <- which(varIndex == varB)
    
    if (varAvalue == varBvalue) {
      modelA <- "modelF"
      modelB <- "modelF"
      if (varA %in% c("Dex","Gard")) {
        modelA <- "modelG"
      }

      if (varB %in% c("Dex","Gard")) {
        modelB <- "modelG"
      }
      
      focalVariableA <- "preg"
      focalVariableB <- "NonPregxStatus"
      
      #mashR_output_method2_F_5_NonPregxStatus
      mashA <- readRDS(paste0(outDir,"mashR_output_method2_F_5_",focalVariableA,"_noDex"))
      
      mashVars <- colnames(mashA[[1]]$PosteriorMean)
      mashMeans <- mashA[[1]]$PosteriorMean[,which(mashVars == varA)]
      mashLFSR <- mashA[[1]]$lfsr[,which(mashVars == varA)]
      mashFakeVars <- rep(1,length(mashLFSR))
      
      mashDFA <- cbind.data.frame(mashMeans,mashFakeVars,mashLFSR)
      colnames(mashDFA) <- c(paste0("beta_",focalVariableA),
                             paste0("var_beta_",focalVariableA),
                             paste0("pval_",focalVariableA))
      
      #mashR_output_method2_F_5_NonPregxStatus
      mashB <- readRDS(paste0(outDir,"mashR_output_method2_F_5_",focalVariableB,"_noDex"))
      
      mashVars <- colnames(mashB[[1]]$PosteriorMean)
      mashMeans <- mashB[[1]]$PosteriorMean[,which(mashVars == varB)]
      mashLFSR <- mashB[[1]]$lfsr[,which(mashVars == varB)]
      mashFakeVars <- rep(1,length(mashLFSR))
      
      mashDFB <- cbind.data.frame(mashMeans,mashFakeVars,mashLFSR)
      colnames(mashDFB) <- c(paste0("beta_",focalVariableB),
                             paste0("var_beta_",focalVariableB),
                             paste0("pval_",focalVariableB))
      
      #drop outliers
      dropOutliers <- TRUE
      
      if (dropOutliers) {
        mashDFA <- mashDFA[abs(mashDFA[,1]) < .3,]
        mashDFB <- mashDFB[abs(mashDFB[,1]) < .3,]
      }


      
      #test with fake mash
      compLMMBeta(emremlX = mashDFA,
                  colnameX = focalVariableA, Xtitle = paste0(varA,"only"),
                  emremlY = mashDFB,
                  colnameY = focalVariableB, Ytitle = paste0(varB,"only"),
                  figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), 
                  topNpercent = 25, sigThresh = 0.20, mashComp = TRUE)
      
    }
  }
}


ggplot(mashDFA, aes(x = beta_preg, y = -log10(pval_preg), col = pval_preg < .2)) +
  geom_point() +
  ggtitle("Ctrl condition - MASH results ")

ggplot(mashDFB, aes(x = beta_NonPregxStatus, y = -log10(pval_NonPregxStatus), col = pval_NonPregxStatus < .2)) +
  geom_point()

```

```{r compare status sans preg nested status betas across models}

#NonPregxStatus

rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_5lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

varIndex <- c("Ctrl","LPS","Dex","Gard")

for (varA in c("Ctrl","LPS","Dex","Gard")) {
  varAvalue <- which(varIndex == varA)
  
  for (varB in c("Ctrl","LPS","Dex","Gard")) {
    
    varBvalue <- which(varIndex == varB)
    modelA <- "modelR"
    modelApreg <- "modelP"
    modelB <- "modelR"
    modelBpreg <- "modelP"

    if (varA %in% c("Dex","Gard")) {
      modelA <- "modelS"
      modelApreg <- "modelQ"
    }

    if (varB %in% c("Dex","Gard")) {
      modelB <- "modelS"
      modelBpreg <- "modelQ"
    }
    
    focalVariableA <- "preg"
    focalVariableB <- "status"
    
    #within a treatment
    if (varAvalue == varBvalue) {
      #status (no-preg) v preg beta
      compLMMBeta(emremlX = paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_basicPreg_emmreml"),
            colnameX = focalVariableA, Xtitle = paste0(varA,"only"),
            emremlY = paste0(outDir,"allBatches_F_",varB,"only_10000genes_5lCPM_",modelBpreg,"_basicPreg_emmreml"),
            colnameY = focalVariableB, Ytitle = paste0(varB,"only"),
            figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
    }
    
    #across treatments
    if (varAvalue > varBvalue) {
      #status (no-preg) v preg beta
      compLMMBeta(emremlX = paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_basicPreg_emmreml"),
                  colnameX = focalVariableA, Xtitle = paste0(varA,"only"),
                  emremlY = paste0(outDir,"allBatches_F_",varB,"only_10000genes_5lCPM_",modelBpreg,"_basicPreg_emmreml"),
                  colnameY = focalVariableB, Ytitle = paste0(varB,"only"),
                  figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
      
      #preg v preg beta
      compLMMBeta(emremlX = paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_basicPreg_emmreml"),
                  colnameX = focalVariableA, Xtitle = paste0(varA,"only"),
                  emremlY = paste0(outDir,"allBatches_F_",varB,"only_10000genes_5lCPM_",modelB,"_basicPreg_emmreml"),
                  colnameY = focalVariableA, Ytitle = paste0(varB,"only"),
                  figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
      
      #status (no-preg) v status (no-preg) beta
      compLMMBeta(emremlX = paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelApreg,"_basicPreg_emmreml"),
                  colnameX = focalVariableB, Xtitle = paste0(varA,"only"),
                  emremlY = paste0(outDir,"allBatches_F_",varB,"only_10000genes_5lCPM_",modelBpreg,"_basicPreg_emmreml"),
                  colnameY = focalVariableB, Ytitle = paste0(varB,"only"),
                  figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
      
    }
  }
}

```

```{r compare status sans preg nested status betas across top 25 percent models}

dir.create(paste0(figDir,"betaComp7cpm"))

#NonPregxStatus

rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_7lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

varIndex <- c("Ctrl","LPS","Dex","Gard")

for (varA in c("Ctrl","LPS","Dex","Gard")) {
  varAvalue <- which(varIndex == varA)
  
  for (varB in c("Ctrl","LPS","Dex","Gard")) {
    
    varBvalue <- which(varIndex == varB)
    modelA <- "modelR"
    modelApreg <- "modelP"
    modelB <- "modelR"
    modelBpreg <- "modelP"

    if (varA %in% c("Dex","Gard")) {
      modelA <- "modelS"
      modelApreg <- "modelQ"
    }

    if (varB %in% c("Dex","Gard")) {
      modelB <- "modelS"
      modelBpreg <- "modelQ"
    }
    
    focalVariableA <- "preg"
    focalVariableB <- "status"
    
    #within a treatment
    if (varAvalue == varBvalue) {
      #status (no-preg) v preg beta
      compLMMBeta(emremlX = paste0(outDir,"allBatches_F_",varA,"only_10000genes_7lCPM_",modelA,"_basicPreg_emmreml"),
            colnameX = focalVariableA, Xtitle = paste0(varA,"only"),
            emremlY = paste0(outDir,"allBatches_F_",varB,"only_10000genes_7lCPM_",modelBpreg,"_basicPreg_emmreml"),
            colnameY = focalVariableB, Ytitle = paste0(varB,"only"),
            figBetaDir = paste0(figDir,"betaComp7cpm"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
    }
    
    #across treatments
    if (varAvalue > varBvalue) {
      #status (no-preg) v preg beta
      compLMMBeta(emremlX = paste0(outDir,"allBatches_F_",varA,"only_10000genes_7lCPM_",modelA,"_basicPreg_emmreml"),
                  colnameX = focalVariableA, Xtitle = paste0(varA,"only"),
                  emremlY = paste0(outDir,"allBatches_F_",varB,"only_10000genes_7lCPM_",modelBpreg,"_basicPreg_emmreml"),
                  colnameY = focalVariableB, Ytitle = paste0(varB,"only"),
                  figBetaDir = paste0(figDir,"betaComp7cpm"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
      
      #preg v preg beta
      compLMMBeta(emremlX = paste0(outDir,"allBatches_F_",varA,"only_10000genes_7lCPM_",modelA,"_basicPreg_emmreml"),
                  colnameX = focalVariableA, Xtitle = paste0(varA,"only"),
                  emremlY = paste0(outDir,"allBatches_F_",varB,"only_10000genes_7lCPM_",modelB,"_basicPreg_emmreml"),
                  colnameY = focalVariableA, Ytitle = paste0(varB,"only"),
                  figBetaDir = paste0(figDir,"betaComp7cpm"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
      
      #status (no-preg) v status (no-preg) beta
      compLMMBeta(emremlX = paste0(outDir,"allBatches_F_",varA,"only_10000genes_7lCPM_",modelApreg,"_basicPreg_emmreml"),
                  colnameX = focalVariableB, Xtitle = paste0(varA,"only"),
                  emremlY = paste0(outDir,"allBatches_F_",varB,"only_10000genes_7lCPM_",modelBpreg,"_basicPreg_emmreml"),
                  colnameY = focalVariableB, Ytitle = paste0(varB,"only"),
                  figBetaDir = paste0(figDir,"betaComp7cpm"), meanGE = rowMeans(rnaCounts), topNpercent = 25)
      
    }
  }
}

```


plot residuals of genes sig for +Subordinate & +Pregnant
```{r}
varA <- "LPS"
modelA <- "modelF"
modelApreg <- "modelP"

emmremlResultsPreg <- read.table(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_basicPreg_emmreml"))
emmremlResultsStat <- read.table(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelApreg,"_basicPreg_emmreml"))

pregSigList <- rownames(subset(emmremlResultsPreg, pval_preg < .01 & beta_preg > 0))
statusSigList <- rownames(subset(emmremlResultsStat, pval_status < .01 & beta_status < 0))

geneList <- intersect(pregSigList,statusSigList)

residsStatus <- readRDS(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelApreg,"_resids.RDS"))
metaStatus <- readRDS(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelApreg,"_dfMeta.RDS"))
residsPreg <- readRDS(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_resids.RDS"))
metaPreg <- readRDS(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_dfMeta.RDS"))

metaPreg$statusPreg <- paste0(metaPreg$status_dom_sub,"_",metaPreg$pregStatusBackDate35)
metaStatus$statusPreg <- paste0(metaStatus$status_dom_sub,"_",metaStatus$pregStatusBackDate35)


metaPreg$sampleID == colnames(residsPreg)
metaStatus$sampleID == colnames(residsStatus)

gene <- geneList[1]

for (gene in geneList) {
  metaPreg$geneResid <- residsPreg[which(rownames(residsPreg) == gene),]
  metaStatus$geneResid <- residsStatus[which(rownames(residsStatus) == gene),]
  
  p1 <- ggplot(data = metaPreg, aes(x = pregStatusBackDate35, y = geneResid)) +
    geom_violin(draw_quantiles = c(.25,.5,.75)) +
    geom_jitter(alpha = .2, width = .04) +
    ggtitle(paste0(gene," resids by Preg"),
    subtitle = paste0("basic model, ",varA," only"))
  
  p2 <- ggplot(data = metaPreg, aes(x = statusPreg, y = geneResid)) +
    geom_violin(draw_quantiles = c(.25,.5,.75)) +
    geom_jitter(alpha = .2, width = .04) +
    ggtitle(paste0(gene," resids by Status+Preg"),
    subtitle = paste0("basic model, ",varA," only"))
  
  p3 <- ggplot(data = metaStatus, aes(x = status_dom_sub, y = geneResid)) +
    geom_violin(draw_quantiles = c(.25,.5,.75)) +
    geom_jitter(alpha = .2, width = .04) +
    ggtitle(paste0(gene," resids by Status"),
    subtitle =paste0("preg-control model, ",varA," only"))
  
  p4 <- ggplot(data = metaStatus, aes(x = statusPreg, y = geneResid)) +
    geom_violin(draw_quantiles = c(.25,.5,.75)) +
    geom_jitter(alpha = .2, width = .04) +
    ggtitle(paste0(gene," resids by Status+Preg"),
    subtitle = paste0("preg-control model, ",varA," only"))
  
  quadPlot <- plot_grid(p1,p2,p3,p4)
  
  ggsave(plot = quadPlot,
         filename = paste0(figDir,"statusPregResidPlot/",varA,"_",gene,"_statusPreg_resids.png"),
         width = 6, height = 4)

  
}


geneList %in% gene.set$Associated.Gene.Name

subset(gene.set2, Associated.Gene.Name %in% geneList)

```

plot residuals of single animal GE
```{r check the pregnancy response}
geneByGenePlot <- FALSE
pvalThresh <- 0.05

pvalThreshDF <- vector()
geneDirectionDF <- vector()
variableDF <- vector()
trtDF <- vector()
medianTTestDF <- vector()
numGenes <- vector()

for (pvalThresh in c(0.10,0.05,0.01,0.005,0.001)) {

  varA <- "LPS"
  for (varA in c("LPS","Gard","Dex","Ctrl")) {
    
    if (varA %in% c("LPS","Ctrl")) {
      modelA <- "modelR"
      modelApreg <- "modelP"
    } else {
      modelA <- "modelS"
      modelApreg <- "modelQ"
    }
    
    emmremlResultsPreg <- read.table(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_basicPreg_emmreml"))
    emmremlResultsStat <- read.table(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelApreg,"_basicPreg_emmreml"))
    
    pregSigList <- rownames(subset(emmremlResultsPreg, pval_preg < pvalThresh & beta_preg > 0))
    statusSigList <- rownames(subset(emmremlResultsStat, pval_status < pvalThresh & beta_status < 0))
    
    geneList <- intersect(pregSigList,statusSigList)
    
    geneList <- c(geneList,rownames(head(emmremlResultsPreg[order(emmremlResultsPreg$pval_preg),], n = 10)))
    
    residsStatus <- readRDS(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelApreg,"_resids.RDS"))
    metaStatus <- readRDS(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelApreg,"_dfMeta.RDS"))
    residsPreg <- readRDS(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_resids.RDS"))
    metaPreg <- readRDS(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_dfMeta.RDS"))
    
    metaPreg$statusPreg <- paste0(metaPreg$status_dom_sub,"_",metaPreg$pregStatusBackDate35)
    metaStatus$statusPreg <- paste0(metaStatus$status_dom_sub,"_",metaStatus$pregStatusBackDate35)
    
    repeatSamples <- names(table(metaPreg$animal_id)[table(metaPreg$animal_id) > 1])
    
    ### find the repeat animals preg/not-preg
    s <- repeatSamples[1]
    doublePreg <- vector()
    sampleID <- vector()
    pregTF <- vector()
    status <- vector()
    animalID <- vector()
    
    for (s in repeatSamples) {
      print(s)
      if (length(unique(subset(metaPreg, animal_id == s)$pregStatusBackDate35)) > 1) {
        print("duplicate")
        doublePreg <- c(doublePreg,s)
        
        animalMeta <- subset(metaPreg, animal_id == s)
        sampleID <- c(sampleID,animalMeta$sampleID)
        pregTF <- c(pregTF,animalMeta$pregStatusBackDate35)
        status <- c(status,animalMeta$status_dom_sub)
        animalID <- c(animalID,animalMeta$animal_id)
        
      } else {
        print("nope")
      }
    }
    
    pregResample <- cbind.data.frame(sampleID,pregTF,status,animalID)
    
    gene <- geneList[1]
    
    for (gene in geneList) {
      pregResample$geneResid <- 0
      
      for (s in pregResample$sampleID) {
        pregResample$geneResid[which(pregResample$sampleID == s)] <- residsPreg[which(rownames(residsPreg) == gene),
                                                                                which(colnames(residsPreg) == s)]
      }
      
      if (geneByGenePlot) {
        plot <- ggplot(pregResample, aes(x = pregTF, y = geneResid, col = status, group = animalID)) +
          geom_line() +
          geom_point(alpha = 3/4, size = 5) +
          ggtitle(paste0(gene," resids, Repeat Sample Individuals"),
                  subtitle = paste0("basic model, ",varA," only"))
        ggsave(plot = plot,
               filename = paste0(figDir,"resampleResidPlot/",varA,"_",gene,"_Preg_resids_colStatus.png"),
               width = 4, height = 4)
        
        plot <- ggplot(pregResample, aes(x = pregTF, y = geneResid, col = animalID, group = animalID)) +
          geom_line() +
          geom_point(alpha = 3/4, size = 5) +
          ggtitle(paste0(gene," resids, Repeat Sample Individuals"),
                  subtitle = paste0("basic model, ",varA," only"))
        ggsave(plot = plot,
               filename = paste0(figDir,"resampleResidPlot/",varA,"_",gene,"_Preg_resids_colInd.png"),
               width = 4, height = 4)
      }
      
    }
    
    
    ### do the genes that are supposed to "go up" actually go up?
    pregSigUpList <- rownames(subset(emmremlResultsPreg, pval_preg < pvalThresh & beta_preg > 0))
    
    gene <- pregSigUpList[14]
    
    wTestPVal <- vector()
    wTestStat <- vector()
    emmremlStdBeta <- vector()
    emmremlPVal <- vector()
    
    for (gene in pregSigUpList) {
      #get all repeats
      pregResampTTest <- pregResample
      pregResampTTest$geneResid <- 0
      
      #randomly drop replicate re-sampled samples | only want one Preg and one Non-Preg
      for (a in unique(pregResampTTest$animalID)) {
        for (p in c(TRUE,FALSE)) {
          if (sum(pregResampTTest$animalID == a & pregResampTTest$pregTF == p) > 1) {
            #these are the samples that fit the category, just choose one, toss the rest)
            resamps <- length(which(pregResampTTest$animalID == a & pregResampTTest$pregTF == p))
            drop <- sample(which(pregResampTTest$animalID == a & pregResampTTest$pregTF == p), size = resamps - 1, replace = FALSE)
            pregResampTTest <- pregResampTTest[-drop,]
          }
        }
      }
    
      for (s in pregResampTTest$sampleID) {
        pregResampTTest$geneResid[which(pregResampTTest$sampleID == s)] <- residsPreg[which(rownames(residsPreg) == gene),
                                                                                which(colnames(residsPreg) == s)]
      }
      
      wTest <- wilcox.test(subset(pregResampTTest, pregTF == TRUE)$geneResid,
                           subset(pregResampTTest, pregTF == FALSE)$geneResid, paired = TRUE, alternative = "greater")
      
      tTest <- t.test(subset(pregResampTTest, pregTF == TRUE)$geneResid,
                      subset(pregResampTTest, pregTF == FALSE)$geneResid, paired = TRUE, alternative = "greater")
      
      wTestPVal <- c(wTestPVal, wTest$p.value)
      wTestStat <- c(wTestStat, tTest$statistic)
      
      emmremlBeta <- emmremlResultsPreg$beta_preg[rownames(emmremlResultsPreg) == gene]
      emmremlVar <- emmremlResultsPreg$var_beta_preg[rownames(emmremlResultsPreg) == gene]
      
      emmremlStdBeta <- c(emmremlStdBeta, emmremlBeta / sqrt(emmremlVar))
      
      emmremlPVal <- c(emmremlPVal,emmremlResultsPreg$pval_preg[rownames(emmremlResultsPreg) == gene])
    
      # ggplot(pregResampTTest, aes(x = pregTF, y = geneResid, col = animalID, group = animalID)) +
      #   geom_line() +
      #   geom_point(alpha = 3/4, size = 5) +
      #   ggtitle(paste0(gene," resids, Repeat Sample Individuals"),
      #           subtitle = paste0("basic model, ",varA," only"))
    
    }
    
    ggplot() +
      geom_vline(xintercept = 0, col = "black") +
      geom_histogram(aes(x = wTestStat), fill = "red", alpha = .5, binwidth = .25) +
      geom_vline(xintercept = mean(wTestStat), col = "red") +
      xlab("Paired T-Test Statistic") +
      ggtitle("Genes Significantly Up-Regulated in Pregnancy")
    ggsave(filename = paste0(figDir,varA,"_Preg_UpReg_TTestStats_",pvalThresh,".png"),
           width = 6, height = 4)
    
    pvalThreshDF <- c(pvalThreshDF,pvalThresh)
    geneDirectionDF <- c(geneDirectionDF,"up")
    trtDF <- c(trtDF,varA)
    medianTTestDF <- c(medianTTestDF,median(wTestStat))
    variableDF <- c(variableDF,"Preg")
    numGenes <- c(numGenes,length(pregSigUpList))

    
    
    pregSigDownList <- rownames(subset(emmremlResultsPreg, pval_preg < pvalThresh & beta_preg < 0))
    
    wTestPVal <- vector()
    wTestStat <- vector()
    emmremlStdBeta <- vector()
    emmremlPVal <- vector()
    
    for (gene in pregSigDownList) {
      #get all repeats
      pregResampTTest <- pregResample
      pregResampTTest$geneResid <- 0
      
      #randomly drop replicate re-sampled samples | only want one Preg and one Non-Preg
      for (a in unique(pregResampTTest$animalID)) {
        for (p in c(TRUE,FALSE)) {
          if (sum(pregResampTTest$animalID == a & pregResampTTest$pregTF == p) > 1) {
            #these are the samples that fit the category, just choose one, toss the rest)
            resamps <- length(which(pregResampTTest$animalID == a & pregResampTTest$pregTF == p))
            drop <- sample(which(pregResampTTest$animalID == a & pregResampTTest$pregTF == p), size = resamps - 1, replace = FALSE)
            pregResampTTest <- pregResampTTest[-drop,]
          }
        }
      }
    
      for (s in pregResampTTest$sampleID) {
        pregResampTTest$geneResid[which(pregResampTTest$sampleID == s)] <- residsPreg[which(rownames(residsPreg) == gene),
                                                                                which(colnames(residsPreg) == s)]
      }
      
      wTest <- wilcox.test(subset(pregResampTTest, pregTF == TRUE)$geneResid,
                           subset(pregResampTTest, pregTF == FALSE)$geneResid, paired = TRUE, alternative = "less")
      
      tTest <- t.test(subset(pregResampTTest, pregTF == TRUE)$geneResid,
                      subset(pregResampTTest, pregTF == FALSE)$geneResid, paired = TRUE, alternative = "less")
      
      wTestPVal <- c(wTestPVal, wTest$p.value)
      wTestStat <- c(wTestStat, tTest$statistic)
      
      emmremlBeta <- emmremlResultsPreg$beta_preg[rownames(emmremlResultsPreg) == gene]
      emmremlVar <- emmremlResultsPreg$var_beta_preg[rownames(emmremlResultsPreg) == gene]
      
      emmremlStdBeta <- c(emmremlStdBeta, emmremlBeta / sqrt(emmremlVar))
      
      emmremlPVal <- c(emmremlPVal,emmremlResultsPreg$pval_preg[rownames(emmremlResultsPreg) == gene])
    
      # ggplot(pregResampTTest, aes(x = pregTF, y = geneResid, col = animalID, group = animalID)) +
      #   geom_line() +
      #   geom_point(alpha = 3/4, size = 5) +
      #   ggtitle(paste0(gene," resids, Repeat Sample Individuals"),
      #           subtitle = paste0("basic model, ",varA," only"))
    
    }
    
    ggplot() +
      geom_vline(xintercept = 0, col = "black") +
      geom_histogram(aes(x = wTestStat), fill = "red", alpha = .5, binwidth = .25) +
      geom_vline(xintercept = mean(wTestStat), col = "red") +
      xlab("Paired T-Test Statistic") +
      ggtitle("Genes Significantly Down-Regulated in Pregnancy")
    ggsave(filename = paste0(figDir,varA,"_Pre_DownReg_TTestStats_",pvalThresh,".png"),
           width = 6, height = 4)
    
    pvalThreshDF <- c(pvalThreshDF,pvalThresh)
    geneDirectionDF <- c(geneDirectionDF,"down")
    trtDF <- c(trtDF,varA)
    medianTTestDF <- c(medianTTestDF,median(wTestStat))
    variableDF <- c(variableDF,"Preg")
    numGenes <- c(numGenes,length(pregSigDownList))

    
    #### SAME BUT FOR STATUS
    
    metaPreg$statusPreg <- paste0(metaPreg$status_dom_sub,"_",metaPreg$pregStatusBackDate35)
    metaStatus$statusPreg <- paste0(metaStatus$status_dom_sub,"_",metaStatus$pregStatusBackDate35)
    
    repeatSamples <- names(table(metaPreg$animal_id)[table(metaPreg$animal_id) > 1])
    
    ### find the repeat animals preg/not-preg
    s <- repeatSamples[1]
    doubleStatus <- vector()
    sampleID <- vector()
    pregTF <- vector()
    status <- vector()
    animalID <- vector()
    
    for (s in repeatSamples) {
      print(s)
      if (length(unique(subset(metaStatus, animal_id == s)$status_dom_sub)) > 1) {
        print("duplicate")
        doubleStatus <- c(doubleStatus,s)
        
        animalMeta <- subset(metaStatus, animal_id == s)
        sampleID <- c(sampleID,animalMeta$sampleID)
        pregTF <- c(pregTF,animalMeta$pregStatusBackDate35)
        status <- c(status,animalMeta$status_dom_sub)
        animalID <- c(animalID,animalMeta$animal_id)
        
      } else {
        print("nope")
      }
    }
    
    statusResample <- cbind.data.frame(sampleID,pregTF,status,animalID)
    
    
    
    statusSigUpList <- rownames(subset(emmremlResultsStat, pval_status < pvalThresh & beta_status > 0))
    
    wTestPVal <- vector()
    wTestStat <- vector()
    emmremlStdBeta <- vector()
    emmremlPVal <- vector()
    
    gene <- statusSigUpList[1]
    
    for (gene in statusSigUpList) {
      #get all repeats
      statusResampTTest <- statusResample
      statusResampTTest$geneResid <- 0
      
      #randomly drop replicate re-sampled samples | only want one Preg and one Non-Preg
      for (a in unique(statusResampTTest$animalID)) {
        for (p in c("S","D")) {
          if (sum(statusResampTTest$animalID == a & statusResampTTest$status == p) > 1) {
            #these are the samples that fit the category, just choose one, toss the rest)
            resamps <- length(which(statusResampTTest$animalID == a & statusResampTTest$status == p))
            drop <- sample(which(statusResampTTest$animalID == a & statusResampTTest$status == p), size = resamps - 1, replace = FALSE)
            statusResampTTest <- statusResampTTest[-drop,]
          }
        }
      }
    
      for (s in statusResampTTest$sampleID) {
        statusResampTTest$geneResid[which(statusResampTTest$sampleID == s)] <- residsPreg[which(rownames(residsStatus) == gene),
                                                                                which(colnames(residsStatus) == s)]
      }
      
      wTest <- wilcox.test(subset(statusResampTTest, status == "D")$geneResid,
                           subset(statusResampTTest, status == "S")$geneResid, paired = TRUE, alternative = "greater")
      
      tTest <- t.test(subset(statusResampTTest, status == "D")$geneResid,
                      subset(statusResampTTest, status == "S")$geneResid, paired = TRUE, alternative = "greater")
      
      wTestPVal <- c(wTestPVal, wTest$p.value)
      wTestStat <- c(wTestStat, tTest$statistic)
      
      emmremlBeta <- emmremlResultsStat$beta_status[rownames(emmremlResultsStat) == gene]
      emmremlVar <- emmremlResultsStat$var_beta_status[rownames(emmremlResultsStat) == gene]
      
      emmremlStdBeta <- c(emmremlStdBeta, emmremlBeta / sqrt(emmremlVar))
      
      emmremlPVal <- c(emmremlPVal,emmremlResultsStat$pval_status[rownames(emmremlResultsStat) == gene])
    
      # ggplot(statusResampTTest, aes(x = status, y = geneResid, col = animalID, group = animalID)) +
      #   geom_line() +
      #   geom_point(alpha = 3/4, size = 5) +
      #   ggtitle(paste0(gene," resids, Repeat Sample Individuals"),
      #           subtitle = paste0("basic model, ",varA," only"))
    
    }
    
    ggplot() +
      geom_vline(xintercept = 0, col = "black") +
      geom_histogram(aes(x = wTestStat), fill = "red", alpha = .5, binwidth = .25) +
      geom_vline(xintercept = mean(wTestStat), col = "red") +
      xlab("Paired T-Test Statistic") +
      ggtitle("Genes Significantly Up-Regulated in Status")
    ggsave(filename = paste0(figDir,varA,"_Status_UpReg_TTestStats_",pvalThresh,".png"),
           width = 6, height = 4)
    
    pvalThreshDF <- c(pvalThreshDF,pvalThresh)
    geneDirectionDF <- c(geneDirectionDF,"up")
    trtDF <- c(trtDF,varA)
    medianTTestDF <- c(medianTTestDF,median(wTestStat))
    variableDF <- c(variableDF,"Status")
    numGenes <- c(numGenes,length(statusSigUpList))

    
    statusSigDownList <- rownames(subset(emmremlResultsStat, pval_status < pvalThresh & beta_status < 0))
    
    wTestPVal <- vector()
    wTestStat <- vector()
    emmremlStdBeta <- vector()
    emmremlPVal <- vector()
    
    gene <- statusSigDownList[14]
    
    for (gene in statusSigDownList) {
      #get all repeats
      statusResampTTest <- statusResample
      statusResampTTest$geneResid <- 0
      
      #randomly drop replicate re-sampled samples | only want one Preg and one Non-Preg
      for (a in unique(statusResampTTest$animalID)) {
        for (p in c("S","D")) {
          if (sum(statusResampTTest$animalID == a & statusResampTTest$status == p) > 1) {
            #these are the samples that fit the category, just choose one, toss the rest)
            resamps <- length(which(statusResampTTest$animalID == a & statusResampTTest$status == p))
            drop <- sample(which(statusResampTTest$animalID == a & statusResampTTest$status == p), size = resamps - 1, replace = FALSE)
            statusResampTTest <- statusResampTTest[-drop,]
          }
        }
      }
    
      for (s in statusResampTTest$sampleID) {
        statusResampTTest$geneResid[which(statusResampTTest$sampleID == s)] <- residsPreg[which(rownames(residsStatus) == gene),
                                                                                which(colnames(residsStatus) == s)]
      }
      
      wTest <- wilcox.test(subset(statusResampTTest, status == "D")$geneResid,
                           subset(statusResampTTest, status == "S")$geneResid, paired = TRUE, alternative = "less")
      
      tTest <- t.test(subset(statusResampTTest, status == "D")$geneResid,
                      subset(statusResampTTest, status == "S")$geneResid, paired = TRUE, alternative = "less")
      
      wTestPVal <- c(wTestPVal, wTest$p.value)
      wTestStat <- c(wTestStat, tTest$statistic)
      
      emmremlBeta <- emmremlResultsStat$beta_status[rownames(emmremlResultsStat) == gene]
      emmremlVar <- emmremlResultsStat$var_beta_status[rownames(emmremlResultsStat) == gene]
      
      emmremlStdBeta <- c(emmremlStdBeta, emmremlBeta / sqrt(emmremlVar))
      
      emmremlPVal <- c(emmremlPVal,emmremlResultsStat$pval_status[rownames(emmremlResultsStat) == gene])
    
      # ggplot(statusResampTTest, aes(x = status, y = geneResid, col = animalID, group = animalID)) +
      #   geom_line() +
      #   geom_point(alpha = 3/4, size = 5) +
      #   ggtitle(paste0(gene," resids, Repeat Sample Individuals"),
      #           subtitle = paste0("basic model, ",varA," only"))
      # 
      # ggplot() +
      #   geom_violin(aes(y = residsStatus[rownames(residsStatus) == gene,], x = metaStatus$status_dom_sub), draw_quantiles = c(.25,.5,.75)) +
      #   geom_jitter(aes(y = residsStatus[rownames(residsStatus) == gene,], x = metaStatus$status_dom_sub), width = .05)
    }
    
    ggplot() +
      geom_vline(xintercept = 0, col = "black") +
      geom_histogram(aes(x = wTestStat), fill = "red", alpha = .5, binwidth = .25) +
      geom_vline(xintercept = mean(wTestStat), col = "red") +
      xlab("Paired T-Test Statistic") +
      ggtitle("Genes Significantly Down-Regulated in Status")
    ggsave(filename = paste0(figDir,varA,"_Status_DownReg_TTestStats_",pvalThresh,".png"),
           width = 6, height = 4)
    
    pvalThreshDF <- c(pvalThreshDF,pvalThresh)
    geneDirectionDF <- c(geneDirectionDF,"down")
    trtDF <- c(trtDF,varA)
    medianTTestDF <- c(medianTTestDF,median(wTestStat))
    variableDF <- c(variableDF,"Status")
    numGenes <- c(numGenes,length(statusSigDownList))

  }
}

ttestResults <- cbind.data.frame(pvalThreshDF,geneDirectionDF,trtDF,medianTTestDF,variableDF,numGenes)

basePlot <- ggplot(data = ttestResults, aes(x = -log10(pvalThreshDF), 
                                y = medianTTestDF,
                                group = paste0(geneDirectionDF,"-",variableDF),
                                col = paste0(geneDirectionDF,"-",variableDF))) +
  geom_point(size = 3) + xlab("-log10(pvalue threshold)") + ylab("Median T-Test Stat") +
  labs(col = "direction-\nvariable") +
  ggtitle("Meerkat Variable Re-Sampling T-test",
          subtitle = "by Direction, Variable, and p-value")
ggsave(plot = basePlot,
       filename = paste0(figDir,"All_medianTTestStats.png"),
       width = 6, height = 4)

numPlot <- basePlot + geom_text_repel(aes(label = numGenes))
ggsave(plot = numPlot,
       filename = paste0(figDir,"All_medianTTestStats_nums.png"),
       width = 6, height = 4)

basePlot <- ggplot(data = subset(ttestResults, variableDF == "Status"), 
       aes(x = -log10(pvalThreshDF),
            y = medianTTestDF,
            col = paste0(trtDF),
           shape = geneDirectionDF)) +
  geom_hline(yintercept = 0, col = "grey40")+
  geom_point(size = 3) + xlab("-log10(pvalue threshold)") + ylab("Median T-Test Stat") +
  labs(col = "treatment",
       shape = "direction") +
  ggtitle("Meerkat Status Re-Sampling T-test",
          subtitle = "by Direction, Treatment, and p-value")
ggsave(plot = basePlot,
       filename = paste0(figDir,"Status_medianTTestStats.png"),
           width = 6, height = 4)
numPlot <- basePlot + geom_text_repel(aes(label = numGenes))
ggsave(plot = numPlot,
       filename = paste0(figDir,"Status_medianTTestStats_nums.png"),
       width = 6, height = 4)

basePlot <- ggplot(data = subset(ttestResults, variableDF == "Preg"), 
       aes(x = -log10(pvalThreshDF),
            y = medianTTestDF,
            col = paste0(trtDF),
           shape = geneDirectionDF)) +
  geom_hline(yintercept = 0, col = "grey40")+
  geom_point(size = 3) + xlab("-log10(pvalue threshold)") + ylab("Median T-Test Stat") +
  labs(col = "treatment",
       shape = "direction") +
  ggtitle("Meerkat Pregnancy Re-Sampling T-test",
          subtitle = "by Direction, Treatment, and p-value")
ggsave(plot = basePlot,
       filename = paste0(figDir,"Preg_medianTTestStats.png"),
           width = 6, height = 4)
numPlot <- basePlot + geom_text_repel(aes(label = numGenes))
ggsave(plot = numPlot,
       filename = paste0(figDir,"Preg_medianTTestStats_nums.png"),
       width = 6, height = 4)


```

dom sub repeat
```{r}

### find the repeat animals dom-sub
s <- repeatSamples[14]
doubleStatus <- vector()
for (s in repeatSamples) {
  print(s)
  if (length(unique(subset(metaStatus, animal_id == s)$status_dom_sub)) > 1) {
    print("duplicate")
    doubleStatus <- c(doubleStatus,s)
  } else {
    print("nope")
  }
}


```

when a single animal was sampled in and outside of preg/status, does their resampling confirm overall findings?
```{r check status and preg change in resampled animals}
geneByGenePlot <- FALSE
pvalThresh <- 0.05
varA <- "LPS"

pvalThreshDF <- vector()
geneDirectionDF <- vector()
variableDF <- vector()
trtDF <- vector()
medianTTestDF <- vector()
numGenes <- vector()

for (pvalThresh in c(0.10,0.05,0.01,0.005,0.001)) {

  #varA <- "LPS"
  for (varA in c("LPS","Gard","Dex","Ctrl")) {
    
    if (varA %in% c("LPS","Ctrl")) {
      modelA <- "modelF"
      modelApreg <- "modelR"
      modelAstat <- "modelP"
    } else {
      modelA <- "modelG"
      modelApreg <- "modelS"
      modelAstat <- "modelQ"
    }
    
    #emmremlResultsPreg <- read.table(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_basicPreg_emmreml"))
    #emmremlResultsStat <- read.table(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelApreg,"_basicPreg_emmreml"))
    
    emmremlResultsPreg <- read.table(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelApreg,"_basicPreg_emmreml"))
    emmremlResultsStat <- read.table(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelAstat,"_basicPreg_emmreml"))

    
    pregSigList <- rownames(subset(emmremlResultsPreg, pval_preg < pvalThresh & beta_preg > 0))
    statusSigList <- rownames(subset(emmremlResultsStat, pval_status < pvalThresh & beta_status < 0))
    
    geneList <- intersect(pregSigList,statusSigList)
    
    geneList <- c(geneList,rownames(head(emmremlResultsPreg[order(emmremlResultsPreg$pval_preg),], n = 10)))

    residsStatus <- readRDS(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelAstat,"_resids.RDS"))
    metaStatus <- readRDS(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelAstat,"_dfMeta.RDS"))
    residsPreg <- readRDS(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelApreg,"_resids.RDS"))
    metaPreg <- readRDS(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelApreg,"_dfMeta.RDS"))
    
    #residsStatus <- readRDS(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelApreg,"_resids.RDS"))
    #metaStatus <- readRDS(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelApreg,"_dfMeta.RDS"))
    #residsPreg <- readRDS(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_resids.RDS"))
    #metaPreg <- readRDS(paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_dfMeta.RDS"))
    
    metaPreg$preg <- ifelse(metaPreg$pregLact == "preg", TRUE, FALSE)
    metaStatus$preg <- ifelse(metaStatus$pregLact == "preg", TRUE, FALSE)
    
    metaPreg$statusPreg <- paste0(metaPreg$status_dom_sub,"_",metaPreg$preg)
    metaStatus$statusPreg <- paste0(metaStatus$status_dom_sub,"_",metaStatus$preg)
    
    repeatSamples <- names(table(metaPreg$animal_id)[table(metaPreg$animal_id) > 1])
    
    ### find the repeat animals preg/not-preg
    s <- repeatSamples[1]
    doublePreg <- vector()
    sampleID <- vector()
    pregTF <- vector()
    status <- vector()
    animalID <- vector()
    
    for (s in repeatSamples) {
      print(s)
      if (length(unique(subset(metaPreg, animal_id == s)$pregStatusBackDate35)) > 1) {
        print("duplicate")
        doublePreg <- c(doublePreg,s)
        
        animalMeta <- subset(metaPreg, animal_id == s)
        sampleID <- c(sampleID,animalMeta$sampleID)
        pregTF <- c(pregTF,animalMeta$pregStatusBackDate35)
        status <- c(status,animalMeta$status_dom_sub)
        animalID <- c(animalID,animalMeta$animal_id)
        
      } else {
        print("nope")
      }
    }
    
    pregResample <- cbind.data.frame(sampleID,pregTF,status,animalID)
    
    ### remove samples where status is mis-matched
    statusMismatch <- c("SSUR1474","SSUR1605","SSUR1781","SSUR2229","SSUR1249","SSUR0749")
    pregResample <- pregResample[!pregResample$sampleID %in% statusMismatch,]
    
    gene <- geneList[1]
    
    for (gene in geneList) {
      pregResample$geneResid <- 0
      
      for (s in pregResample$sampleID) {
        pregResample$geneResid[which(pregResample$sampleID == s)] <- residsPreg[which(rownames(residsPreg) == gene),
                                                                                which(colnames(residsPreg) == s)]
      }
      
      if (geneByGenePlot) {
        plot <- ggplot(pregResample, aes(x = pregTF, y = geneResid, col = status, group = animalID)) +
          geom_line() +
          geom_point(alpha = 3/4, size = 5) +
          ggtitle(paste0(gene," resids, Repeat Sample Individuals"),
                  subtitle = paste0("basic model, ",varA," only"))
        ggsave(plot = plot,
               filename = paste0(figDir,"resampleResidPlot/",varA,"_",gene,"_Preg_resids_colStatus.png"),
               width = 4, height = 4)
        
        plot <- ggplot(pregResample, aes(x = pregTF, y = geneResid, col = animalID, group = animalID)) +
          geom_line() +
          geom_point(alpha = 3/4, size = 5) +
          ggtitle(paste0(gene," resids, Repeat Sample Individuals"),
                  subtitle = paste0("basic model, ",varA," only"))
        ggsave(plot = plot,
               filename = paste0(figDir,"resampleResidPlot/",varA,"_",gene,"_Preg_resids_colInd.png"),
               width = 4, height = 4)
      }
      
    }
    
    
    ### do the genes that are supposed to "go up" actually go up?
    pregSigUpList <- rownames(subset(emmremlResultsPreg, pval_preg < pvalThresh & beta_preg > 0))
    
    gene <- pregSigUpList[14]
    
    wTestPVal <- vector()
    wTestStat <- vector()
    emmremlStdBeta <- vector()
    emmremlPVal <- vector()
    
    #vectors for gene by gene line plot
    geneNamePlot <- vector()
    pregCat <- vector()
    meanGeneExp <- vector()
    medGeneExp <- vector()
    linePlotPval <- vector()

    
    for (gene in pregSigUpList) {
      #get all repeats
      pregResampTTest <- pregResample
      pregResampTTest$geneResid <- 0
      
      #randomly drop replicate re-sampled samples | only want one Preg and one Non-Preg
      for (a in unique(pregResampTTest$animalID)) {
        for (p in c(TRUE,FALSE)) {
          if (sum(pregResampTTest$animalID == a & pregResampTTest$pregTF == p) > 1) {
            #these are the samples that fit the category, just choose one, toss the rest)
            resamps <- length(which(pregResampTTest$animalID == a & pregResampTTest$pregTF == p))
            drop <- sample(which(pregResampTTest$animalID == a & pregResampTTest$pregTF == p), size = resamps - 1, replace = FALSE)
            pregResampTTest <- pregResampTTest[-drop,]
          }
        }
      }
    
      for (s in pregResampTTest$sampleID) {
        pregResampTTest$geneResid[which(pregResampTTest$sampleID == s)] <- residsPreg[which(rownames(residsPreg) == gene),
                                                                                which(colnames(residsPreg) == s)]
      }
      
      geneNamePlot <- c(geneNamePlot,gene,gene)
      
      pregCat <- c(pregCat,TRUE)
      meanGeneExp <- c(meanGeneExp,mean(subset(pregResampTTest, pregTF == TRUE)$geneResid))
      medGeneExp <- c(medGeneExp,median(subset(pregResampTTest, pregTF == TRUE)$geneResid))
      
      pregCat <- c(pregCat,FALSE)
      meanGeneExp <- c(meanGeneExp,mean(subset(pregResampTTest, pregTF == FALSE)$geneResid))
      medGeneExp <- c(medGeneExp,median(subset(pregResampTTest, pregTF == FALSE)$geneResid))

      wTest <- wilcox.test(subset(pregResampTTest, pregTF == TRUE)$geneResid,
                           subset(pregResampTTest, pregTF == FALSE)$geneResid, paired = TRUE, alternative = "greater")
      
      tTest <- t.test(subset(pregResampTTest, pregTF == TRUE)$geneResid,
                      subset(pregResampTTest, pregTF == FALSE)$geneResid, paired = TRUE, alternative = "greater")
      
      wTestPVal <- c(wTestPVal, wTest$p.value)
      wTestStat <- c(wTestStat, tTest$statistic)
      
      linePlotPval <- c(linePlotPval, wTest$p.value, wTest$p.value)
      
      emmremlBeta <- emmremlResultsPreg$beta_preg[rownames(emmremlResultsPreg) == gene]
      emmremlVar <- emmremlResultsPreg$var_beta_preg[rownames(emmremlResultsPreg) == gene]
      
      emmremlStdBeta <- c(emmremlStdBeta, emmremlBeta / sqrt(emmremlVar))
      
      emmremlPVal <- c(emmremlPVal,emmremlResultsPreg$pval_preg[rownames(emmremlResultsPreg) == gene])
    
      # ggplot(pregResampTTest, aes(x = pregTF, y = geneResid, col = animalID, group = animalID)) +
      #   geom_line() +
      #   geom_point(alpha = 3/4, size = 5) +
      #   ggtitle(paste0(gene," resids, Repeat Sample Individuals"),
      #           subtitle = paste0("basic model, ",varA," only"))
    
    }
    
    medGEplot <- cbind.data.frame(geneNamePlot,pregCat,meanGeneExp,medGeneExp,linePlotPval)
    
    medGEplot$pregCat <- factor(medGEplot$pregCat, levels = c(FALSE,TRUE))
    medGEplot$ttSig <- ifelse(medGEplot$linePlotPval < .05, TRUE, FALSE)
    
    ggplot(data = medGEplot,
           aes(x = pregCat,
               y = meanGeneExp,
               group = geneNamePlot)) +
      geom_line(linewidth = .05) +
      xlab("Pregnant") + ylab("Mean Residual GE") +
      ggtitle("Genes Significantly Up-Regulated in Pregnancy",
              subtitle = paste0("Trt:",varA," | p-value < ",pvalThresh))
    ggsave(filename = paste0(figDir,varA,"_Preg_UpReg_linePlot_",pvalThresh,"_ctrlStatus.png"),
           width = 6, height = 4)
    
    #accompanying hist
    vCutoff <- min(subset(emmremlResultsPreg, pval_preg < pvalThresh & beta_preg > 0)$beta_preg)
    
    ggplot() +
      geom_histogram(aes(x = emmremlResultsPreg$beta_preg), fill = "gray30", binwidth = .10) +
      geom_vline(xintercept = vCutoff, col = "dodgerblue", linewidth = 2) +
      xlab("Pregnancy Betas")
    ggsave(filename = paste0(figDir,varA,"_Preg_UpReg_betaHist_",pvalThresh,"_ctrlStatus.png"),
           width = 6, height = 4)
    
    ggplot() +
      geom_vline(xintercept = 0, col = "black") +
      geom_histogram(aes(x = wTestStat), fill = "red", alpha = .5, binwidth = .25) +
      geom_vline(xintercept = mean(wTestStat), col = "red") +
      xlab("Paired T-Test Statistic") +
      ggtitle("Genes Significantly Up-Regulated in Pregnancy")
    ggsave(filename = paste0(figDir,varA,"_Preg_UpReg_TTestStats_",pvalThresh,"_ctrlStatus.png"),
           width = 6, height = 4)
    
    pvalThreshDF <- c(pvalThreshDF,pvalThresh)
    geneDirectionDF <- c(geneDirectionDF,"up")
    trtDF <- c(trtDF,varA)
    medianTTestDF <- c(medianTTestDF,median(wTestStat))
    variableDF <- c(variableDF,"Preg")
    numGenes <- c(numGenes,length(pregSigUpList))

    
    
    pregSigDownList <- rownames(subset(emmremlResultsPreg, pval_preg < pvalThresh & beta_preg < 0))
    
    wTestPVal <- vector()
    wTestStat <- vector()
    emmremlStdBeta <- vector()
    emmremlPVal <- vector()
    
    #vectors for gene by gene line plot
    geneNamePlot <- vector()
    pregCat <- vector()
    meanGeneExp <- vector()
    medGeneExp <- vector()
    linePlotPval <- vector()

    
    for (gene in pregSigDownList) {
      #get all repeats
      pregResampTTest <- pregResample
      pregResampTTest$geneResid <- 0
      
      #randomly drop replicate re-sampled samples | only want one Preg and one Non-Preg
      for (a in unique(pregResampTTest$animalID)) {
        for (p in c(TRUE,FALSE)) {
          if (sum(pregResampTTest$animalID == a & pregResampTTest$pregTF == p) > 1) {
            #these are the samples that fit the category, just choose one, toss the rest)
            resamps <- length(which(pregResampTTest$animalID == a & pregResampTTest$pregTF == p))
            drop <- sample(which(pregResampTTest$animalID == a & pregResampTTest$pregTF == p), size = resamps - 1, replace = FALSE)
            pregResampTTest <- pregResampTTest[-drop,]
          }
        }
      }
    
      for (s in pregResampTTest$sampleID) {
        pregResampTTest$geneResid[which(pregResampTTest$sampleID == s)] <- residsPreg[which(rownames(residsPreg) == gene),
                                                                                which(colnames(residsPreg) == s)]
      }
      
      geneNamePlot <- c(geneNamePlot,gene,gene)
      
      pregCat <- c(pregCat,TRUE)
      meanGeneExp <- c(meanGeneExp,mean(subset(pregResampTTest, pregTF == TRUE)$geneResid))
      medGeneExp <- c(medGeneExp,median(subset(pregResampTTest, pregTF == TRUE)$geneResid))
      
      pregCat <- c(pregCat,FALSE)
      meanGeneExp <- c(meanGeneExp,mean(subset(pregResampTTest, pregTF == FALSE)$geneResid))
      medGeneExp <- c(medGeneExp,median(subset(pregResampTTest, pregTF == FALSE)$geneResid))

      
      wTest <- wilcox.test(subset(pregResampTTest, pregTF == TRUE)$geneResid,
                           subset(pregResampTTest, pregTF == FALSE)$geneResid, paired = TRUE, alternative = "less")
      
      tTest <- t.test(subset(pregResampTTest, pregTF == TRUE)$geneResid,
                      subset(pregResampTTest, pregTF == FALSE)$geneResid, paired = TRUE, alternative = "less")
      
      wTestPVal <- c(wTestPVal, wTest$p.value)
      wTestStat <- c(wTestStat, tTest$statistic)
      
      linePlotPval <- c(linePlotPval, wTest$p.value, wTest$p.value)
      
      emmremlBeta <- emmremlResultsPreg$beta_preg[rownames(emmremlResultsPreg) == gene]
      emmremlVar <- emmremlResultsPreg$var_beta_preg[rownames(emmremlResultsPreg) == gene]
      
      emmremlStdBeta <- c(emmremlStdBeta, emmremlBeta / sqrt(emmremlVar))
      
      emmremlPVal <- c(emmremlPVal,emmremlResultsPreg$pval_preg[rownames(emmremlResultsPreg) == gene])
    
      # ggplot(pregResampTTest, aes(x = pregTF, y = geneResid, col = animalID, group = animalID)) +
      #   geom_line() +
      #   geom_point(alpha = 3/4, size = 5) +
      #   ggtitle(paste0(gene," resids, Repeat Sample Individuals"),
      #           subtitle = paste0("basic model, ",varA," only"))
    
    }
    
    medGEplot <- cbind.data.frame(geneNamePlot,pregCat,meanGeneExp,medGeneExp,linePlotPval)
    
    medGEplot$pregCat <- factor(medGEplot$pregCat, levels = c(FALSE,TRUE))
    medGEplot$ttSig <- ifelse(medGEplot$linePlotPval < .05, TRUE, FALSE)
    
    ggplot(data = medGEplot,
           aes(x = pregCat,
               y = meanGeneExp,
               group = geneNamePlot)) +
      geom_line(linewidth = .05) +
      xlab("Pregnant") + ylab("Mean Residual GE") +
      ggtitle("Genes Significantly Down-Regulated in Pregnancy",
              subtitle = paste0("Trt:",varA," | p-value < ",pvalThresh))
    ggsave(filename = paste0(figDir,varA,"_Preg_DownReg_linePlot_",pvalThresh,"_ctrlStatus.png"),
           width = 6, height = 4)

    #accompanying hist
    vCutoff <- max(subset(emmremlResultsPreg, pval_preg < pvalThresh & beta_preg < 0)$beta_preg)
    
    ggplot() +
      geom_histogram(aes(x = emmremlResultsPreg$beta_preg), fill = "gray30", binwidth = .10) +
      geom_vline(xintercept = vCutoff, col = "dodgerblue", linewidth = 2) +
      xlab("Pregnancy Betas")
    ggsave(filename = paste0(figDir,varA,"_Preg_DownReg_betaHist_",pvalThresh,"_ctrlStatus.png"),
           width = 6, height = 4)

    
    ggplot() +
      geom_vline(xintercept = 0, col = "black") +
      geom_histogram(aes(x = wTestStat), fill = "red", alpha = .5, binwidth = .25) +
      geom_vline(xintercept = mean(wTestStat), col = "red") +
      xlab("Paired T-Test Statistic") +
      ggtitle("Genes Significantly Down-Regulated in Pregnancy")
    ggsave(filename = paste0(figDir,varA,"_Preg_DownReg_TTestStats_",pvalThresh,"_ctrlStatus.png"),
           width = 6, height = 4)
    
    pvalThreshDF <- c(pvalThreshDF,pvalThresh)
    geneDirectionDF <- c(geneDirectionDF,"down")
    trtDF <- c(trtDF,varA)
    medianTTestDF <- c(medianTTestDF,median(wTestStat))
    variableDF <- c(variableDF,"Preg")
    numGenes <- c(numGenes,length(pregSigDownList))

    
    #### SAME BUT FOR STATUS

    repeatSamples <- names(table(metaPreg$animal_id)[table(metaPreg$animal_id) > 1])
    
    ### find the repeat animals preg/not-preg
    s <- repeatSamples[1]
    doubleStatus <- vector()
    sampleID <- vector()
    pregTF <- vector()
    status <- vector()
    animalID <- vector()
    
    for (s in repeatSamples) {
      print(s)
      if (length(unique(subset(metaStatus, animal_id == s)$status_dom_sub)) > 1) {
        print("duplicate")
        doubleStatus <- c(doubleStatus,s)
        
        animalMeta <- subset(metaStatus, animal_id == s)
        sampleID <- c(sampleID,animalMeta$sampleID)
        pregTF <- c(pregTF,animalMeta$pregStatusBackDate35)
        status <- c(status,animalMeta$status_dom_sub)
        animalID <- c(animalID,animalMeta$animal_id)
        
      } else {
        print("nope")
      }
    }
    
    statusResample <- cbind.data.frame(sampleID,pregTF,status,animalID)
    
    pregMismatch <- c("SSUR1400","SSUR1485","SSUR1474","SSUR1605","SSUR1781","SSUR2229","SSUR1862")
    statusResample <- statusResample[!statusResample$sampleID %in% pregMismatch,]

    
    
    statusSigUpList <- rownames(subset(emmremlResultsStat, pval_status < pvalThresh & beta_status > 0))
    
    wTestPVal <- vector()
    wTestStat <- vector()
    emmremlStdBeta <- vector()
    emmremlPVal <- vector()
    
    #vectors for gene by gene line plot
    geneNamePlot <- vector()
    statusCat <- vector()
    meanGeneExp <- vector()
    medGeneExp <- vector()
    linePlotPval <- vector()

    
    gene <- statusSigUpList[1]
    
    for (gene in statusSigUpList) {
      #get all repeats
      statusResampTTest <- statusResample
      statusResampTTest$geneResid <- 0
      
      #randomly drop replicate re-sampled samples | only want one Preg and one Non-Preg
      for (a in unique(statusResampTTest$animalID)) {
        for (p in c("S","D")) {
          if (sum(statusResampTTest$animalID == a & statusResampTTest$status == p) > 1) {
            #these are the samples that fit the category, just choose one, toss the rest)
            resamps <- length(which(statusResampTTest$animalID == a & statusResampTTest$status == p))
            drop <- sample(which(statusResampTTest$animalID == a & statusResampTTest$status == p), size = resamps - 1, replace = FALSE)
            statusResampTTest <- statusResampTTest[-drop,]
          }
        }
      }
    
      for (s in statusResampTTest$sampleID) {
        statusResampTTest$geneResid[which(statusResampTTest$sampleID == s)] <- residsStatus[which(rownames(residsStatus) == gene),
                                                                                which(colnames(residsStatus) == s)]
      }
      
      geneNamePlot <- c(geneNamePlot,gene,gene)
      
      statusCat <- c(statusCat,"D")
      meanGeneExp <- c(meanGeneExp,mean(subset(statusResampTTest, status == "D")$geneResid))
      medGeneExp <- c(medGeneExp,median(subset(statusResampTTest, status == "D")$geneResid))
      
      statusCat <- c(statusCat,"S")
      meanGeneExp <- c(meanGeneExp,mean(subset(statusResampTTest, status == "S")$geneResid))
      medGeneExp <- c(medGeneExp,median(subset(statusResampTTest, status == "S")$geneResid))

      
      wTest <- wilcox.test(subset(statusResampTTest, status == "D")$geneResid,
                           subset(statusResampTTest, status == "S")$geneResid, paired = TRUE, alternative = "greater")
      
      tTest <- t.test(subset(statusResampTTest, status == "D")$geneResid,
                      subset(statusResampTTest, status == "S")$geneResid, paired = TRUE, alternative = "greater")
      
      wTestPVal <- c(wTestPVal, wTest$p.value)
      wTestStat <- c(wTestStat, tTest$statistic)
      
      linePlotPval <- c(linePlotPval, wTest$p.value, wTest$p.value)
      
      emmremlBeta <- emmremlResultsStat$beta_status[rownames(emmremlResultsStat) == gene]
      emmremlVar <- emmremlResultsStat$var_beta_status[rownames(emmremlResultsStat) == gene]
      
      emmremlStdBeta <- c(emmremlStdBeta, emmremlBeta / sqrt(emmremlVar))
      
      emmremlPVal <- c(emmremlPVal,emmremlResultsStat$pval_status[rownames(emmremlResultsStat) == gene])
    
      # ggplot(statusResampTTest, aes(x = status, y = geneResid, col = animalID, group = animalID)) +
      #   geom_line() +
      #   geom_point(alpha = 3/4, size = 5) +
      #   ggtitle(paste0(gene," resids, Repeat Sample Individuals"),
      #           subtitle = paste0("basic model, ",varA," only"))
    
    }
    
    medGEplot <- cbind.data.frame(geneNamePlot,statusCat,meanGeneExp,medGeneExp,linePlotPval)
    
    medGEplot$statusCat <- factor(medGEplot$statusCat, levels = c("S","D"))
    medGEplot$ttSig <- ifelse(medGEplot$linePlotPval < .05, TRUE, FALSE)
    
    ggplot(data = medGEplot,
           aes(x = statusCat,
               y = meanGeneExp,
               group = geneNamePlot)) +
      geom_line(linewidth = .05) +
      xlab("Status") + ylab("Mean Residual GE") +
      ggtitle("Genes Significantly Up-Regulated in Status",
              subtitle = paste0("Trt:",varA," | p-value < ",pvalThresh))
    ggsave(filename = paste0(figDir,varA,"_Status_UpReg_linePlot_",pvalThresh,"_ctrlPreg.png"),
           width = 6, height = 4)
    
    #accompanying hist
    vCutoff <- min(subset(emmremlResultsStat, pval_status < pvalThresh & beta_status > 0)$beta_status)
    
    ggplot() +
      geom_histogram(aes(x = emmremlResultsPreg$beta_preg), fill = "gray30", binwidth = .10) +
      geom_vline(xintercept = vCutoff, col = "dodgerblue", linewidth = 2) +
      xlab("Pregnancy Betas")
    ggsave(filename = paste0(figDir,varA,"_Status_UpReg_betaHist_",pvalThresh,"_ctrlPreg.png"),
           width = 6, height = 4)

    ggplot() +
      geom_vline(xintercept = 0, col = "black") +
      geom_histogram(aes(x = wTestStat), fill = "red", alpha = .5, binwidth = .25) +
      geom_vline(xintercept = mean(wTestStat), col = "red") +
      xlab("Paired T-Test Statistic") +
      ggtitle("Genes Significantly Up-Regulated in Status")
    ggsave(filename = paste0(figDir,varA,"_Status_UpReg_TTestStats_",pvalThresh,"_ctrlPreg.png"),
           width = 6, height = 4)
    
    pvalThreshDF <- c(pvalThreshDF,pvalThresh)
    geneDirectionDF <- c(geneDirectionDF,"up")
    trtDF <- c(trtDF,varA)
    medianTTestDF <- c(medianTTestDF,median(wTestStat))
    variableDF <- c(variableDF,"Status")
    numGenes <- c(numGenes,length(statusSigUpList))

    
    statusSigDownList <- rownames(subset(emmremlResultsStat, pval_status < pvalThresh & beta_status < 0))
    
    wTestPVal <- vector()
    wTestStat <- vector()
    emmremlStdBeta <- vector()
    emmremlPVal <- vector()
    
    #vectors for gene by gene line plot
    geneNamePlot <- vector()
    statusCat <- vector()
    meanGeneExp <- vector()
    medGeneExp <- vector()
    linePlotPval <- vector()
    
    
    gene <- statusSigDownList[14]
    
    for (gene in statusSigDownList) {
      #get all repeats
      statusResampTTest <- statusResample
      statusResampTTest$geneResid <- 0
      
      #randomly drop replicate re-sampled samples | only want one Preg and one Non-Preg
      for (a in unique(statusResampTTest$animalID)) {
        for (p in c("S","D")) {
          if (sum(statusResampTTest$animalID == a & statusResampTTest$status == p) > 1) {
            #these are the samples that fit the category, just choose one, toss the rest)
            resamps <- length(which(statusResampTTest$animalID == a & statusResampTTest$status == p))
            drop <- sample(which(statusResampTTest$animalID == a & statusResampTTest$status == p), size = resamps - 1, replace = FALSE)
            statusResampTTest <- statusResampTTest[-drop,]
          }
        }
      }
    
      for (s in statusResampTTest$sampleID) {
        statusResampTTest$geneResid[which(statusResampTTest$sampleID == s)] <- residsStatus[which(rownames(residsStatus) == gene),
                                                                                which(colnames(residsStatus) == s)]
      }
      
      geneNamePlot <- c(geneNamePlot,gene,gene)
      
      statusCat <- c(statusCat,"D")
      meanGeneExp <- c(meanGeneExp,mean(subset(statusResampTTest, status == "D")$geneResid))
      medGeneExp <- c(medGeneExp,median(subset(statusResampTTest, status == "D")$geneResid))
      
      statusCat <- c(statusCat,"S")
      meanGeneExp <- c(meanGeneExp,mean(subset(statusResampTTest, status == "S")$geneResid))
      medGeneExp <- c(medGeneExp,median(subset(statusResampTTest, status == "S")$geneResid))
      
      
      
      wTest <- wilcox.test(subset(statusResampTTest, status == "D")$geneResid,
                           subset(statusResampTTest, status == "S")$geneResid, paired = TRUE, alternative = "less")
      
      tTest <- t.test(subset(statusResampTTest, status == "D")$geneResid,
                      subset(statusResampTTest, status == "S")$geneResid, paired = TRUE, alternative = "less")
      
      wTestPVal <- c(wTestPVal, wTest$p.value)
      wTestStat <- c(wTestStat, tTest$statistic)
      
      linePlotPval <- c(linePlotPval, wTest$p.value, wTest$p.value)
      
      
      emmremlBeta <- emmremlResultsStat$beta_status[rownames(emmremlResultsStat) == gene]
      emmremlVar <- emmremlResultsStat$var_beta_status[rownames(emmremlResultsStat) == gene]
      
      emmremlStdBeta <- c(emmremlStdBeta, emmremlBeta / sqrt(emmremlVar))
      
      emmremlPVal <- c(emmremlPVal,emmremlResultsStat$pval_status[rownames(emmremlResultsStat) == gene])
    
      # ggplot(statusResampTTest, aes(x = status, y = geneResid, col = animalID, group = animalID)) +
      #   geom_line() +
      #   geom_point(alpha = 3/4, size = 5) +
      #   ggtitle(paste0(gene," resids, Repeat Sample Individuals"),
      #           subtitle = paste0("basic model, ",varA," only"))
      # 
      # ggplot() +
      #   geom_violin(aes(y = residsStatus[rownames(residsStatus) == gene,], x = metaStatus$status_dom_sub), draw_quantiles = c(.25,.5,.75)) +
      #   geom_jitter(aes(y = residsStatus[rownames(residsStatus) == gene,], x = metaStatus$status_dom_sub), width = .05)
    }
    
    medGEplot <- cbind.data.frame(geneNamePlot,statusCat,meanGeneExp,medGeneExp,linePlotPval)
    
    medGEplot$statusCat <- factor(medGEplot$statusCat, levels = c("S","D"))
    medGEplot$ttSig <- ifelse(medGEplot$linePlotPval < .05, TRUE, FALSE)
    
    ggplot(data = medGEplot,
           aes(x = statusCat,
               y = meanGeneExp,
               group = geneNamePlot)) +
      geom_line(linewidth = .05) +
      xlab("Status") + ylab("Mean Residual GE") +
      ggtitle("Genes Significantly Down-Regulated in Status",
              subtitle = paste0("Trt:",varA," | p-value < ",pvalThresh))
    ggsave(filename = paste0(figDir,varA,"_Status_DownReg_linePlot_",pvalThresh,"_ctrlPreg.png"),
           width = 6, height = 4)
    
    #accompanying hist
    vCutoff <- max(subset(emmremlResultsStat, pval_status < pvalThresh & beta_status < 0)$beta_status)
    
    ggplot() +
      geom_histogram(aes(x = emmremlResultsPreg$beta_preg), fill = "gray30", binwidth = .10) +
      geom_vline(xintercept = vCutoff, col = "dodgerblue", linewidth = 2) +
      xlab("Pregnancy Betas")
    ggsave(filename = paste0(figDir,varA,"_Status_DownReg_betaHist_",pvalThresh,"_ctrlPreg.png"),
           width = 6, height = 4)
    
    ggplot() +
      geom_vline(xintercept = 0, col = "black") +
      geom_histogram(aes(x = wTestStat), fill = "red", alpha = .5, binwidth = .25) +
      geom_vline(xintercept = mean(wTestStat), col = "red") +
      xlab("Paired T-Test Statistic") +
      ggtitle("Genes Significantly Down-Regulated in Status")
    ggsave(filename = paste0(figDir,varA,"_Status_DownReg_TTestStats_",pvalThresh,"_ctrlPreg.png"),
           width = 6, height = 4)
    
    pvalThreshDF <- c(pvalThreshDF,pvalThresh)
    geneDirectionDF <- c(geneDirectionDF,"down")
    trtDF <- c(trtDF,varA)
    medianTTestDF <- c(medianTTestDF,median(wTestStat))
    variableDF <- c(variableDF,"Status")
    numGenes <- c(numGenes,length(statusSigDownList))

  }
}

ttestResults <- cbind.data.frame(pvalThreshDF,geneDirectionDF,trtDF,medianTTestDF,variableDF,numGenes)

basePlot <- ggplot(data = ttestResults, aes(x = -log10(pvalThreshDF), 
                                y = medianTTestDF,
                                group = paste0(geneDirectionDF,"-",variableDF),
                                col = paste0(geneDirectionDF,"-",variableDF))) +
  geom_point(size = 3) + xlab("-log10(pvalue threshold)") + ylab("Median T-Test Stat") +
  labs(col = "direction-\nvariable") +
  ggtitle("Meerkat Variable Re-Sampling T-test",
          subtitle = "by Direction, Variable, and p-value")
ggsave(plot = basePlot,
       filename = paste0(figDir,"All_medianTTestStats_ctrl.png"),
       width = 6, height = 4)

numPlot <- basePlot + geom_text_repel(aes(label = numGenes))
ggsave(plot = numPlot,
       filename = paste0(figDir,"All_medianTTestStats_nums_ctrl.png"),
       width = 6, height = 4)

basePlot <- ggplot(data = subset(ttestResults, variableDF == "Status"), 
       aes(x = -log10(pvalThreshDF),
            y = medianTTestDF,
            col = paste0(trtDF),
           shape = geneDirectionDF)) +
  geom_hline(yintercept = 0, col = "grey40")+
  geom_point(size = 3) + xlab("-log10(pvalue threshold)") + ylab("Median T-Test Stat") +
  labs(col = "treatment",
       shape = "direction") +
  ggtitle("Meerkat Status Re-Sampling T-test",
          subtitle = "by Direction, Treatment, and p-value")
ggsave(plot = basePlot,
       filename = paste0(figDir,"Status_medianTTestStats_ctrl.png"),
           width = 6, height = 4)

numPlot <- basePlot + geom_text_repel(aes(label = numGenes))
ggsave(plot = numPlot,
       filename = paste0(figDir,"Status_medianTTestStats_nums_ctrl.png"),
       width = 6, height = 4)

basePlot <- ggplot(data = subset(ttestResults, variableDF == "Preg"), 
       aes(x = -log10(pvalThreshDF),
            y = medianTTestDF,
            col = paste0(trtDF),
           shape = geneDirectionDF)) +
  geom_hline(yintercept = 0, col = "grey40")+
  geom_point(size = 3) + xlab("-log10(pvalue threshold)") + ylab("Median T-Test Stat") +
  labs(col = "treatment",
       shape = "direction") +
  ggtitle("Meerkat Pregnancy Re-Sampling T-test",
          subtitle = "by Direction, Treatment, and p-value")
ggsave(plot = basePlot,
       filename = paste0(figDir,"Preg_medianTTestStats_ctrl.png"),
           width = 6, height = 4)
numPlot <- basePlot + geom_text_repel(aes(label = numGenes))
ggsave(plot = numPlot,
       filename = paste0(figDir,"Preg_medianTTestStats_nums_ctrl.png"),
       width = 6, height = 4)


```

```{r GSEA}
#emreml and mash results


#for (c in c("InfluenzaA","Control18h","Control15h","LPS","Dex","Gardiquimod","IL15","NCSGE1","LPSSGE1")) {

## loop through data sets

c <- "status"
trt <- "LPS"
thresh <- "5lCPM"
for (thresh in c("5lCPM","7lCPM")) {
  allSigTrtPathways <- data.frame()
  allTrtPathways <- data.frame()
  
  for (c in c("preg","status")) {
    
    m <- "emmreml"
  
    for (trt in c("Ctrl","LPS","Gard","Dex")) {
      shortName <- paste0(c,"_",trt,"Trt_",thresh)
      
      model <- "modelR"
      modelpreg <- "modelP"
  
      if (trt %in% c("Dex","Gard")) {
        model <- "modelS"
        modelpreg <- "modelQ"
      }
      
      if (c == "status") {
        emmremlResults <- read.table(paste0(outDir,"allBatches_F_",trt,"only_10000genes_",thresh,"_",modelpreg,"_basicPreg_emmreml"))
        stdBetas <- emmremlResults$beta_status / sqrt(emmremlResults$var_beta_status)
      } else if (c == "preg") {
        emmremlResults <- read.table(paste0(outDir,"allBatches_F_",trt,"only_10000genes_",thresh,"_",model,"_basicPreg_emmreml"))
        stdBetas <- emmremlResults$beta_preg / sqrt(emmremlResults$var_beta_preg)
      }
      
      modelResults <- as.data.frame(stdBetas)
      rownames(modelResults) <- rownames(emmremlResults)
      colnames(modelResults) <- "stdBeta"
      
      ### using modelResults run a GSEA, and save the output
      
      ### Permutation-based GSEA tests
      ### Originally developed by Jordan Anderson and Noah Snyder-Mackler. Modified by Tauras Vilgalys. 
      ### Last updated 2020 September 16
      
      ###outside R, build a csv file with geneName,hallmarkPathway
      
      # Parameter options on lines 11 and 12
      # Data and files to load on lines 16 and 30
      ## parameters to consider: 
      pvals <- F ## are data in pvalues or betas? If betas, set pvals to FALSE
      weight <- 1 ## Weight to place on betas. Typically either a 1 or a 0, where 0 weights all effects equally.
              ## weight=0 acts like a KS test, and is typically used with pvalues. 
      
      sampleBetas <- as.data.frame(rownames(modelResults))
      sampleBetas$Betas <- modelResults$stdBeta
      
      colnames(sampleBetas) <- c("Gene","Betas")
  
      gene.list <- sampleBetas$Gene
    
      ## get nperm permutations of the vector of Betas
      nperm <- 1000
      for (i in 1:nperm) {
        tmpB <- sample(sampleBetas$Beta)
        cbind(sampleBetas,tmpB) -> sampleBetas; rm(tmpB)
      }; rm(i)#; head(sampleBetas)
  
      ## Get the list of gene sets to test. here the file starts with gene names and the associated GO terms. 
      ## i downloaded these hallmark gene sets from https://www.gsea-msigdb.org/gsea/msigdb/collections.jsp
  
      gene.set <- read.table(paste0(dataDir,"hallmarkPathways_wCategories.csv"), sep = ",")
      
      colnames(gene.set) <- c("Associated.Gene.Name","GO.Term.Accession","Category")
  
      gene.set$gene_GO <- paste0(gene.set$Associated.Gene.Name,"_",gene.set$GO.Term.Accession)
  
      # Trim for expressed genes where B was estimated
      gene.set2 <- subset(gene.set, gene.set$Associated.Gene.Name %in% sampleBetas$Gene)
  
      # Remove duplicated gene/GO pairings
      gene.set2 <- gene.set2[!duplicated(gene.set2$gene_GO),]
  
      ## Get list of gene ontologies to test, and the number of genes in each
      GO_res <- as.data.frame(matrix(ncol=2, nrow=length(unique(gene.set2$GO.Term.Accession)), unique(gene.set2$GO.Term.Accession)))
      GO_res$V2 <- 0
      GO_res <- GO_res[!(GO_res$V1 == ""),]; colnames(GO_res) <- c("GO", "n_genes")
      
      for (i in 1:nrow(GO_res)) {
        GO_res$n_genes[i] <- sum(gene.set2$GO.Term.Accession == GO_res$GO[i])
      }
      
      rm(i)
      GO_res$n_genes <- as.numeric(GO_res$n_genes)
      
      ## Only consider gene sets with at least 5 measured genes
      GO_res <- subset(GO_res, n_genes >= 5)
      
      ## Create a matrix of just the effect sizes, moving the gene names to the row.names
      effect_size_matrix <- sampleBetas[,-1]
      row.names(effect_size_matrix) <- sampleBetas[,1]
  
      ## Run GSEA function for each GO term (defined earlier in GO_res$GO)
      output<-GSEA(effect_size_matrix = effect_size_matrix,
                   gene_set_list = unique(GO_res$GO),
                   gene_GO_associations = gene.set2,
                   weight = 1, pvals=F)
      
      names(output) <- c("NES_matrix_upreg","NES_matrix_downreg","p_values")
    
      # Normalize + ES' by the mean of + ES values, and - ES' by the mean of - ES null values for that gene set. 
      ##This should effectively control for differences in gene set size
      pos.ES.norm<-matrix(0,nrow=nrow(GO_res),ncol=nperm+1)
      neg.ES.norm<-matrix(0,nrow=nrow(GO_res),ncol=nperm+1)
      
      for (i in 1:length(GO_res$GO)) {
        pos.ES <- unlist(output$NES_matrix_upreg[i,])
        names(pos.ES)<-NULL
        neg.ES <- unlist(output$NES_matrix_downreg[i,])
        names(neg.ES)<-NULL
  
        #for a given gene set, N, calculate the mean of the positive max ES for estimated+ permuted ES.
        #calculate the mean of the max negative ES for estimate+ permuted ES also
         pos.m <- mean(pos.ES)
         neg.m <- mean(abs(neg.ES))
         
         #Then for each permutation in that geneset, scale ES by this mean value, depending on if it was max + or max - ES
         for (j in 1:(nperm+1)){
           pos.ES.norm[i,j]<-pos.ES[j]/pos.m
           neg.ES.norm[i,j]<-neg.ES[j]/neg.m
         }
      }
      
      # FDR? 
      ## Calculate p-values for one of the null distributions as well
      perm_upreg <- apply(output$NES_matrix_upreg[,-1],1,function(x) {ee <- ecdf(x[2:length(x)]); 1 - ee(x[1])})
      perm_downreg <- apply(output$NES_matrix_downreg[,-1],1,function(x) {ee <- ecdf(x[2:length(x)]); 1 - ee(x[1])})
      ## Use perm.fdr function (written by Joaquin Sanz, available from Snyder-Mackler et al. 2016: 
      ## https://github.com/nsmackler/status_genome_2016/blob/master/perm_FDR.R)
      
      fdr_up <- perm.fdr(output$p_values, perm_upreg, "pval_upreg", "fdr_vsPerm1")
      fdr_down <- perm.fdr(output$p_values, perm_upreg, "pval_downreg", "fdr_vsPerm1")
      
      upregNES <- output$NES_matrix_upreg[,1]
      dnregNES <- output$NES_matrix_downreg[,1]
      
      cbind(as.character(GO_res$GO),output$p_values)
  
      #plot significant effects
      betasOnly <- as.data.frame(effect_size_matrix$Betas)
      rownames(betasOnly) <- rownames(effect_size_matrix)
      colnames(betasOnly) <- c("betas")
      betasOnly$rank <- rank(-betasOnly$betas)
    
      dir.create(paste0(figDir,shortName))
      
      for (r in 1:2) {
        if(sum(output$p_values[,r] < .05) > 0) {
          for (g in which(output$p_values[,r] < .05)) {
            pathwayName <- as.character(GO_res$GO)[g]
            pathwayGenes <- subset(gene.set2, GO.Term.Accession == pathwayName)$Associated.Gene.Name
            betasOnly$pathway <- FALSE
            betasOnly$pathway <- rownames(effect_size_matrix) %in% pathwayGenes
            
            betasPathway <- subset(betasOnly, pathway)
            ggplot() +
              geom_linerange(aes(x = betasOnly$rank, ymax = betasOnly$betas, ymin = 0), alpha = 66/dim(effect_size_matrix)[1]) +
              geom_linerange(aes(x = betasPathway$rank, ymax = betasPathway$betas, ymin = 0)) +
              xlab("Rank") + ggtitle(pathwayName, 
                                     subtitle = paste0(subset(GO_res, GO == pathwayName)$n_genes," genes, ",
                                                       "p = ",as.numeric(output$p_values[g,r]),"    ",colnames(output$p_values)[r],
                                                       "      ",m,"-",shortName))
            ggsave(paste0(figDir,"/",shortName,"/gsea_stickPlot_",m,"_Enriched_",pathwayName,".png"), width = 6, height = 4)
          }
        }
      }
      
      gseaTreatment <- output
      
      sigList <- gseaTreatment$p_values[,1] < .05 | gseaTreatment$p_values[,2] < .05
      
      sigPathways <- as.data.frame(cbind(as.character(GO_res$GO),
                                         gseaTreatment$p_values,
                                         gseaTreatment$NES_matrix_upreg[,1],
                                         gseaTreatment$NES_matrix_downreg[,1],
                                         shortName,
                                         m,
                                         c,
                                         trt)[sigList,])
      
      allPathways <- as.data.frame(cbind(as.character(GO_res$GO),
                                         gseaTreatment$p_values,gseaTreatment$NES_matrix_upreg[,1],
                                         gseaTreatment$NES_matrix_downreg[,1],
                                         shortName,
                                         m,
                                         c,
                                         trt))
    
      if( dim(allSigTrtPathways)[1] == 0) {
        allSigTrtPathways <- sigPathways
        allTrtPathways <- allPathways
      } else {
          allSigTrtPathways <- rbind(allSigTrtPathways,sigPathways)
          allTrtPathways <- rbind(allTrtPathways,allPathways)
      }
    }
  }
  
  write.table(x = allSigTrtPathways, file = paste0(outDir,"gsea_multiTrt_GSEA_sigResults.txt"), quote = F, row.names = F, sep = ",")
  write.table(x = allTrtPathways, file = paste0(outDir,"gsea_multiTrt_GSEA_allResults.txt"), quote = F, row.names = F, sep = ",")
  
  
  geneSetSort <- unique(gene.set[,2:3])
  geneSetSort <- geneSetSort[order(geneSetSort$Category),]
  geneSetSort$pathwayShort <- str_remove(geneSetSort$GO.Term.Accession, "HALLMARK_")
  
  plotAllSigTrtPathways <- allSigTrtPathways
  
  colnames(plotAllSigTrtPathways)[c(1,4,5)] <- c("pathway","ESup","ESdown") 
  colnames(plotAllSigTrtPathways)[c(6,7)] <- c("species","model") 
  
  plotAllSigTrtPathways$sigPVal <- ifelse(plotAllSigTrtPathways$pval_upreg < plotAllSigTrtPathways$pval_downreg,
                                          plotAllSigTrtPathways$pval_upreg, plotAllSigTrtPathways$pval_downreg)
  
  plotAllSigTrtPathways$sigES <- ifelse(plotAllSigTrtPathways$pval_upreg < plotAllSigTrtPathways$pval_downreg,
                                          plotAllSigTrtPathways$ESup, plotAllSigTrtPathways$ESdown)
  
  plotAllSigTrtPathways$sigPValAdj <- ifelse(plotAllSigTrtPathways$sigPVal == 0, .0001, plotAllSigTrtPathways$sigPVal)
  
  plotAllSigTrtPathways$sigES <- as.numeric(plotAllSigTrtPathways$sigES)
  plotAllSigTrtPathways$sigPValAdj <- as.numeric(plotAllSigTrtPathways$sigPValAdj)
  
  
  #plotAllSigTrtPathways$conditionMethod <- paste0(plotAllSigTrtPathways$condition,"_",plotAllSigTrtPathways$tpMethod)
  
  
  ggplot(data = plotAllSigTrtPathways, aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point()
  
  
  #todo - remove "hallmark_"
  plotAllSigTrtPathways$pathway <- str_remove(plotAllSigTrtPathways$pathway, "HALLMARK_")
  
  
  #plotAllSigTrtPathways$condModel <- paste0(plotAllSigTrtPathways$condition,"_",plotAllSigTrtPathways$model)
  
  #change angle of names (bottom)
  
  ggplot(data = plotAllSigTrtPathways, aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
  
  #viridis color scheme
  
  #sort by number of conditions & up/down reg elo
  pathwayList <- unique(plotAllSigTrtPathways$pathway)
  meanES <- vector()
  
  for (p in pathwayList) {
    meanES <- c(meanES,mean(subset(plotAllSigTrtPathways, pathway == p)$sigES))
  }
  
  pathwayList <- pathwayList[order(-meanES)]
  
  plotAllSigTrtPathways$pathway <- factor(plotAllSigTrtPathways$pathway, levels = pathwayList)
  
  
  
  pathwayList <- unique(plotAllSigTrtPathways$pathway)
  meanES <- vector()
  
  for (p in pathwayList) {
    meanES <- c(meanES,mean(subset(plotAllSigTrtPathways, pathway == p)$sigES))
  }
  
  pathwayList <- pathwayList[order(-meanES)]
  
  plotAllSigTrtPathways$pathway <- factor(plotAllSigTrtPathways$pathway, levels = pathwayList)
  
  
  ggplot(data = subset(plotAllSigTrtPathways, c == "status"), aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("status - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_status_plot_viridis_emreml_",thresh,".png"), width = 8, height = 6)
  
  ggplot(data = subset(plotAllSigTrtPathways, c == "preg"), aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("preg - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_preg_plot_viridis_emreml_",thresh,".png"), width = 8, height = 6)
  
  
  immunePathways <- c("TNFA_SIGNALING_VIA_NFKB",
                      "INFLAMMATORY_RESPONSE",
                      "INTERFERON_ALPHA_RESPONSE",
                      "INTERFERON_GAMMA_RESPONSE",
                      "COMPLEMENT",
                      "CTRA_UP",
                      "CTRA_DOWN")
  
  ggplot(data = subset(plotAllSigTrtPathways, pathway %in% immunePathways & c == "status"), 
         aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("status - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_status_plot_viridis_emreml_ImmunePaths_",thresh,".png"), width = 8, height = 6)
  
  ggplot(data = subset(plotAllSigTrtPathways, pathway %in% immunePathways & c == "preg"), 
         aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("preg - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_preg_plot_viridis_emreml_ImmunePaths_",thresh,".png"), width = 8, height = 6)
  
  ggplot(data = subset(plotAllSigTrtPathways, pathway %in% immunePathways), 
         aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("preg - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_plot_viridis_emreml_ImmunePaths_",thresh,".png"), width = 8, height = 4)
  
  
  plotAllSigTrtPathways$pathway <- factor(plotAllSigTrtPathways$pathway, levels = geneSetSort$pathwayShort)
  
  ## plot the pathways with multiple sig hits
  sigPaths <- names(table(plotAllSigTrtPathways$pathway)[table(plotAllSigTrtPathways$pathway) > 2])
  
  ggplot(data = subset(plotAllSigTrtPathways, pathway %in% sigPaths), aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("emreml - sig GSEA in > 2 pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
  ggsave(paste0(figDir,"GSEA_condition_plot_viridis_emreml_SigPaths_gt2_",thresh,".png"), width = 8, height = 6)
  
  p <- "MYC_TARGETS_V1"
  t <- "LPS"
  
  for (t in unique(plotAllSigTrtPathways$trt)) {
    print(t)
    pathSig <- vector()
    
    for (p in geneSetSort$pathwayShort) {
      cSig <- subset(plotAllSigTrtPathways, trt == t & pathway == p)$c
      
      if (length(cSig) == 2) {
        pathSig <- c(pathSig,"both")
      } else if (length(cSig) == 1) {
        if (cSig == "preg") {
          pathSig <- c(pathSig,"preg")
        } else {
          pathSig <- c(pathSig,"status")
        }
      } else {
        pathSig <- c(pathSig,"none")
      }
    }
    gseaFETMat <- matrix(c(sum(pathSig == "both"),
                           sum(pathSig == "preg"),
                           sum(pathSig == "status"),
                           sum(pathSig == "none")), nrow = 2)
  
    #fishP <- signif(fisher.test(fishDat)$p.value, digits = 3)
    #sigGeneDiff <- signif(fishDat - chisq.test(fishDat)$expected, digits = 3)
    #excessBoth <- sigGeneDiff[1,1]
    fishP <- signif(fisher.test(gseaFETMat)$p.value, digits = 3)
    sigGeneDiff <- signif(gseaFETMat - chisq.test(gseaFETMat)$expected, digits = 3)
    excessBoth <- sigGeneDiff[1,1]
    print(paste0(fishP," ",excessBoth))
  }
}
```

status GSEA for KMP talk
```{r status GSEA}
#emreml and mash results


#for (c in c("InfluenzaA","Control18h","Control15h","LPS","Dex","Gardiquimod","IL15","NCSGE1","LPSSGE1")) {

## loop through data sets

c <- "status"
trt <- "LPS"
thresh <- "5lCPM"
for (thresh in c("5lCPM")) {
  allSigTrtPathways <- data.frame()
  allTrtPathways <- data.frame()
  
  for (c in c("status")) {
    
    m <- "emmreml"
  
    for (trt in c("Ctrl","LPS","Gard","Dex")) {
      shortName <- paste0(c,"_",trt,"Trt_",thresh)
      
      model <- "modelR"
      modelpreg <- "modelP"
  
      if (trt %in% c("Dex","Gard")) {
        model <- "modelS"
        modelpreg <- "modelQ"
      }
      
      if (c == "status") {
        emmremlResults <- read.table(paste0(outDir,"allBatches_F_",trt,"only_10000genes_",thresh,"_",modelpreg,"_basicPreg_emmreml"))
        stdBetas <- emmremlResults$beta_status / sqrt(emmremlResults$var_beta_status)
      } else if (c == "preg") {
        emmremlResults <- read.table(paste0(outDir,"allBatches_F_",trt,"only_10000genes_",thresh,"_",model,"_basicPreg_emmreml"))
        stdBetas <- emmremlResults$beta_preg / sqrt(emmremlResults$var_beta_preg)
      }
      
      modelResults <- as.data.frame(stdBetas)
      rownames(modelResults) <- rownames(emmremlResults)
      colnames(modelResults) <- "stdBeta"
      
      ### using modelResults run a GSEA, and save the output
      
      ### Permutation-based GSEA tests
      ### Originally developed by Jordan Anderson and Noah Snyder-Mackler. Modified by Tauras Vilgalys. 
      ### Last updated 2020 September 16
      
      ###outside R, build a csv file with geneName,hallmarkPathway
      
      # Parameter options on lines 11 and 12
      # Data and files to load on lines 16 and 30
      ## parameters to consider: 
      pvals <- F ## are data in pvalues or betas? If betas, set pvals to FALSE
      weight <- 1 ## Weight to place on betas. Typically either a 1 or a 0, where 0 weights all effects equally.
              ## weight=0 acts like a KS test, and is typically used with pvalues. 
      
      sampleBetas <- as.data.frame(rownames(modelResults))
      sampleBetas$Betas <- modelResults$stdBeta
      
      colnames(sampleBetas) <- c("Gene","Betas")
  
      gene.list <- sampleBetas$Gene
    
      ## get nperm permutations of the vector of Betas
      nperm <- 1000
      for (i in 1:nperm) {
        tmpB <- sample(sampleBetas$Beta)
        cbind(sampleBetas,tmpB) -> sampleBetas; rm(tmpB)
      }; rm(i)#; head(sampleBetas)
  
      ## Get the list of gene sets to test. here the file starts with gene names and the associated GO terms. 
      ## i downloaded these hallmark gene sets from https://www.gsea-msigdb.org/gsea/msigdb/collections.jsp
  
      gene.set <- read.table(paste0(dataDir,"hallmarkPathways_wCategories.csv"), sep = ",")
      
      colnames(gene.set) <- c("Associated.Gene.Name","GO.Term.Accession","Category")
  
      gene.set$gene_GO <- paste0(gene.set$Associated.Gene.Name,"_",gene.set$GO.Term.Accession)
  
      # Trim for expressed genes where B was estimated
      gene.set2 <- subset(gene.set, gene.set$Associated.Gene.Name %in% sampleBetas$Gene)
  
      # Remove duplicated gene/GO pairings
      gene.set2 <- gene.set2[!duplicated(gene.set2$gene_GO),]
  
      ## Get list of gene ontologies to test, and the number of genes in each
      GO_res <- as.data.frame(matrix(ncol=2, nrow=length(unique(gene.set2$GO.Term.Accession)), unique(gene.set2$GO.Term.Accession)))
      GO_res$V2 <- 0
      GO_res <- GO_res[!(GO_res$V1 == ""),]; colnames(GO_res) <- c("GO", "n_genes")
      
      for (i in 1:nrow(GO_res)) {
        GO_res$n_genes[i] <- sum(gene.set2$GO.Term.Accession == GO_res$GO[i])
      }
      
      rm(i)
      GO_res$n_genes <- as.numeric(GO_res$n_genes)
      
      ## Only consider gene sets with at least 5 measured genes
      GO_res <- subset(GO_res, n_genes >= 5)
      
      ## Create a matrix of just the effect sizes, moving the gene names to the row.names
      effect_size_matrix <- sampleBetas[,-1]
      row.names(effect_size_matrix) <- sampleBetas[,1]
  
      ## Run GSEA function for each GO term (defined earlier in GO_res$GO)
      output<-GSEA(effect_size_matrix = effect_size_matrix,
                   gene_set_list = unique(GO_res$GO),
                   gene_GO_associations = gene.set2,
                   weight = 1, pvals=F)
      
      names(output) <- c("NES_matrix_upreg","NES_matrix_downreg","p_values")
    
      # Normalize + ES' by the mean of + ES values, and - ES' by the mean of - ES null values for that gene set. 
      ##This should effectively control for differences in gene set size
      pos.ES.norm<-matrix(0,nrow=nrow(GO_res),ncol=nperm+1)
      neg.ES.norm<-matrix(0,nrow=nrow(GO_res),ncol=nperm+1)
      
      for (i in 1:length(GO_res$GO)) {
        pos.ES <- unlist(output$NES_matrix_upreg[i,])
        names(pos.ES)<-NULL
        neg.ES <- unlist(output$NES_matrix_downreg[i,])
        names(neg.ES)<-NULL
  
        #for a given gene set, N, calculate the mean of the positive max ES for estimated+ permuted ES.
        #calculate the mean of the max negative ES for estimate+ permuted ES also
         pos.m <- mean(pos.ES)
         neg.m <- mean(abs(neg.ES))
         
         #Then for each permutation in that geneset, scale ES by this mean value, depending on if it was max + or max - ES
         for (j in 1:(nperm+1)){
           pos.ES.norm[i,j]<-pos.ES[j]/pos.m
           neg.ES.norm[i,j]<-neg.ES[j]/neg.m
         }
      }
      
      # FDR? 
      ## Calculate p-values for one of the null distributions as well
      perm_upreg <- apply(output$NES_matrix_upreg[,-1],1,function(x) {ee <- ecdf(x[2:length(x)]); 1 - ee(x[1])})
      perm_downreg <- apply(output$NES_matrix_downreg[,-1],1,function(x) {ee <- ecdf(x[2:length(x)]); 1 - ee(x[1])})
      ## Use perm.fdr function (written by Joaquin Sanz, available from Snyder-Mackler et al. 2016: 
      ## https://github.com/nsmackler/status_genome_2016/blob/master/perm_FDR.R)
      
      fdr_up <- perm.fdr(output$p_values, perm_upreg, "pval_upreg", "fdr_vsPerm1")
      fdr_down <- perm.fdr(output$p_values, perm_upreg, "pval_downreg", "fdr_vsPerm1")
      
      upregNES <- output$NES_matrix_upreg[,1]
      dnregNES <- output$NES_matrix_downreg[,1]
      
      cbind(as.character(GO_res$GO),output$p_values)
  
      #plot significant effects
      betasOnly <- as.data.frame(effect_size_matrix$Betas)
      rownames(betasOnly) <- rownames(effect_size_matrix)
      colnames(betasOnly) <- c("betas")
      betasOnly$rank <- rank(-betasOnly$betas)
    
      dir.create(paste0(figDir,shortName))
      
      for (r in 1:2) {
        if(sum(output$p_values[,r] < .05) > 0) {
          for (g in which(output$p_values[,r] < .05)) {
            pathwayName <- as.character(GO_res$GO)[g]
            pathwayGenes <- subset(gene.set2, GO.Term.Accession == pathwayName)$Associated.Gene.Name
            betasOnly$pathway <- FALSE
            betasOnly$pathway <- rownames(effect_size_matrix) %in% pathwayGenes
            
            betasPathway <- subset(betasOnly, pathway)
            ggplot() +
              geom_linerange(aes(x = betasOnly$rank, ymax = betasOnly$betas, ymin = 0), alpha = 66/dim(effect_size_matrix)[1]) +
              geom_linerange(aes(x = betasPathway$rank, ymax = betasPathway$betas, ymin = 0)) +
              xlab("Rank") + ggtitle(pathwayName, 
                                     subtitle = paste0(subset(GO_res, GO == pathwayName)$n_genes," genes, ",
                                                       "p = ",as.numeric(output$p_values[g,r]),"    ",colnames(output$p_values)[r],
                                                       "      ",m,"-",shortName))
            ggsave(paste0(figDir,"/",shortName,"/gsea_stickPlot_",m,"_Enriched_",pathwayName,".png"), width = 6, height = 4)
          }
        }
      }
      
      gseaTreatment <- output
      
      sigList <- gseaTreatment$p_values[,1] < .05 | gseaTreatment$p_values[,2] < .05
      
      sigPathways <- as.data.frame(cbind(as.character(GO_res$GO),
                                         gseaTreatment$p_values,
                                         gseaTreatment$NES_matrix_upreg[,1],
                                         gseaTreatment$NES_matrix_downreg[,1],
                                         shortName,
                                         m,
                                         c,
                                         trt)[sigList,])
      
      allPathways <- as.data.frame(cbind(as.character(GO_res$GO),
                                         gseaTreatment$p_values,gseaTreatment$NES_matrix_upreg[,1],
                                         gseaTreatment$NES_matrix_downreg[,1],
                                         shortName,
                                         m,
                                         c,
                                         trt))
    
      if( dim(allSigTrtPathways)[1] == 0) {
        allSigTrtPathways <- sigPathways
        allTrtPathways <- allPathways
      } else {
          allSigTrtPathways <- rbind(allSigTrtPathways,sigPathways)
          allTrtPathways <- rbind(allTrtPathways,allPathways)
      }
    }
  }
  
  write.table(x = allSigTrtPathways, file = paste0(outDir,"gsea_multiTrt_GSEA_sigResults.txt"), quote = F, row.names = F, sep = ",")
  write.table(x = allTrtPathways, file = paste0(outDir,"gsea_multiTrt_GSEA_allResults.txt"), quote = F, row.names = F, sep = ",")
}
```


```{r status GSEA plot}
thresh <- "5lCPM"
allSigTrtPathways <- read.table(file = paste0(outDir,"gsea_multiTrt_GSEA_sigResults.txt"), sep = ",", header = T)
allTrtPathways <- read.table(file = paste0(outDir,"gsea_multiTrt_GSEA_allResults.txt"), sep = ",", header = T)

gene.set <- read.table(paste0(dataDir,"hallmarkPathways_wCategories.csv"), sep = ",")
    
colnames(gene.set) <- c("Associated.Gene.Name","GO.Term.Accession","Category")

gene.set$gene_GO <- paste0(gene.set$Associated.Gene.Name,"_",gene.set$GO.Term.Accession)


geneSetSort <- unique(gene.set[,2:3])
  geneSetSort <- geneSetSort[order(geneSetSort$Category),]
  geneSetSort$pathwayShort <- str_remove(geneSetSort$GO.Term.Accession, "HALLMARK_")
  
  plotAllSigTrtPathways <- allSigTrtPathways
  
  colnames(plotAllSigTrtPathways)[c(1,4,5)] <- c("pathway","ESup","ESdown") 
  colnames(plotAllSigTrtPathways)[c(6,7)] <- c("species","model") 
  
  plotAllSigTrtPathways$sigPVal <- ifelse(plotAllSigTrtPathways$pval_upreg < plotAllSigTrtPathways$pval_downreg,
                                          plotAllSigTrtPathways$pval_upreg, plotAllSigTrtPathways$pval_downreg)
  
  plotAllSigTrtPathways$sigES <- ifelse(plotAllSigTrtPathways$pval_upreg < plotAllSigTrtPathways$pval_downreg,
                                          plotAllSigTrtPathways$ESup, plotAllSigTrtPathways$ESdown)
  
  plotAllSigTrtPathways$sigPValAdj <- ifelse(plotAllSigTrtPathways$sigPVal == 0, .0001, plotAllSigTrtPathways$sigPVal)
  
  plotAllSigTrtPathways$sigES <- as.numeric(plotAllSigTrtPathways$sigES)
  plotAllSigTrtPathways$sigPValAdj <- as.numeric(plotAllSigTrtPathways$sigPValAdj)
  
  
  #plotAllSigTrtPathways$conditionMethod <- paste0(plotAllSigTrtPathways$condition,"_",plotAllSigTrtPathways$tpMethod)
  
  
  ggplot(data = plotAllSigTrtPathways, aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point()
  
  
  #todo - remove "hallmark_"
  plotAllSigTrtPathways$pathway <- str_remove(plotAllSigTrtPathways$pathway, "HALLMARK_")
  
  
  #plotAllSigTrtPathways$condModel <- paste0(plotAllSigTrtPathways$condition,"_",plotAllSigTrtPathways$model)
  
  #change angle of names (bottom)
  
  ggplot(data = plotAllSigTrtPathways, aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
  
  #viridis color scheme
  
  #sort by number of conditions & up/down reg elo
  pathwayList <- unique(plotAllSigTrtPathways$pathway)
  meanES <- vector()
  
  for (p in pathwayList) {
    meanES <- c(meanES,mean(subset(plotAllSigTrtPathways, pathway == p)$sigES))
  }
  
  pathwayList <- pathwayList[order(-meanES)]
  
  plotAllSigTrtPathways$pathway <- factor(plotAllSigTrtPathways$pathway, levels = pathwayList)
  
  
  
  pathwayList <- unique(plotAllSigTrtPathways$pathway)
  meanES <- vector()
  
  for (p in pathwayList) {
    meanES <- c(meanES,mean(subset(plotAllSigTrtPathways, pathway == p)$sigES))
  }
  
  pathwayList <- pathwayList[order(-meanES)]
  
  plotAllSigTrtPathways$pathway <- factor(plotAllSigTrtPathways$pathway, levels = pathwayList)
  
  
  ggplot(data = subset(plotAllSigTrtPathways, c == "status"), aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("status - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_status_plot_viridis_emreml_",thresh,".png"), width = 8, height = 6)
  
  
  immunePathways <- c("TNFA_SIGNALING_VIA_NFKB",
                      "INFLAMMATORY_RESPONSE",
                      "INTERFERON_ALPHA_RESPONSE",
                      "INTERFERON_GAMMA_RESPONSE",
                      "COMPLEMENT",
                      "CTRA_UP",
                      "CTRA_DOWN")
  
  ggplot(data = subset(plotAllSigTrtPathways, pathway %in% immunePathways & c == "status"), 
         aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("status - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_status_plot_viridis_emreml_ImmunePaths_",thresh,".png"), width = 8, height = 6)
  
  ggplot(data = subset(plotAllSigTrtPathways, pathway %in% immunePathways), 
         aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("status - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_plot_viridis_emreml_ImmunePaths_",thresh,".png"), width = 8, height = 4)
  
  
  plotAllSigTrtPathways$pathway <- factor(plotAllSigTrtPathways$pathway, levels = geneSetSort$pathwayShort)
  
  ## plot the pathways with multiple sig hits
  sigPaths <- names(table(plotAllSigTrtPathways$pathway)[table(plotAllSigTrtPathways$pathway) > 2])
  
  ggplot(data = subset(plotAllSigTrtPathways, pathway %in% sigPaths), aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("emreml - sig GSEA in > 2 pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
  ggsave(paste0(figDir,"GSEA_condition_plot_viridis_emreml_SigPaths_gt2_",thresh,".png"), width = 8, height = 6)
  
  p <- "MYC_TARGETS_V1"
  t <- "LPS"
  
  for (t in unique(plotAllSigTrtPathways$trt)) {
    print(t)
    pathSig <- vector()
    
    for (p in geneSetSort$pathwayShort) {
      cSig <- subset(plotAllSigTrtPathways, trt == t & pathway == p)$c
      
      if (length(cSig) == 2) {
        pathSig <- c(pathSig,"both")
      } else if (length(cSig) == 1) {
        if (cSig == "preg") {
          pathSig <- c(pathSig,"preg")
        } else {
          pathSig <- c(pathSig,"status")
        }
      } else {
        pathSig <- c(pathSig,"none")
      }
    }
    gseaFETMat <- matrix(c(sum(pathSig == "both"),
                           sum(pathSig == "preg"),
                           sum(pathSig == "status"),
                           sum(pathSig == "none")), nrow = 2)
  
    #fishP <- signif(fisher.test(fishDat)$p.value, digits = 3)
    #sigGeneDiff <- signif(fishDat - chisq.test(fishDat)$expected, digits = 3)
    #excessBoth <- sigGeneDiff[1,1]
    fishP <- signif(fisher.test(gseaFETMat)$p.value, digits = 3)
    sigGeneDiff <- signif(gseaFETMat - chisq.test(gseaFETMat)$expected, digits = 3)
    excessBoth <- sigGeneDiff[1,1]
    print(paste0(fishP," ",excessBoth))
  }

##for KMP talk
kmpPlot <- plotAllSigTrtPathways



ggplot(data = subset(plotAllSigTrtPathways, c == "status"), 
       aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
  geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("status - emreml - sig GSEA pathways") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
   theme(legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(.5, 'cm'), #change legend key height
        legend.key.width = unit(.5, 'cm'), #change legend key width
        legend.title = element_text(size=8), #change legend title font size
        legend.text = element_text(size=6))
ggsave(paste0(figDir,"GSEA_condition_status_plot_viridis_emreml_allPaths_",thresh,"_kmpTalk.png"), width = 8, height = 6)


immunePathways <- c("TNFA_SIGNALING_VIA_NFKB",
                    "INFLAMMATORY_RESPONSE",
                    "INTERFERON_ALPHA_RESPONSE",
                    "INTERFERON_GAMMA_RESPONSE",
                    "COMPLEMENT")


kmpPlot <- subset(plotAllSigTrtPathways, pathway %in% immunePathways & c == "status")


  
ggplot(data = kmpPlot, 
       aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
  geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("status - emreml - sig GSEA pathways") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
   theme(legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(.5, 'cm'), #change legend key height
        legend.key.width = unit(.5, 'cm'), #change legend key width
        legend.title = element_text(size=8), #change legend title font size
        legend.text = element_text(size=6))
ggsave(paste0(figDir,"GSEA_condition_status_plot_viridis_emreml_ImmunePaths_",thresh,"_kmpTalk_draft.png"), width = 8, height = 6)


kmpPlot$species <- str_replace_all(kmpPlot$species, "status_", "")
kmpPlot$species <- str_replace_all(kmpPlot$species, "Trt_5lCPM", "")

kmpPlot$species <- factor(kmpPlot$species, levels = c("MMul-","MMul+",
                                                      "BabF-","BabF+",
                                                      "BabM-","BabM+",
                                                      "meerkatF-","meerkatF+"))



###kmptalk
ggplot(data = kmpPlot, aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
  geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("") +
  labs(size = "-log10(p-value)",
       col = "Enrichment\nScore") +
  theme_minimal() +
   theme(legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(.5, 'cm'), #change legend key height
        legend.key.width = unit(.5, 'cm'), #change legend key width
        legend.title = element_text(size=8), #change legend title font size
        legend.text = element_text(size=6)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
ggsave(paste0(figDir,"GSEA_condition_status_plot_viridis_emreml_ImmunePaths_",thresh,"_kmpTalk.png"), width = 5, height = 3)


```


Combined treatment GSEA
```{r All Treatments GSEA Female}
#emreml and mash results


#for (c in c("InfluenzaA","Control18h","Control15h","LPS","Dex","Gardiquimod","IL15","NCSGE1","LPSSGE1")) {

## loop through data sets

c <- "status"
trt <- "allTrt"
thresh <- "5lCPM"

for (thresh in c("5lCPM","7lCPM")) {
  allSigTrtPathways <- data.frame()
  allTrtPathways <- data.frame()
  
  for (c in c("preg","status")) {
    
    m <- "emmreml"
  
    for (trt in c("allTrt")) {
      shortName <- paste0(c,"_",trt,"F_",thresh)
      
      model <- "modelS"
      modelpreg <- "modelQ"
  
      if (trt %in% c("Dex","Gard","allTrt")) {
        model <- "modelS"
        modelpreg <- "modelQ"
      }
      
      if (c == "status") {
        emmremlResults <- read.table(paste0(outDir,"allBatches_F_",trt,"_10000genes_",thresh,"_",modelpreg,"_allTrtF_emmreml"))
        stdBetas <- emmremlResults$beta_status / sqrt(emmremlResults$var_beta_status)
      } else if (c == "preg") {
        emmremlResults <- read.table(paste0(outDir,"allBatches_F_",trt,"_10000genes_",thresh,"_",model,"_allTrtF_emmreml"))
        stdBetas <- emmremlResults$beta_preg / sqrt(emmremlResults$var_beta_preg)
      }
      
      modelResults <- as.data.frame(stdBetas)
      rownames(modelResults) <- rownames(emmremlResults)
      colnames(modelResults) <- "stdBeta"
      
      ### using modelResults run a GSEA, and save the output
      
      ### Permutation-based GSEA tests
      ### Originally developed by Jordan Anderson and Noah Snyder-Mackler. Modified by Tauras Vilgalys. 
      ### Last updated 2020 September 16
      
      ###outside R, build a csv file with geneName,hallmarkPathway
      
      # Parameter options on lines 11 and 12
      # Data and files to load on lines 16 and 30
      ## parameters to consider: 
      pvals <- F ## are data in pvalues or betas? If betas, set pvals to FALSE
      weight <- 1 ## Weight to place on betas. Typically either a 1 or a 0, where 0 weights all effects equally.
              ## weight=0 acts like a KS test, and is typically used with pvalues. 
      
      sampleBetas <- as.data.frame(rownames(modelResults))
      sampleBetas$Betas <- modelResults$stdBeta
      
      colnames(sampleBetas) <- c("Gene","Betas")
  
      gene.list <- sampleBetas$Gene
    
      ## get nperm permutations of the vector of Betas
      nperm <- 1000
      for (i in 1:nperm) {
        tmpB <- sample(sampleBetas$Beta)
        cbind(sampleBetas,tmpB) -> sampleBetas; rm(tmpB)
      }; rm(i)#; head(sampleBetas)
  
      ## Get the list of gene sets to test. here the file starts with gene names and the associated GO terms. 
      ## i downloaded these hallmark gene sets from https://www.gsea-msigdb.org/gsea/msigdb/collections.jsp
  
      gene.set <- read.table(paste0(dataDir,"hallmarkPathways_wCategories.csv"), sep = ",")
      
      colnames(gene.set) <- c("Associated.Gene.Name","GO.Term.Accession","Category")
  
      gene.set$gene_GO <- paste0(gene.set$Associated.Gene.Name,"_",gene.set$GO.Term.Accession)
  
      # Trim for expressed genes where B was estimated
      gene.set2 <- subset(gene.set, gene.set$Associated.Gene.Name %in% sampleBetas$Gene)
  
      # Remove duplicated gene/GO pairings
      gene.set2 <- gene.set2[!duplicated(gene.set2$gene_GO),]
  
      ## Get list of gene ontologies to test, and the number of genes in each
      GO_res <- as.data.frame(matrix(ncol=2, nrow=length(unique(gene.set2$GO.Term.Accession)), unique(gene.set2$GO.Term.Accession)))
      GO_res$V2 <- 0
      GO_res <- GO_res[!(GO_res$V1 == ""),]; colnames(GO_res) <- c("GO", "n_genes")
      
      for (i in 1:nrow(GO_res)) {
        GO_res$n_genes[i] <- sum(gene.set2$GO.Term.Accession == GO_res$GO[i])
      }
      
      rm(i)
      GO_res$n_genes <- as.numeric(GO_res$n_genes)
      
      ## Only consider gene sets with at least 5 measured genes
      GO_res <- subset(GO_res, n_genes >= 5)
      
      ## Create a matrix of just the effect sizes, moving the gene names to the row.names
      effect_size_matrix <- sampleBetas[,-1]
      row.names(effect_size_matrix) <- sampleBetas[,1]
  
      ## Run GSEA function for each GO term (defined earlier in GO_res$GO)
      output<-GSEA(effect_size_matrix = effect_size_matrix,
                   gene_set_list = unique(GO_res$GO),
                   gene_GO_associations = gene.set2,
                   weight = 1, pvals=F)
      
      names(output) <- c("NES_matrix_upreg","NES_matrix_downreg","p_values")
    
      # Normalize + ES' by the mean of + ES values, and - ES' by the mean of - ES null values for that gene set. 
      ##This should effectively control for differences in gene set size
      pos.ES.norm<-matrix(0,nrow=nrow(GO_res),ncol=nperm+1)
      neg.ES.norm<-matrix(0,nrow=nrow(GO_res),ncol=nperm+1)
      
      for (i in 1:length(GO_res$GO)) {
        pos.ES <- unlist(output$NES_matrix_upreg[i,])
        names(pos.ES)<-NULL
        neg.ES <- unlist(output$NES_matrix_downreg[i,])
        names(neg.ES)<-NULL
  
        #for a given gene set, N, calculate the mean of the positive max ES for estimated+ permuted ES.
        #calculate the mean of the max negative ES for estimate+ permuted ES also
         pos.m <- mean(pos.ES)
         neg.m <- mean(abs(neg.ES))
         
         #Then for each permutation in that geneset, scale ES by this mean value, depending on if it was max + or max - ES
         for (j in 1:(nperm+1)){
           pos.ES.norm[i,j]<-pos.ES[j]/pos.m
           neg.ES.norm[i,j]<-neg.ES[j]/neg.m
         }
      }
      
      # FDR? 
      ## Calculate p-values for one of the null distributions as well
      perm_upreg <- apply(output$NES_matrix_upreg[,-1],1,function(x) {ee <- ecdf(x[2:length(x)]); 1 - ee(x[1])})
      perm_downreg <- apply(output$NES_matrix_downreg[,-1],1,function(x) {ee <- ecdf(x[2:length(x)]); 1 - ee(x[1])})
      ## Use perm.fdr function (written by Joaquin Sanz, available from Snyder-Mackler et al. 2016: 
      ## https://github.com/nsmackler/status_genome_2016/blob/master/perm_FDR.R)
      
      fdr_up <- perm.fdr(output$p_values, perm_upreg, "pval_upreg", "fdr_vsPerm1")
      fdr_down <- perm.fdr(output$p_values, perm_upreg, "pval_downreg", "fdr_vsPerm1")
      
      upregNES <- output$NES_matrix_upreg[,1]
      dnregNES <- output$NES_matrix_downreg[,1]
      
      cbind(as.character(GO_res$GO),output$p_values)
  
      #plot significant effects
      betasOnly <- as.data.frame(effect_size_matrix$Betas)
      rownames(betasOnly) <- rownames(effect_size_matrix)
      colnames(betasOnly) <- c("betas")
      betasOnly$rank <- rank(-betasOnly$betas)
    
      dir.create(paste0(figDir,shortName))
      
      for (r in 1:2) {
        if(sum(output$p_values[,r] < .05) > 0) {
          for (g in which(output$p_values[,r] < .05)) {
            pathwayName <- as.character(GO_res$GO)[g]
            pathwayGenes <- subset(gene.set2, GO.Term.Accession == pathwayName)$Associated.Gene.Name
            betasOnly$pathway <- FALSE
            betasOnly$pathway <- rownames(effect_size_matrix) %in% pathwayGenes
            
            betasPathway <- subset(betasOnly, pathway)
            ggplot() +
              geom_linerange(aes(x = betasOnly$rank, ymax = betasOnly$betas, ymin = 0), alpha = 66/dim(effect_size_matrix)[1]) +
              geom_linerange(aes(x = betasPathway$rank, ymax = betasPathway$betas, ymin = 0)) +
              xlab("Rank") + ggtitle(pathwayName, 
                                     subtitle = paste0(subset(GO_res, GO == pathwayName)$n_genes," genes, ",
                                                       "p = ",as.numeric(output$p_values[g,r]),"    ",colnames(output$p_values)[r],
                                                       "      ",m,"-",shortName))
            ggsave(paste0(figDir,"/",shortName,"/gsea_stickPlot_",m,"_Enriched_",pathwayName,".png"), width = 6, height = 4)
          }
        }
      }
      
      gseaTreatment <- output
      
      sigList <- gseaTreatment$p_values[,1] < .05 | gseaTreatment$p_values[,2] < .05
      
      sigPathways <- as.data.frame(cbind(as.character(GO_res$GO),
                                         gseaTreatment$p_values,
                                         gseaTreatment$NES_matrix_upreg[,1],
                                         gseaTreatment$NES_matrix_downreg[,1],
                                         shortName,
                                         m,
                                         c,
                                         trt)[sigList,])
      
      allPathways <- as.data.frame(cbind(as.character(GO_res$GO),
                                         gseaTreatment$p_values,gseaTreatment$NES_matrix_upreg[,1],
                                         gseaTreatment$NES_matrix_downreg[,1],
                                         shortName,
                                         m,
                                         c,
                                         trt))
    
      if( dim(allSigTrtPathways)[1] == 0) {
        allSigTrtPathways <- sigPathways
        allTrtPathways <- allPathways
      } else {
          allSigTrtPathways <- rbind(allSigTrtPathways,sigPathways)
          allTrtPathways <- rbind(allTrtPathways,allPathways)
      }
    }
  }
  
  write.table(x = allSigTrtPathways, file = paste0(outDir,"gsea_multiTrt_GSEA_sigResults.txt"), quote = F, row.names = F, sep = ",")
  write.table(x = allTrtPathways, file = paste0(outDir,"gsea_multiTrt_GSEA_allResults.txt"), quote = F, row.names = F, sep = ",")
  
  
  geneSetSort <- unique(gene.set[,2:3])
  geneSetSort <- geneSetSort[order(geneSetSort$Category),]
  geneSetSort$pathwayShort <- str_remove(geneSetSort$GO.Term.Accession, "HALLMARK_")
  
  plotAllSigTrtPathways <- allSigTrtPathways
  
  colnames(plotAllSigTrtPathways)[c(1,4,5)] <- c("pathway","ESup","ESdown") 
  colnames(plotAllSigTrtPathways)[c(6,7)] <- c("species","model") 
  
  plotAllSigTrtPathways$sigPVal <- ifelse(plotAllSigTrtPathways$pval_upreg < plotAllSigTrtPathways$pval_downreg,
                                          plotAllSigTrtPathways$pval_upreg, plotAllSigTrtPathways$pval_downreg)
  
  plotAllSigTrtPathways$sigES <- ifelse(plotAllSigTrtPathways$pval_upreg < plotAllSigTrtPathways$pval_downreg,
                                          plotAllSigTrtPathways$ESup, plotAllSigTrtPathways$ESdown)
  
  plotAllSigTrtPathways$sigPValAdj <- ifelse(plotAllSigTrtPathways$sigPVal == 0, .0001, plotAllSigTrtPathways$sigPVal)
  
  plotAllSigTrtPathways$sigES <- as.numeric(plotAllSigTrtPathways$sigES)
  plotAllSigTrtPathways$sigPValAdj <- as.numeric(plotAllSigTrtPathways$sigPValAdj)
  
  
  #plotAllSigTrtPathways$conditionMethod <- paste0(plotAllSigTrtPathways$condition,"_",plotAllSigTrtPathways$tpMethod)
  
  
  ggplot(data = plotAllSigTrtPathways, aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point()
  
  
  #todo - remove "hallmark_"
  plotAllSigTrtPathways$pathway <- str_remove(plotAllSigTrtPathways$pathway, "HALLMARK_")
  
  
  #plotAllSigTrtPathways$condModel <- paste0(plotAllSigTrtPathways$condition,"_",plotAllSigTrtPathways$model)
  
  #change angle of names (bottom)
  
  ggplot(data = plotAllSigTrtPathways, aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
  
  #viridis color scheme
  
  #sort by number of conditions & up/down reg elo
  pathwayList <- unique(plotAllSigTrtPathways$pathway)
  meanES <- vector()
  
  for (p in pathwayList) {
    meanES <- c(meanES,mean(subset(plotAllSigTrtPathways, pathway == p)$sigES))
  }
  
  pathwayList <- pathwayList[order(-meanES)]
  
  plotAllSigTrtPathways$pathway <- factor(plotAllSigTrtPathways$pathway, levels = pathwayList)
  
  
  
  pathwayList <- unique(plotAllSigTrtPathways$pathway)
  meanES <- vector()
  
  for (p in pathwayList) {
    meanES <- c(meanES,mean(subset(plotAllSigTrtPathways, pathway == p)$sigES))
  }
  
  pathwayList <- pathwayList[order(-meanES)]
  
  plotAllSigTrtPathways$pathway <- factor(plotAllSigTrtPathways$pathway, levels = pathwayList)
  
  
  ggplot(data = subset(plotAllSigTrtPathways, c == "status"), aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("status - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_F_allTrt_status_plot_viridis_emreml_",thresh,".png"), width = 8, height = 6)
  
  ggplot(data = subset(plotAllSigTrtPathways, c == "preg"), aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("preg - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_F_allTrt_preg_plot_viridis_emreml_",thresh,".png"), width = 8, height = 6)
  
  
  immunePathways <- c("TNFA_SIGNALING_VIA_NFKB",
                      "INFLAMMATORY_RESPONSE",
                      "INTERFERON_ALPHA_RESPONSE",
                      "INTERFERON_GAMMA_RESPONSE",
                      "COMPLEMENT",
                      "CTRA_UP",
                      "CTRA_DOWN")
  
  ggplot(data = subset(plotAllSigTrtPathways, pathway %in% immunePathways & c == "status"), 
         aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("status - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_F_allTrt_status_plot_viridis_emreml_ImmunePaths_",thresh,".png"), width = 8, height = 6)
  
  ggplot(data = subset(plotAllSigTrtPathways, pathway %in% immunePathways & c == "preg"), 
         aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("preg - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_F_allTrt_preg_plot_viridis_emreml_ImmunePaths_",thresh,".png"), width = 8, height = 6)
  
  ggplot(data = subset(plotAllSigTrtPathways, pathway %in% immunePathways), 
         aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("preg - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_F_allTrt_plot_viridis_emreml_ImmunePaths_",thresh,".png"), width = 8, height = 4)
  
  
  plotAllSigTrtPathways$pathway <- factor(plotAllSigTrtPathways$pathway, levels = geneSetSort$pathwayShort)
  
  ## plot the pathways with multiple sig hits
  sigPaths <- names(table(plotAllSigTrtPathways$pathway)[table(plotAllSigTrtPathways$pathway) > 1])
  
  ggplot(data = subset(plotAllSigTrtPathways, pathway %in% sigPaths), aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("emreml - sig GSEA in > 1 pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
  ggsave(paste0(figDir,"GSEA_condition_F_allTrt_plot_viridis_emreml_SigPaths_gt2_",thresh,".png"), width = 8, height = 6)
  
  p <- "MYC_TARGETS_V1"
  t <- "LPS"
  
  for (t in unique(plotAllSigTrtPathways$trt)) {
    print(t)
    pathSig <- vector()
    
    for (p in geneSetSort$pathwayShort) {
      cSig <- subset(plotAllSigTrtPathways, trt == t & pathway == p)$c
      
      if (length(cSig) == 2) {
        pathSig <- c(pathSig,"both")
      } else if (length(cSig) == 1) {
        if (cSig == "preg") {
          pathSig <- c(pathSig,"preg")
        } else {
          pathSig <- c(pathSig,"status")
        }
      } else {
        pathSig <- c(pathSig,"none")
      }
    }
    gseaFETMat <- matrix(c(sum(pathSig == "both"),
                           sum(pathSig == "preg"),
                           sum(pathSig == "status"),
                           sum(pathSig == "none")), nrow = 2)
  
    #fishP <- signif(fisher.test(fishDat)$p.value, digits = 3)
    #sigGeneDiff <- signif(fishDat - chisq.test(fishDat)$expected, digits = 3)
    #excessBoth <- sigGeneDiff[1,1]
    fishP <- signif(fisher.test(gseaFETMat)$p.value, digits = 3)
    sigGeneDiff <- signif(gseaFETMat - chisq.test(gseaFETMat)$expected, digits = 3)
    excessBoth <- sigGeneDiff[1,1]
    print(paste0(fishP," ",excessBoth))
  }
}
```

```{r All Treatments GSEA Male}
#emreml and mash results


#for (c in c("InfluenzaA","Control18h","Control15h","LPS","Dex","Gardiquimod","IL15","NCSGE1","LPSSGE1")) {

## loop through data sets

c <- "status"
trt <- "allTrt"
thresh <- "5lCPM"

for (thresh in c("5lCPM","7lCPM")) {
  allSigTrtPathways <- data.frame()
  allTrtPathways <- data.frame()
  
  for (c in c("status")) {
    
    m <- "emmreml"
  
    for (trt in c("allTrt")) {
      shortName <- paste0(c,"_",trt,"M_",thresh)
      
      model <- "modelG"
      
      if (c == "status") {
        emmremlResults <- read.table(paste0(outDir,"allBatches_M_",trt,"_10000genes_",thresh,"_",model,"_allTrtM_emmreml"))
        stdBetas <- emmremlResults$beta_status / sqrt(emmremlResults$var_beta_status)
      } 
      modelResults <- as.data.frame(stdBetas)
      rownames(modelResults) <- rownames(emmremlResults)
      colnames(modelResults) <- "stdBeta"
      
      ### using modelResults run a GSEA, and save the output
      
      ### Permutation-based GSEA tests
      ### Originally developed by Jordan Anderson and Noah Snyder-Mackler. Modified by Tauras Vilgalys. 
      ### Last updated 2020 September 16
      
      ###outside R, build a csv file with geneName,hallmarkPathway
      
      # Parameter options on lines 11 and 12
      # Data and files to load on lines 16 and 30
      ## parameters to consider: 
      pvals <- F ## are data in pvalues or betas? If betas, set pvals to FALSE
      weight <- 1 ## Weight to place on betas. Typically either a 1 or a 0, where 0 weights all effects equally.
              ## weight=0 acts like a KS test, and is typically used with pvalues. 
      
      sampleBetas <- as.data.frame(rownames(modelResults))
      sampleBetas$Betas <- modelResults$stdBeta
      
      colnames(sampleBetas) <- c("Gene","Betas")
  
      gene.list <- sampleBetas$Gene
    
      ## get nperm permutations of the vector of Betas
      nperm <- 1000
      for (i in 1:nperm) {
        tmpB <- sample(sampleBetas$Beta)
        cbind(sampleBetas,tmpB) -> sampleBetas; rm(tmpB)
      }; rm(i)#; head(sampleBetas)
  
      ## Get the list of gene sets to test. here the file starts with gene names and the associated GO terms. 
      ## i downloaded these hallmark gene sets from https://www.gsea-msigdb.org/gsea/msigdb/collections.jsp
  
      gene.set <- read.table(paste0(dataDir,"hallmarkPathways_wCategories.csv"), sep = ",")
      
      colnames(gene.set) <- c("Associated.Gene.Name","GO.Term.Accession","Category")
  
      gene.set$gene_GO <- paste0(gene.set$Associated.Gene.Name,"_",gene.set$GO.Term.Accession)
  
      # Trim for expressed genes where B was estimated
      gene.set2 <- subset(gene.set, gene.set$Associated.Gene.Name %in% sampleBetas$Gene)
  
      # Remove duplicated gene/GO pairings
      gene.set2 <- gene.set2[!duplicated(gene.set2$gene_GO),]
  
      ## Get list of gene ontologies to test, and the number of genes in each
      GO_res <- as.data.frame(matrix(ncol=2, nrow=length(unique(gene.set2$GO.Term.Accession)), unique(gene.set2$GO.Term.Accession)))
      GO_res$V2 <- 0
      GO_res <- GO_res[!(GO_res$V1 == ""),]; colnames(GO_res) <- c("GO", "n_genes")
      
      for (i in 1:nrow(GO_res)) {
        GO_res$n_genes[i] <- sum(gene.set2$GO.Term.Accession == GO_res$GO[i])
      }
      
      rm(i)
      GO_res$n_genes <- as.numeric(GO_res$n_genes)
      
      ## Only consider gene sets with at least 5 measured genes
      GO_res <- subset(GO_res, n_genes >= 5)
      
      ## Create a matrix of just the effect sizes, moving the gene names to the row.names
      effect_size_matrix <- sampleBetas[,-1]
      row.names(effect_size_matrix) <- sampleBetas[,1]
  
      ## Run GSEA function for each GO term (defined earlier in GO_res$GO)
      output<-GSEA(effect_size_matrix = effect_size_matrix,
                   gene_set_list = unique(GO_res$GO),
                   gene_GO_associations = gene.set2,
                   weight = 1, pvals=F)
      
      names(output) <- c("NES_matrix_upreg","NES_matrix_downreg","p_values")
    
      # Normalize + ES' by the mean of + ES values, and - ES' by the mean of - ES null values for that gene set. 
      ##This should effectively control for differences in gene set size
      pos.ES.norm<-matrix(0,nrow=nrow(GO_res),ncol=nperm+1)
      neg.ES.norm<-matrix(0,nrow=nrow(GO_res),ncol=nperm+1)
      
      for (i in 1:length(GO_res$GO)) {
        pos.ES <- unlist(output$NES_matrix_upreg[i,])
        names(pos.ES)<-NULL
        neg.ES <- unlist(output$NES_matrix_downreg[i,])
        names(neg.ES)<-NULL
  
        #for a given gene set, N, calculate the mean of the positive max ES for estimated+ permuted ES.
        #calculate the mean of the max negative ES for estimate+ permuted ES also
         pos.m <- mean(pos.ES)
         neg.m <- mean(abs(neg.ES))
         
         #Then for each permutation in that geneset, scale ES by this mean value, depending on if it was max + or max - ES
         for (j in 1:(nperm+1)){
           pos.ES.norm[i,j]<-pos.ES[j]/pos.m
           neg.ES.norm[i,j]<-neg.ES[j]/neg.m
         }
      }
      
      # FDR? 
      ## Calculate p-values for one of the null distributions as well
      perm_upreg <- apply(output$NES_matrix_upreg[,-1],1,function(x) {ee <- ecdf(x[2:length(x)]); 1 - ee(x[1])})
      perm_downreg <- apply(output$NES_matrix_downreg[,-1],1,function(x) {ee <- ecdf(x[2:length(x)]); 1 - ee(x[1])})
      ## Use perm.fdr function (written by Joaquin Sanz, available from Snyder-Mackler et al. 2016: 
      ## https://github.com/nsmackler/status_genome_2016/blob/master/perm_FDR.R)
      
      fdr_up <- perm.fdr(output$p_values, perm_upreg, "pval_upreg", "fdr_vsPerm1")
      fdr_down <- perm.fdr(output$p_values, perm_upreg, "pval_downreg", "fdr_vsPerm1")
      
      upregNES <- output$NES_matrix_upreg[,1]
      dnregNES <- output$NES_matrix_downreg[,1]
      
      cbind(as.character(GO_res$GO),output$p_values)
  
      #plot significant effects
      betasOnly <- as.data.frame(effect_size_matrix$Betas)
      rownames(betasOnly) <- rownames(effect_size_matrix)
      colnames(betasOnly) <- c("betas")
      betasOnly$rank <- rank(-betasOnly$betas)
    
      dir.create(paste0(figDir,shortName))
      
      for (r in 1:2) {
        if(sum(output$p_values[,r] < .05) > 0) {
          for (g in which(output$p_values[,r] < .05)) {
            pathwayName <- as.character(GO_res$GO)[g]
            pathwayGenes <- subset(gene.set2, GO.Term.Accession == pathwayName)$Associated.Gene.Name
            betasOnly$pathway <- FALSE
            betasOnly$pathway <- rownames(effect_size_matrix) %in% pathwayGenes
            
            betasPathway <- subset(betasOnly, pathway)
            ggplot() +
              geom_linerange(aes(x = betasOnly$rank, ymax = betasOnly$betas, ymin = 0), alpha = 66/dim(effect_size_matrix)[1]) +
              geom_linerange(aes(x = betasPathway$rank, ymax = betasPathway$betas, ymin = 0)) +
              xlab("Rank") + ggtitle(pathwayName, 
                                     subtitle = paste0(subset(GO_res, GO == pathwayName)$n_genes," genes, ",
                                                       "p = ",as.numeric(output$p_values[g,r]),"    ",colnames(output$p_values)[r],
                                                       "      ",m,"-",shortName))
            ggsave(paste0(figDir,"/",shortName,"/gsea_stickPlot_",m,"_Enriched_",pathwayName,".png"), width = 6, height = 4)
          }
        }
      }
      
      gseaTreatment <- output
      
      sigList <- gseaTreatment$p_values[,1] < .05 | gseaTreatment$p_values[,2] < .05
      
      sigPathways <- as.data.frame(cbind(as.character(GO_res$GO),
                                         gseaTreatment$p_values,
                                         gseaTreatment$NES_matrix_upreg[,1],
                                         gseaTreatment$NES_matrix_downreg[,1],
                                         shortName,
                                         m,
                                         c,
                                         trt)[sigList,])
      
      allPathways <- as.data.frame(cbind(as.character(GO_res$GO),
                                         gseaTreatment$p_values,gseaTreatment$NES_matrix_upreg[,1],
                                         gseaTreatment$NES_matrix_downreg[,1],
                                         shortName,
                                         m,
                                         c,
                                         trt))
    
      if( dim(allSigTrtPathways)[1] == 0) {
        allSigTrtPathways <- sigPathways
        allTrtPathways <- allPathways
      } else {
          allSigTrtPathways <- rbind(allSigTrtPathways,sigPathways)
          allTrtPathways <- rbind(allTrtPathways,allPathways)
      }
    }
  }
  
  write.table(x = allSigTrtPathways, file = paste0(outDir,"gsea_multiTrt_GSEA_sigResults.txt"), quote = F, row.names = F, sep = ",")
  write.table(x = allTrtPathways, file = paste0(outDir,"gsea_multiTrt_GSEA_allResults.txt"), quote = F, row.names = F, sep = ",")
  
  
  geneSetSort <- unique(gene.set[,2:3])
  geneSetSort <- geneSetSort[order(geneSetSort$Category),]
  geneSetSort$pathwayShort <- str_remove(geneSetSort$GO.Term.Accession, "HALLMARK_")
  
  plotAllSigTrtPathways <- allSigTrtPathways
  
  colnames(plotAllSigTrtPathways)[c(1,4,5)] <- c("pathway","ESup","ESdown") 
  colnames(plotAllSigTrtPathways)[c(6,7)] <- c("species","model") 
  
  plotAllSigTrtPathways$sigPVal <- ifelse(plotAllSigTrtPathways$pval_upreg < plotAllSigTrtPathways$pval_downreg,
                                          plotAllSigTrtPathways$pval_upreg, plotAllSigTrtPathways$pval_downreg)
  
  plotAllSigTrtPathways$sigES <- ifelse(plotAllSigTrtPathways$pval_upreg < plotAllSigTrtPathways$pval_downreg,
                                          plotAllSigTrtPathways$ESup, plotAllSigTrtPathways$ESdown)
  
  plotAllSigTrtPathways$sigPValAdj <- ifelse(plotAllSigTrtPathways$sigPVal == 0, .0001, plotAllSigTrtPathways$sigPVal)
  
  plotAllSigTrtPathways$sigES <- as.numeric(plotAllSigTrtPathways$sigES)
  plotAllSigTrtPathways$sigPValAdj <- as.numeric(plotAllSigTrtPathways$sigPValAdj)
  
  
  #plotAllSigTrtPathways$conditionMethod <- paste0(plotAllSigTrtPathways$condition,"_",plotAllSigTrtPathways$tpMethod)
  
  
  ggplot(data = plotAllSigTrtPathways, aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point()
  
  
  #todo - remove "hallmark_"
  plotAllSigTrtPathways$pathway <- str_remove(plotAllSigTrtPathways$pathway, "HALLMARK_")
  
  
  #plotAllSigTrtPathways$condModel <- paste0(plotAllSigTrtPathways$condition,"_",plotAllSigTrtPathways$model)
  
  #change angle of names (bottom)
  
  ggplot(data = plotAllSigTrtPathways, aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
  
  #viridis color scheme
  
  #sort by number of conditions & up/down reg elo
  pathwayList <- unique(plotAllSigTrtPathways$pathway)
  meanES <- vector()
  
  for (p in pathwayList) {
    meanES <- c(meanES,mean(subset(plotAllSigTrtPathways, pathway == p)$sigES))
  }
  
  pathwayList <- pathwayList[order(-meanES)]
  
  plotAllSigTrtPathways$pathway <- factor(plotAllSigTrtPathways$pathway, levels = pathwayList)
  
  
  
  pathwayList <- unique(plotAllSigTrtPathways$pathway)
  meanES <- vector()
  
  for (p in pathwayList) {
    meanES <- c(meanES,mean(subset(plotAllSigTrtPathways, pathway == p)$sigES))
  }
  
  pathwayList <- pathwayList[order(-meanES)]
  
  plotAllSigTrtPathways$pathway <- factor(plotAllSigTrtPathways$pathway, levels = pathwayList)
  
  
  ggplot(data = subset(plotAllSigTrtPathways, c == "status"), aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("status - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_status_M_allTrt_plot_viridis_emreml_",thresh,".png"), width = 8, height = 6)
  
  immunePathways <- c("TNFA_SIGNALING_VIA_NFKB",
                      "INFLAMMATORY_RESPONSE",
                      "INTERFERON_ALPHA_RESPONSE",
                      "INTERFERON_GAMMA_RESPONSE",
                      "COMPLEMENT",
                      "CTRA_UP",
                      "CTRA_DOWN")
  
  ggplot(data = subset(plotAllSigTrtPathways, pathway %in% immunePathways & c == "status"), 
         aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("status - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_status_M_allTrt_plot_viridis_emreml_ImmunePaths_",thresh,".png"), width = 8, height = 6)
  
  ggplot(data = subset(plotAllSigTrtPathways, pathway %in% immunePathways), 
         aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("preg - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_M_allTrt_plot_viridis_emreml_ImmunePaths_",thresh,".png"), width = 8, height = 4)
  
  
  plotAllSigTrtPathways$pathway <- factor(plotAllSigTrtPathways$pathway, levels = geneSetSort$pathwayShort)
  

  p <- "MYC_TARGETS_V1"
  t <- "LPS"
  
  for (t in unique(plotAllSigTrtPathways$trt)) {
    print(t)
    pathSig <- vector()
    
    for (p in geneSetSort$pathwayShort) {
      cSig <- subset(plotAllSigTrtPathways, trt == t & pathway == p)$c
      
      if (length(cSig) == 2) {
        pathSig <- c(pathSig,"both")
      } else if (length(cSig) == 1) {
        if (cSig == "preg") {
          pathSig <- c(pathSig,"preg")
        } else {
          pathSig <- c(pathSig,"status")
        }
      } else {
        pathSig <- c(pathSig,"none")
      }
    }
    gseaFETMat <- matrix(c(sum(pathSig == "both"),
                           sum(pathSig == "preg"),
                           sum(pathSig == "status"),
                           sum(pathSig == "none")), nrow = 2)
  
    #fishP <- signif(fisher.test(fishDat)$p.value, digits = 3)
    #sigGeneDiff <- signif(fishDat - chisq.test(fishDat)$expected, digits = 3)
    #excessBoth <- sigGeneDiff[1,1]
    fishP <- signif(fisher.test(gseaFETMat)$p.value, digits = 3)
    sigGeneDiff <- signif(gseaFETMat - chisq.test(gseaFETMat)$expected, digits = 3)
    excessBoth <- sigGeneDiff[1,1]
    print(paste0(fishP," ",excessBoth))
  }
}
```

Which genes are significant in the all-treatment dataset? (F, status & preg)
```{r all treatment model significant genes}
c <- "preg"
trt <- "allTrt"
thresh <- "5lCPM"

for (thresh in c("5lCPM","7lCPM")) {
  
  for (c in c("preg","status")) {
    
    m <- "emmreml"
  
    for (trt in c("allTrt")) {
      shortName <- paste0(c,"_",trt,"F_",thresh)
      
      model <- "modelS"
      modelpreg <- "modelQ"
  
      if (trt %in% c("Dex","Gard","allTrt")) {
        model <- "modelS"
        modelpreg <- "modelQ"
      }
      
      if (c == "status") {
        emmremlResults <- read.table(paste0(outDir,"allBatches_F_",trt,"_10000genes_",thresh,"_",modelpreg,"_allTrtF_emmreml"))
        stdBetas <- emmremlResults$beta_status / sqrt(emmremlResults$var_beta_status)
        pvals <- emmremlResults$pval_status
        names(pvals) <- rownames(emmremlResults)
      } else if (c == "preg") {
        emmremlResults <- read.table(paste0(outDir,"allBatches_F_",trt,"_10000genes_",thresh,"_",model,"_allTrtF_emmreml"))
        stdBetas <- emmremlResults$beta_preg / sqrt(emmremlResults$var_beta_preg)
        pvals <- emmremlResults$pval_preg
        names(pvals) <- rownames(emmremlResults)
      }
      
      modelResults <- as.data.frame(stdBetas)
      rownames(modelResults) <- rownames(emmremlResults)
      colnames(modelResults) <- "stdBeta"
      
      sigGeneList <- names(pvals)[qvalue(pvals)$qvalue < .1]
      allGeneList <- rownames(modelResults)
      
      assign(value = sigGeneList, x = paste0(c,thresh,"sig"))
      assign(value = allGeneList, x = paste0(c,thresh,"all"))
      
    }
  }
}

sigStatus <- unique(c(status5lCPMsig,status7lCPMsig))
saveRDS(object = sigStatus,
            file = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/data/sigStatusGenes.RDS")
```


Which genes are significant across sig-status model
```{r}
c <- "status"
trt <- "LPS"
thresh <- "statuslCPM"

for (thresh in c("statuslCPM")) {
  
  for (c in c("status")) {
    
    m <- "emmreml"
  
    for (trt in c("LPS","Dex","Ctrl","Gard")) {
      shortName <- paste0(c,"_",trt,"F_",thresh)
      
      
      modelpreg <- "modelP"
  
      if (trt %in% c("Dex","Gard","allTrt")) {
        modelpreg <- "modelQ"
      }
      
      if (c == "status") {
        emmremlResults <- read.table(paste0(outDir,"allBatches_F_",trt,"only_10000genes_",thresh,"_",modelpreg,"_basicPreg_emmreml"))
        stdBetas <- emmremlResults$beta_status / sqrt(emmremlResults$var_beta_status)
        pvals <- emmremlResults$pval_status
        names(pvals) <- rownames(emmremlResults)
      } else if (c == "preg") {
        emmremlResults <- read.table(paste0(outDir,"allBatches_F_",trt,"only_10000genes_",thresh,"_",model,"_basicPreg_emmreml"))
        stdBetas <- emmremlResults$beta_preg / sqrt(emmremlResults$var_beta_preg)
        pvals <- emmremlResults$pval_preg
        names(pvals) <- rownames(emmremlResults)
      }
      
      modelResults <- as.data.frame(stdBetas)
      rownames(modelResults) <- rownames(emmremlResults)
      colnames(modelResults) <- "stdBeta"
      
      sigGeneList <- names(pvals)[qvalue(pvals)$qvalue < .2]
      allGeneList <- rownames(modelResults)
      
      assign(value = sigGeneList, x = paste0(c,trt,"sig"))
      assign(value = allGeneList, x = paste0(c,trt,"all"))
      assign(value = stdBetas, x = paste0(c,trt,"stdBetas"))
      assign(value = pvals, x = paste0(c,trt,"pvals"))
      assign(value = qvalue(pvals)$qvalue, x = paste0(c,trt,"qvals"))
      
    }
  }
}


listInput <- list(statusLPSsig,
                  statusDexsig,
                  statusCtrlsig,
                  statusGardsig)

names(listInput) <- c("LPS","Dex","Ctrl","Gard")

testList <- fromList(listInput)

png(paste0(figDir,"statusSigGene_upsetPlot.png"), width = 1200, height = 800)
upset(data = testList, order.by = "freq", nsets = length(names(listInput)), nintersects = 20, text.scale = 2.5)
dev.off()

#make a dataframe of all the genes
statusModelResults <- cbind.data.frame(statusCtrlstdBetas,
                                       statusCtrlpvals,
                                       statusCtrlqvals,
                                       statusLPSstdBetas,
                                       statusLPSpvals,
                                       statusLPSqvals,
                                       statusDexstdBetas,
                                       statusDexpvals,
                                       statusDexqvals,
                                       statusGardstdBetas,
                                       statusGardpvals,
                                       statusGardqvals)

ggplot(data = statusModelResults,
       aes(x = statusCtrlstdBetas,
           y = statusLPSstdBetas)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y~x") +
  ylab("LPS Std Beta") + xlab("Ctrl Std Beta")
ggsave(paste0(figDir,"statusStdBeta_sigGene_LPSvCtrl.png"), width = 4, height = 4)

ggplot(data = statusModelResults,
       aes(x = statusCtrlstdBetas,
           y = statusDexstdBetas)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y~x")

ggplot(data = statusModelResults,
       aes(x = statusCtrlstdBetas,
           y = statusGardstdBetas)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y~x") +
  ylab("Gard Std Beta") + xlab("Ctrl Std Beta")
ggsave(paste0(figDir,"statusStdBeta_sigGene_GardvCtrl.png"), width = 4, height = 4)

ggplot(data = statusModelResults,
       aes(x = statusLPSstdBetas,
           y = statusGardstdBetas)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y~x") +
  ylab("Gard Std Beta") + xlab("LPS Std Beta")
ggsave(paste0(figDir,"statusStdBeta_sigGene_GardvLPS.png"), width = 4, height = 4)

#negative beta & sig

rownames(subset(statusModelResults, statusGardqvals < .2 & statusGardstdBetas < 0))

listInput <- list(rownames(subset(statusModelResults, statusLPSqvals < .2 & statusLPSstdBetas < 0)),
                  rownames(subset(statusModelResults, statusDexqvals < .2 & statusDexstdBetas < 0)),
                  rownames(subset(statusModelResults, statusCtrlqvals < .2 & statusCtrlstdBetas < 0)),
                  rownames(subset(statusModelResults, statusGardqvals < .2 & statusGardstdBetas < 0)))

names(listInput) <- c("LPS","Dex","Ctrl","Gard")

testList <- fromList(listInput)

png(paste0(figDir,"statusSigGene_upsetPlot_negBetas.png"), width = 1200, height = 800)
upset(data = testList, order.by = "freq", nsets = length(names(listInput)), nintersects = 20, text.scale = 2.5)
dev.off()


#positive beta & sig
listInput <- list(rownames(subset(statusModelResults, statusLPSqvals < .2 & statusLPSstdBetas > 0)),
                  rownames(subset(statusModelResults, statusDexqvals < .2 & statusDexstdBetas > 0)),
                  rownames(subset(statusModelResults, statusCtrlqvals < .2 & statusCtrlstdBetas > 0)),
                  rownames(subset(statusModelResults, statusGardqvals < .2 & statusGardstdBetas > 0)))

names(listInput) <- c("LPS","Dex","Ctrl","Gard")

testList <- fromList(listInput)

png(paste0(figDir,"statusSigGene_upsetPlot_posBetas.png"), width = 1200, height = 800)
upset(data = testList, order.by = "freq", nsets = length(names(listInput)), nintersects = 20, text.scale = 2.5)
dev.off()

#correlations across
ggcorr(statusModelResults[,c(1,4,7,10)], method = c("everything", "pearson"), 
       hjust = 0.5, size = 3, color = "grey50",
       label = TRUE, label_size = 3, label_round = 2) + ggtitle(paste0("treatment only - std beta cor"))
ggsave(paste0(figDir,"statusSigGene_stdBeta_ggCorr.png"), width = 4, height = 4)


disagreeGenes <- vector()
for (trtA in c(1,4,7,10)) {
  for (trtB in c(1,4,7,10)) {
    print(colnames(statusModelResults[,c(trtA,trtB)]))
    print(100 * (sum(statusModelResults[,trtA] > 0 & statusModelResults[,trtB] < 0) + sum(statusModelResults[,trtA] < 0 & statusModelResults[,trtB] > 0)) / 907)
    
    disagreeGenes <- c(disagreeGenes,rownames(statusModelResults)[statusModelResults[,trtA] > 0 & statusModelResults[,trtB] < 0])
    disagreeGenes <- c(disagreeGenes,rownames(statusModelResults)[statusModelResults[,trtA] < 0 & statusModelResults[,trtB] > 0])
  }
}

table(table(disagreeGenes)/2)

```

Are there differences in the effect of status at Trt & NC?
```{r}
c <- "status"
trt <- "LPS"
thresh <- "statuslCPM"

quad1 <- vector()
quad1sig <- vector()
quad2 <- vector()
quad2sig <- vector()
quad3 <- vector()
quad3sig <- vector()
quad4 <- vector()
quad4sig <- vector()

for (thresh in c("statuslCPM")) {
  
  for (c in c("status")) {
    
    m <- "emmreml"
  
    for (trt in c("LPS","Dex","Gard")) {
      shortName <- paste0(c,"_",trt,"F_",thresh)
      
      modelpreg <- "modelP"
  
      if (trt %in% c("Dex","Gard","allTrt")) {
        modelpreg <- "modelQ"
      }
      
      emmremlResults <- read.table(paste0(outDir,"allBatches_F_",trt,"_10000genes_",thresh,"_",modelpreg,"_nestedWPreg_emmreml"))
      emmremlResults$stdBetaTrt <- emmremlResults$beta_Trt.Status / sqrt(emmremlResults$var_beta_Trt.Status)
      emmremlResults$stdBetaCtrl <- emmremlResults$beta_Ctrl.Status / sqrt(emmremlResults$var_beta_Ctrl.Status)
      
      emmremlResults$qval_CtrlStatus <- qvalue(emmremlResults$pval_Ctrl.Status)$qvalue
      emmremlResults$qval_TrtStatus <- qvalue(emmremlResults$pval_Trt.Status)$qvalue
      
      emmremlResults$sig <- ifelse(emmremlResults$qval_CtrlStatus < .1,
                                   ifelse(emmremlResults$qval_TrtStatus < .1, "both","Ctrl"),
                                   ifelse(emmremlResults$qval_TrtStatus < .1, "Trt","none"))
      
      emmremlResults$quad <- ifelse(emmremlResults$stdBetaTrt > 0 & emmremlResults$stdBetaCtrl > 0, "1",
                                    ifelse(emmremlResults$stdBetaTrt > 0 & emmremlResults$stdBetaCtrl < 0, "2",
                                           ifelse(emmremlResults$stdBetaTrt < 0 & emmremlResults$stdBetaCtrl < 0, "3","4")))
      
      ggplot(data = emmremlResults,
       aes(x = stdBetaCtrl,
           y = stdBetaTrt)) +
        geom_hline(yintercept = 0, col = "gray70") + 
        geom_vline(xintercept = 0, col = "gray70") +
        geom_smooth(method = "lm", formula = "y~x", col = "gray50") +
        geom_point(aes(col = sig)) +
        ylab(paste0(trt,":Status Std Beta")) + xlab("Ctrl:Status Std Beta") +
        labs(col = "FDR < 0.10")
      ggsave(paste0(figDir,"status_nested_StdBeta_sigGene_",trt,"vCtrl.png"), width = 6, height = 4)
      
      ggplot(data = emmremlResults,
             aes(x = stdBetaCtrl,
                 y = stdBetaTrt)) +
        geom_hline(yintercept = 0, col = "gray70") + 
        geom_vline(xintercept = 0, col = "gray70") +
        geom_smooth(method = "lm", formula = "y~x", col = "gray50") +
        geom_point(aes(col = quad)) +
        ylab(paste0(trt,":Status Std Beta")) + xlab("Ctrl:Status Std Beta") +
        labs(col = "Quad")

      
      quad1 <- c(quad1,rownames(subset(emmremlResults, quad == "1")))
      quad1sig <- c(quad1sig,rownames(subset(emmremlResults, quad == "1" & sig != "none")))      
      quad2 <- c(quad2,rownames(subset(emmremlResults, quad == "2")))
      quad2sig <- c(quad2sig,rownames(subset(emmremlResults, quad == "2" & sig != "none")))
      quad3 <- c(quad3,rownames(subset(emmremlResults, quad == "3")))
      quad3sig <- c(quad3sig,rownames(subset(emmremlResults, quad == "3" & sig != "none")))
      quad4 <- c(quad4,rownames(subset(emmremlResults, quad == "4")))
      quad4sig <- c(quad4sig,rownames(subset(emmremlResults, quad == "4" & sig != "none")))

    }
  }
}

#what is in quad2 or quad4 genes?
gene.set <- read.table(paste0(dataDir,"hallmarkPathways_wCategories.csv"), sep = ",")
colnames(gene.set) <- c("Associated.Gene.Name","GO.Term.Accession","Category")
gene.set$gene_GO <- paste0(gene.set$Associated.Gene.Name,"_",gene.set$GO.Term.Accession)


q4df <- as.data.frame(sort(unique(quad4)))
q2df <- as.data.frame(sort(unique(quad2)))

q4df$pathway <- FALSE
q2df$pathway <- FALSE

colnames(q2df)[1] <- "gene"
colnames(q4df)[1] <- "gene"

q2df$pathway <- q2df$gene %in% gene.set$Associated.Gene.Name
q4df$pathway <- q4df$gene %in% gene.set$Associated.Gene.Name

q2df$nTrts <- table(quad2)
q4df$nTrts <- table(quad4)

### create a column for each of the immmune pathways
immunePaths <- c(unique(gene.set[gene.set$Category == "immune",]$GO.Term.Accession),"HALLMARK_TNFA_SIGNALING_VIA_NFKB")

q2df <- cbind.data.frame(q2df,matrix(0,nrow = dim(q2df)[1], ncol = length(immunePaths)))
q4df <- cbind.data.frame(q4df,matrix(0,nrow = dim(q4df)[1], ncol = length(immunePaths)))

colnames(q2df) <- c("gene","pathway","nTrts",str_remove_all(immunePaths,"HALLMARK_"))
colnames(q4df) <- c("gene","pathway","nTrts",str_remove_all(immunePaths,"HALLMARK_"))

#which genes are in which pathways
for (path in immunePaths) {
  #path <- "HALLMARK_INFLAMMATORY_RESPONSE"
  pCol <- 3 + which(immunePaths == path)
  q2df[,pCol] <- q2df$gene %in% subset(gene.set, GO.Term.Accession == path)$Associated.Gene.Name
  q4df[,pCol] <- q4df$gene %in% subset(gene.set, GO.Term.Accession == path)$Associated.Gene.Name
}

sum(q2df$pathway)
sum(q4df$pathway)

colSums(q2df[,4:11])
colSums(q4df[,4:11])

#in any immune pathway
q2df$immunePath <- FALSE
for (r in 1:dim(q2df)[1]) {
  q2df$immunePath[r] <- any(q2df[r,4:11])
}

q4df$immunePath <- FALSE
for (r in 1:dim(q4df)[1]) {
  q4df$immunePath[r] <- any(q4df[r,4:11])
}


sum(q2df$immunePath) / sum(q2df$pathway)
sum(q4df$immunePath) / sum(q4df$pathway)

sum(q2df$INFLAMMATORY_RESPONSE | q2df$TNFA_SIGNALING_VIA_NFKB)
sum(q2df$INFLAMMATORY_RESPONSE | q2df$TNFA_SIGNALING_VIA_NFKB) / sum(q2df$pathway)
sum(q4df$INFLAMMATORY_RESPONSE | q4df$TNFA_SIGNALING_VIA_NFKB)
sum(q4df$INFLAMMATORY_RESPONSE | q4df$TNFA_SIGNALING_VIA_NFKB) / sum(q4df$pathway)

#flipping genes
flipQuadGenes <- q2df[q2df$gene %in% q4df$gene,]
colnames(flipQuadGenes)[3] <- "nTrtsQ2"
flipQuadGenes$nTrtsQ4 <- q4df$nTrts[q4df$gene %in% q2df$gene]

flipQuadGenes$quadLPS <- ""
flipQuadGenes$quadDex <- ""
flipQuadGenes$quadGard <- ""

thresh <- "statuslCPM"
c <- "status"
trt <- "LPS"

for (trt in c("LPS","Dex","Gard")) {
  shortName <- paste0(c,"_",trt,"F_",thresh)

  modelpreg <- "modelP"
  
  flipCol <- which(colnames(flipQuadGenes) == paste0("quad",trt))

  if (trt %in% c("Dex","Gard","allTrt")) {
    modelpreg <- "modelQ"
  }
  
  emmremlResults <- read.table(paste0(outDir,"allBatches_F_",trt,"_10000genes_",thresh,"_",modelpreg,"_nestedWPreg_emmreml"))
  emmremlResults$stdBetaTrt <- emmremlResults$beta_Trt.Status / sqrt(emmremlResults$var_beta_Trt.Status)
  emmremlResults$stdBetaCtrl <- emmremlResults$beta_Ctrl.Status / sqrt(emmremlResults$var_beta_Ctrl.Status)
  emmremlResults$quad <- ifelse(emmremlResults$stdBetaTrt > 0 & emmremlResults$stdBetaCtrl > 0, "1",
                                    ifelse(emmremlResults$stdBetaTrt > 0 & emmremlResults$stdBetaCtrl < 0, "2",
                                           ifelse(emmremlResults$stdBetaTrt < 0 & emmremlResults$stdBetaCtrl < 0, "3","4")))
  
  for (g in flipQuadGenes$gene) {
    gRow <- which(flipQuadGenes$gene == g)
    geneResult <- emmremlResults[rownames(emmremlResults) == g,]
    
    if (geneResult$quad == "2") {
      flipQuadGenes[gRow,flipCol] <- "2"
    } else if (geneResult$quad == "4") {
      flipQuadGenes[gRow,flipCol] <- "4"
    }
  }
}

ggplot() +
  geom_histogram(aes(x = emmremlResults$stdBetaCtrl), alpha = 1/3, fill = "blue") +
  geom_histogram(aes(x = emmremlResults$stdBetaTrt), alpha = 1/3, fill = "red")

```

compare interaction betas
```{r}
#LPS v (Dex, Gard)
c <- "status"
trtA <- "LPS"
trtB <- "Dex"
thresh <- "statuslCPM"

# quad2 <- vector()
# quad2sig <- vector()
# quad4 <- vector()
# quad4sig <- vector()

for (thresh in c("statuslCPM")) {
  
  for (c in c("status")) {
    
    m <- "emmreml"
    for (trtA in c("LPS","Dex","Gard")) {
      
          shortNameA <- paste0(c,"_",trtA,"F_",thresh)
          
          modelpregA <- "modelP"
          
          if (trtA %in% c("Dex","Gard","allTrt")) {
            modelpregA <- "modelQ"
          }
      
          emmremlResultsA <- read.table(paste0(outDir,"allBatches_F_",trtA,"_10000genes_",thresh,"_",modelpregA,"_nestedWPreg_emmreml"))
          emmremlResultsA$stdBetaTrt <- emmremlResultsA$beta_Trt.Status / sqrt(emmremlResultsA$var_beta_Trt.Status)
          emmremlResultsA$stdBetaCtrl <- emmremlResultsA$beta_Ctrl.Status / sqrt(emmremlResultsA$var_beta_Ctrl.Status)
          
          emmremlResultsA$qval_CtrlStatus <- qvalue(emmremlResultsA$pval_Ctrl.Status)$qvalue
          emmremlResultsA$qval_TrtStatus <- qvalue(emmremlResultsA$pval_Trt.Status)$qvalue
          
          emmremlResultsA$sig <- ifelse(emmremlResultsA$qval_CtrlStatus < .1,
                                       ifelse(emmremlResultsA$qval_TrtStatus < .1, "both","Ctrl"),
                                       ifelse(emmremlResultsA$qval_TrtStatus < .1, "Trt","none"))
          
          
          ### calc interaction beta
          emmremlResultsA$beta_Interaction <- emmremlResultsA$beta_Trt.Status - emmremlResultsA$beta_Ctrl.Status

          ### calc interaction var
          emmremlResultsA$var_beta_Interaction <- sqrt(emmremlResultsA$var_beta_Trt.Status^2 + emmremlResultsA$var_beta_Ctrl.Status^2)

          ### calc interaction std beta
          emmremlResultsA$stdBeta_Interaction <- emmremlResultsA$beta_Interaction / sqrt(emmremlResultsA$var_beta_Interaction)

          ### calc interaction t-value
          #emmremlResultsA$t_Interaction <- emmremlResultsA$beta_Trt.Status - emmremlResultsA$beta_Ctrl.Status
          #emmremlResultsB$t_Interaction <- emmremlResultsB$beta_Trt.Status - emmremlResultsB$beta_Ctrl.Status
          
          ### calc interaction p-value
          emmremlResultsA$pval_Interaction <- 2 * ifelse(emmremlResultsA$stdBeta_Interaction < 0,
                                                         pt(q=emmremlResultsA$stdBeta_Interaction, df = Inf, lower.tail=TRUE),
                                                         pt(q=emmremlResultsA$stdBeta_Interaction, df = Inf, lower.tail=FALSE))

          emmremlResultsA$sigInteraction <- ifelse(emmremlResultsA$pval_Interaction < .05, "sig", "n.s.")
          
          emmremlResultsA$intandTrtDir <- ifelse(emmremlResultsA$beta_treatment > 0,
                                                 ifelse(emmremlResultsA$stdBeta_Interaction > 0, "trtUp-intUp", "trtUp-intDown"),
                                                        ifelse(emmremlResultsA$stdBeta_Interaction > 0, "trtDwn-intUp", "trtDwn-intDwn"))

          
          ggplot() +
            geom_vline(xintercept = 0, col = "gray70") +
            geom_hline(yintercept = 0, col = "gray70") +
            geom_abline(slope = 1, intercept = 0, col = "gray20") +
            geom_point(aes(x = emmremlResultsA$stdBetaCtrl,
                           y = emmremlResultsA$stdBetaTrt,
                           col = emmremlResultsA$sigInteraction)) +
            labs(col = "Interaction\np < 0.05") +
            xlab(paste0("Ctrl:Status Std Beta")) +
            ylab(paste0(trtA,":Status Std Beta"))
          ggsave(paste0(figDir,"status_Betas_colSigInteraction_sigGene_",trtA,"vCtrl.png"), width = 6, height = 4)
          
          ggplot() +
            geom_vline(xintercept = 0, col = "gray70") +
            geom_hline(yintercept = 0, col = "gray70") +
            geom_abline(slope = 1, intercept = 0, col = "gray20") +
            geom_point(aes(x = emmremlResultsA$stdBetaCtrl,
                           y = emmremlResultsA$stdBetaTrt,
                           col = emmremlResultsA$intandTrtDir)) +
            labs(col = "Int & Trt\nDirection") +
            xlab(paste0("Ctrl:Status Std Beta")) +
            ylab(paste0(trtA,":Status Std Beta"))
          ggsave(paste0(figDir,"status_Betas_coltrtDir_sigGene_",trtA,"vCtrl.png"), width = 6, height = 4)

          ggplot() +
            geom_histogram(aes(x = emmremlResultsA$pval_Interaction), binwidth = 0.025) +
            ggtitle("Interaction P-Values",
                    subtitle = paste0("Total Genes  n = ",dim(emmremlResultsA)[1],
                                      "  |  FDR < 0.20 = ",sum(qvalue(emmremlResultsA$pval_Interaction)$qvalue < .2))) +
            xlab(paste0(trtA,":Status * Ctrl:Status Interaction p-values"))
          ggsave(paste0(figDir,"pvalue_histogram_interaction_",trtA,"vCtrl.png"), width = 6, height = 4)
          
          assign(value = emmremlResultsA, x = paste0("emmreml",trtA))
    }
  }
}

pvalCutoff <- .05

intLPSpos <- rownames(emmremlLPS[emmremlLPS$pval_Interaction < pvalCutoff & emmremlLPS$beta_Interaction > 0 & emmremlLPS$beta_treatment < 0,])
intLPSneg <- rownames(emmremlLPS[emmremlLPS$pval_Interaction < pvalCutoff & emmremlLPS$beta_Interaction < 0 & emmremlLPS$beta_treatment < 0,])

intDexpos <- rownames(emmremlDex[emmremlDex$pval_Interaction < pvalCutoff & emmremlDex$beta_Interaction > 0 & emmremlDex$beta_treatment < 0,])
intDexneg <- rownames(emmremlDex[emmremlDex$pval_Interaction < pvalCutoff & emmremlDex$beta_Interaction < 0 & emmremlDex$beta_treatment < 0,])

intGardpos <- rownames(emmremlGard[emmremlGard$pval_Interaction < pvalCutoff & emmremlGard$beta_Interaction > 0 & emmremlGard$beta_treatment < 0,])
intGardneg <- rownames(emmremlGard[emmremlGard$pval_Interaction < pvalCutoff & emmremlGard$beta_Interaction < 0 & emmremlGard$beta_treatment < 0,])

listInput <- list(intLPSpos,
                  intLPSneg,
                  intDexpos,
                  intDexneg,
                  intGardpos,
                  intGardneg)

names(listInput) <- c("LPS+","LPS-","Dex+","Dex-","Gard+","Gard-")

testList <- fromList(listInput)

png(paste0(figDir,"statusIntSigGene_upsetPlot_p",pvalCutoff,"_downinTrt.png"), width = 1200, height = 800)
upset(data = testList, order.by = "freq", nsets = length(names(listInput)), nintersects = 20, text.scale = 2.5)
dev.off()



###
#what is in quad2 or quad4 genes?
gene.set <- read.table(paste0(dataDir,"hallmarkPathways_wCategories.csv"), sep = ",")
colnames(gene.set) <- c("Associated.Gene.Name","GO.Term.Accession","Category")
gene.set$gene_GO <- paste0(gene.set$Associated.Gene.Name,"_",gene.set$GO.Term.Accession)


intSigGenes <- as.data.frame(c(intLPSpos,intLPSneg,intDexpos,intDexneg,intGardpos,intGardneg))
colnames(intSigGenes)[1] <- "gene"
intSigGenes$trt <- c(rep("LPSpos",length(intLPSpos)),
                      rep("LPSneg",length(intLPSneg)),
                      rep("Dexpos",length(intDexpos)),
                      rep("Dexneg",length(intDexneg)),
                      rep("Gardpos",length(intGardpos)),
                      rep("Gardneg",length(intGardneg)))

intSigGenes$pathway <- FALSE

intSigGenes$pathway <- intSigGenes$gene %in% gene.set$Associated.Gene.Name

### create a column for each of the immmune pathways
immunePaths <- c(unique(gene.set[gene.set$Category == "immune",]$GO.Term.Accession),"HALLMARK_TNFA_SIGNALING_VIA_NFKB")

intSigGenes <- cbind.data.frame(intSigGenes,matrix(0,nrow = dim(intSigGenes)[1], ncol = length(immunePaths)))

colnames(intSigGenes) <- c("gene","trt","pathway",str_remove_all(immunePaths,"HALLMARK_"))

#which genes are in which pathways
for (path in immunePaths) {
  #path <- "HALLMARK_INFLAMMATORY_RESPONSE"
  pCol <- 3 + which(immunePaths == path)
  intSigGenes[,pCol] <- intSigGenes$gene %in% subset(gene.set, GO.Term.Accession == path)$Associated.Gene.Name
}

#in any immune pathway
intSigGenes$immunePath <- FALSE
for (r in 1:dim(intSigGenes)[1]) {
  intSigGenes$immunePath[r] <- any(intSigGenes[r,4:11])
}

for (trtSet in unique(intSigGenes$trt)) {
  trtOnly <- subset(intSigGenes, trt == trtSet)
  print(trtSet)
  print(dim(trtOnly)[1])
  print(sum(trtOnly$pathway))
  print(sum(trtOnly$immunePath))
  print(sum(trtOnly$INFLAMMATORY_RESPONSE))
  print(sum(trtOnly$TNFA_SIGNALING_VIA_NFKB))
}

subset(gene.set, Associated.Gene.Name == "NRXN2")

subset(gene.set, Associated.Gene.Name %in% c("NRXN2","NEIL1","PQBP1","SGK1"))
subset(intSigGenes, gene %in% c("NRXN2","NEIL1","PQBP1","SGK1"))

emmremlLPS[rownames(emmremlLPS) == "SGK1",]
emmremlDex[rownames(emmremlDex) == "SGK1",]


table(emmremlLPS$intandTrtDir)
table(emmremlDex$intandTrtDir)
table(emmremlGard$intandTrtDir)


```

```{r GSEA on just the status sig genes}
#emreml and mash results


#for (c in c("InfluenzaA","Control18h","Control15h","LPS","Dex","Gardiquimod","IL15","NCSGE1","LPSSGE1")) {

## loop through data sets


trt <- "LPS"
thresh <- "statuslCPM"
c <- "statusInt"
trtDir <- "down"

for (thresh in c("statuslCPM")) {
  allSigTrtPathways <- data.frame()
  allTrtPathways <- data.frame()
  
  for (c in c("statusInt")) {
    
    m <- "emmreml"
  
    for (trt in c("LPS","Gard","Dex")) {
      shortName <- paste0(c,"_",trt,"F_",thresh)
      
      emmremlResultsInt <- get(paste0("emmreml",trt))
      
      if (trtDir == "up") {
        emmremlResultsInt <- subset(emmremlResultsInt, beta_treatment > 0)
      } else if (trtDir == "down") {
        emmremlResultsInt <- subset(emmremlResultsInt, beta_treatment < 0)
      }
      
      stdBetas <- emmremlResultsInt$stdBeta_Interaction
      
      modelResults <- as.data.frame(stdBetas)
      rownames(modelResults) <- rownames(emmremlResultsInt)
      colnames(modelResults) <- "stdBeta"
      
      ### using modelResults run a GSEA, and save the output
      
      ### Permutation-based GSEA tests
      ### Originally developed by Jordan Anderson and Noah Snyder-Mackler. Modified by Tauras Vilgalys. 
      ### Last updated 2020 September 16
      
      ###outside R, build a csv file with geneName,hallmarkPathway
      
      # Parameter options on lines 11 and 12
      # Data and files to load on lines 16 and 30
      ## parameters to consider: 
      pvals <- F ## are data in pvalues or betas? If betas, set pvals to FALSE
      weight <- 1 ## Weight to place on betas. Typically either a 1 or a 0, where 0 weights all effects equally.
              ## weight=0 acts like a KS test, and is typically used with pvalues. 
      
      sampleBetas <- as.data.frame(rownames(modelResults))
      sampleBetas$Betas <- modelResults$stdBeta
      
      colnames(sampleBetas) <- c("Gene","Betas")
  
      gene.list <- sampleBetas$Gene
    
      ## get nperm permutations of the vector of Betas
      nperm <- 1000
      for (i in 1:nperm) {
        tmpB <- sample(sampleBetas$Beta)
        cbind(sampleBetas,tmpB) -> sampleBetas; rm(tmpB)
      }; rm(i)#; head(sampleBetas)
  
      ## Get the list of gene sets to test. here the file starts with gene names and the associated GO terms. 
      ## i downloaded these hallmark gene sets from https://www.gsea-msigdb.org/gsea/msigdb/collections.jsp
  
      gene.set <- read.table(paste0(dataDir,"hallmarkPathways_wCategories.csv"), sep = ",")
      
      colnames(gene.set) <- c("Associated.Gene.Name","GO.Term.Accession","Category")
  
      gene.set$gene_GO <- paste0(gene.set$Associated.Gene.Name,"_",gene.set$GO.Term.Accession)
  
      # Trim for expressed genes where B was estimated
      gene.set2 <- subset(gene.set, gene.set$Associated.Gene.Name %in% sampleBetas$Gene)
  
      # Remove duplicated gene/GO pairings
      gene.set2 <- gene.set2[!duplicated(gene.set2$gene_GO),]
  
      ## Get list of gene ontologies to test, and the number of genes in each
      GO_res <- as.data.frame(matrix(ncol=2, nrow=length(unique(gene.set2$GO.Term.Accession)), unique(gene.set2$GO.Term.Accession)))
      GO_res$V2 <- 0
      GO_res <- GO_res[!(GO_res$V1 == ""),]; colnames(GO_res) <- c("GO", "n_genes")
      
      for (i in 1:nrow(GO_res)) {
        GO_res$n_genes[i] <- sum(gene.set2$GO.Term.Accession == GO_res$GO[i])
      }
      
      rm(i)
      GO_res$n_genes <- as.numeric(GO_res$n_genes)
      
      ## Only consider gene sets with at least 5 measured genes
      GO_res <- subset(GO_res, n_genes >= 5)
      
      ## Create a matrix of just the effect sizes, moving the gene names to the row.names
      effect_size_matrix <- sampleBetas[,-1]
      row.names(effect_size_matrix) <- sampleBetas[,1]
  
      ## Run GSEA function for each GO term (defined earlier in GO_res$GO)
      output<-GSEA(effect_size_matrix = effect_size_matrix,
                   gene_set_list = unique(GO_res$GO),
                   gene_GO_associations = gene.set2,
                   weight = 1, pvals=F)
      
      names(output) <- c("NES_matrix_upreg","NES_matrix_downreg","p_values")
    
      # Normalize + ES' by the mean of + ES values, and - ES' by the mean of - ES null values for that gene set. 
      ##This should effectively control for differences in gene set size
      pos.ES.norm<-matrix(0,nrow=nrow(GO_res),ncol=nperm+1)
      neg.ES.norm<-matrix(0,nrow=nrow(GO_res),ncol=nperm+1)
      
      for (i in 1:length(GO_res$GO)) {
        pos.ES <- unlist(output$NES_matrix_upreg[i,])
        names(pos.ES)<-NULL
        neg.ES <- unlist(output$NES_matrix_downreg[i,])
        names(neg.ES)<-NULL
  
        #for a given gene set, N, calculate the mean of the positive max ES for estimated+ permuted ES.
        #calculate the mean of the max negative ES for estimate+ permuted ES also
         pos.m <- mean(pos.ES)
         neg.m <- mean(abs(neg.ES))
         
         #Then for each permutation in that geneset, scale ES by this mean value, depending on if it was max + or max - ES
         for (j in 1:(nperm+1)){
           pos.ES.norm[i,j]<-pos.ES[j]/pos.m
           neg.ES.norm[i,j]<-neg.ES[j]/neg.m
         }
      }
      
      # FDR? 
      ## Calculate p-values for one of the null distributions as well
      perm_upreg <- apply(output$NES_matrix_upreg[,-1],1,function(x) {ee <- ecdf(x[2:length(x)]); 1 - ee(x[1])})
      perm_downreg <- apply(output$NES_matrix_downreg[,-1],1,function(x) {ee <- ecdf(x[2:length(x)]); 1 - ee(x[1])})
      ## Use perm.fdr function (written by Joaquin Sanz, available from Snyder-Mackler et al. 2016: 
      ## https://github.com/nsmackler/status_genome_2016/blob/master/perm_FDR.R)
      
      fdr_up <- perm.fdr(output$p_values, perm_upreg, "pval_upreg", "fdr_vsPerm1")
      fdr_down <- perm.fdr(output$p_values, perm_upreg, "pval_downreg", "fdr_vsPerm1")
      
      upregNES <- output$NES_matrix_upreg[,1]
      dnregNES <- output$NES_matrix_downreg[,1]
      
      cbind(as.character(GO_res$GO),output$p_values)
  
      #plot significant effects
      betasOnly <- as.data.frame(effect_size_matrix$Betas)
      rownames(betasOnly) <- rownames(effect_size_matrix)
      colnames(betasOnly) <- c("betas")
      betasOnly$rank <- rank(-betasOnly$betas)
    
      dir.create(paste0(figDir,shortName))
      
      for (r in 1:2) {
        if(sum(output$p_values[,r] < .05) > 0) {
          for (g in which(output$p_values[,r] < .05)) {
            pathwayName <- as.character(GO_res$GO)[g]
            pathwayGenes <- subset(gene.set2, GO.Term.Accession == pathwayName)$Associated.Gene.Name
            betasOnly$pathway <- FALSE
            betasOnly$pathway <- rownames(effect_size_matrix) %in% pathwayGenes
            
            betasPathway <- subset(betasOnly, pathway)
            ggplot() +
              geom_linerange(aes(x = betasOnly$rank, ymax = betasOnly$betas, ymin = 0), alpha = 66/dim(effect_size_matrix)[1]) +
              geom_linerange(aes(x = betasPathway$rank, ymax = betasPathway$betas, ymin = 0)) +
              xlab("Rank") + ggtitle(pathwayName, 
                                     subtitle = paste0(subset(GO_res, GO == pathwayName)$n_genes," genes, ",
                                                       "p = ",as.numeric(output$p_values[g,r]),"    ",colnames(output$p_values)[r],
                                                       "      ",m,"-",shortName))
            ggsave(paste0(figDir,"/",shortName,"/gsea_stickPlot_",m,"_Enriched_",pathwayName,"_",trtDir,"inTrt.png"), width = 6, height = 4)
          }
        }
      }
      
      gseaTreatment <- output
      
      sigList <- gseaTreatment$p_values[,1] < .05 | gseaTreatment$p_values[,2] < .05
      
      allPathways <- as.data.frame(cbind(as.character(GO_res$GO),
                                         gseaTreatment$p_values,gseaTreatment$NES_matrix_upreg[,1],
                                         gseaTreatment$NES_matrix_downreg[,1],
                                         shortName,
                                         m,
                                         c,
                                         trt))
      
      sigPathways <- allPathways[sigList,]
    
      if( dim(allSigTrtPathways)[1] == 0) {
        allSigTrtPathways <- sigPathways
        allTrtPathways <- allPathways
      } else {
          allSigTrtPathways <- rbind(allSigTrtPathways,sigPathways)
          allTrtPathways <- rbind(allTrtPathways,allPathways)
      }
    }
  }
  
  write.table(x = allSigTrtPathways, file = paste0(outDir,"gsea_multiTrt_interaction_GSEA_sigResults_",trtDir,"inTrt.txt"), quote = F, row.names = F, sep = ",")
  write.table(x = allTrtPathways, file = paste0(outDir,"gsea_multiTrt_interaction_GSEA_allResults_",trtDir,"inTrt.txt"), quote = F, row.names = F, sep = ",")
  
  
  geneSetSort <- unique(gene.set[,2:3])
  geneSetSort <- geneSetSort[order(geneSetSort$Category),]
  geneSetSort$pathwayShort <- str_remove(geneSetSort$GO.Term.Accession, "HALLMARK_")
  
  plotAllSigTrtPathways <- allSigTrtPathways
  
  colnames(plotAllSigTrtPathways)[c(1,4,5)] <- c("pathway","ESup","ESdown") 
  colnames(plotAllSigTrtPathways)[c(6,7)] <- c("species","model") 
  
  plotAllSigTrtPathways$sigPVal <- ifelse(plotAllSigTrtPathways$pval_upreg < plotAllSigTrtPathways$pval_downreg,
                                          plotAllSigTrtPathways$pval_upreg, plotAllSigTrtPathways$pval_downreg)
  
  plotAllSigTrtPathways$sigES <- ifelse(plotAllSigTrtPathways$pval_upreg < plotAllSigTrtPathways$pval_downreg,
                                          plotAllSigTrtPathways$ESup, plotAllSigTrtPathways$ESdown)
  
  plotAllSigTrtPathways$sigPValAdj <- ifelse(plotAllSigTrtPathways$sigPVal == 0, .0001, plotAllSigTrtPathways$sigPVal)
  
  plotAllSigTrtPathways$sigES <- as.numeric(plotAllSigTrtPathways$sigES)
  plotAllSigTrtPathways$sigPValAdj <- as.numeric(plotAllSigTrtPathways$sigPValAdj)
  
  
  #plotAllSigTrtPathways$conditionMethod <- paste0(plotAllSigTrtPathways$condition,"_",plotAllSigTrtPathways$tpMethod)
  
  
  ggplot(data = plotAllSigTrtPathways, aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point()
  
  
  #todo - remove "hallmark_"
  plotAllSigTrtPathways$pathway <- str_remove(plotAllSigTrtPathways$pathway, "HALLMARK_")
  
  
  #plotAllSigTrtPathways$condModel <- paste0(plotAllSigTrtPathways$condition,"_",plotAllSigTrtPathways$model)
  
  #change angle of names (bottom)
  
  ggplot(data = plotAllSigTrtPathways, aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
  
  #viridis color scheme
  
  #sort by number of conditions & up/down reg elo
  pathwayList <- unique(plotAllSigTrtPathways$pathway)
  meanES <- vector()
  
  for (p in pathwayList) {
    meanES <- c(meanES,mean(subset(plotAllSigTrtPathways, pathway == p)$sigES))
  }
  
  pathwayList <- pathwayList[order(-meanES)]
  
  plotAllSigTrtPathways$pathway <- factor(plotAllSigTrtPathways$pathway, levels = pathwayList)
  
  
  
  pathwayList <- unique(plotAllSigTrtPathways$pathway)
  meanES <- vector()
  
  for (p in pathwayList) {
    meanES <- c(meanES,mean(subset(plotAllSigTrtPathways, pathway == p)$sigES))
  }
  
  pathwayList <- pathwayList[order(-meanES)]
  
  plotAllSigTrtPathways$pathway <- factor(plotAllSigTrtPathways$pathway, levels = pathwayList)
  
  
  ggplot(data = subset(plotAllSigTrtPathways, c == "statusInt"), aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("status - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_statusInt_plot_viridis_emreml_",thresh,"_",trtDir,"inTrt.png"), width = 8, height = 6)
  

  immunePathways <- c("TNFA_SIGNALING_VIA_NFKB",
                      "INFLAMMATORY_RESPONSE",
                      "INTERFERON_ALPHA_RESPONSE",
                      "INTERFERON_GAMMA_RESPONSE",
                      "COMPLEMENT",
                      "CTRA_UP",
                      "CTRA_DOWN")
  
  ggplot(data = subset(plotAllSigTrtPathways, pathway %in% immunePathways & c == "statusInt"), 
         aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("status - emreml - sig GSEA pathways") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  ggsave(paste0(figDir,"GSEA_condition_statusInt_plot_viridis_emreml_ImmunePaths_",thresh,"_",trtDir,"inTrt.png"), width = 8, height = 6)
  
  plotAllSigTrtPathways$pathway <- factor(plotAllSigTrtPathways$pathway, levels = geneSetSort$pathwayShort)
  
  ## plot the pathways with multiple sig hits
  sigPaths <- names(table(plotAllSigTrtPathways$pathway)[table(plotAllSigTrtPathways$pathway) > 1])
  
  ggplot(data = subset(plotAllSigTrtPathways, pathway %in% sigPaths), aes(x = species, y = pathway, col = sigES, size = -log10(sigPValAdj))) +
    geom_point() + scale_color_viridis(limits = c(-1,1)) + ggtitle("emreml - sig GSEA in > 1 pathway") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
  ggsave(paste0(figDir,"GSEA_condition_plot_viridis_emreml_SigPaths_gt2_",thresh,"_",trtDir,"inTrt.png"), width = 8, height = 6)

}
```


Are male and female status effect similar in direction (if not significance)
```{r}
c <- "status"
trt <- "allTrt"
thresh <- "5lCPM"
animalSex <- "M"

for (thresh in c("5lCPM","7lCPM")) {
  
  for (animalSex in c("M","F")) {
  
    for (c in c("status")) {
      
      m <- "emmreml"
    
      for (trt in c("allTrt")) {
        shortName <- paste0(c,"_",trt,animalSex,"_",thresh)
        
        if (animalSex == "M") {
          modelpreg <- "modelG"
        } else {
          modelpreg <- "modelQ"
        }
        
        emmremlResults <- read.table(paste0(outDir,"allBatches_",animalSex,"_",trt,"_10000genes_",thresh,"_",modelpreg,
                                            "_allTrt",animalSex,"_emmreml"))
        
        betas <- emmremlResults$beta_status
        stdBetas <- emmremlResults$beta_status / sqrt(emmremlResults$var_beta_status)
        pvals <- emmremlResults$pval_status
        qvals <- qvalue(pvals)$qvalue
        
        statusResults <- cbind.data.frame(betas,stdBetas,pvals,qvals)
        statusResults$geneID <- rownames(emmremlResults)

        assign(value = statusResults, x = paste0("status",animalSex,thresh))
      
      }
    }
  }
}

status5lCPMmf <- merge(statusM5lCPM,statusF5lCPM, by = "geneID", suffixes = c(".M",".F"))
status7lCPMmf <- merge(statusM7lCPM,statusF7lCPM, by = "geneID", suffixes = c(".M",".F"))

ggplot(data = status5lCPMmf,
       aes(x = `stdBetas.F`,
           y = `stdBetas.M`)) + 
  geom_point(alpha = .1) +
  geom_smooth(method = "lm", formula = "y~x")

ggplot(data = status7lCPMmf,
       aes(x = `stdBetas.F`,
           y = `stdBetas.M`)) + 
  geom_point(alpha = .3) +
  geom_smooth(method = "lm", formula = "y~x")

ggplot(data = status5lCPMmf,
       aes(x = `betas.F`,
           y = `betas.M`)) + 
  geom_point(alpha = .1) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("All Treatment Analysis - Male v. Female \nStatus Betas",
          subtitle = paste0("R = ",signif(cor.test(status5lCPMmf$betas.M,status5lCPMmf$betas.F)$estimate, digits = 1),
                            " | p = ",signif(cor.test(status5lCPMmf$betas.M,status5lCPMmf$betas.F)$p.value, digits = 2))) +
  xlab("Female Status Betas") + ylab("Male Status Betas")
ggsave(paste0(figDir,"male_v_female_statusBetas.png"), width = 4, height = 4)

ggplot(data = status7lCPMmf,
       aes(x = `betas.F`,
           y = `betas.M`)) + 
  geom_point(alpha = .3) +
  geom_smooth(method = "lm", formula = "y~x") +
  ggtitle("All Treatment Analysis - Male v. Female \nStatus Betas - logCPM > 7",
          subtitle = paste0("R = ",signif(cor.test(status7lCPMmf$betas.M,status7lCPMmf$betas.F)$estimate, digits = 1),
                            " | p = ",signif(cor.test(status7lCPMmf$betas.M,status7lCPMmf$betas.F)$p.value, digits = 2))) +
  xlab("Female Status Betas") + ylab("Male Status Betas")
ggsave(paste0(figDir,"male_v_female_statusBetas_7logCPM.png"), width = 4, height = 4)
```


Elastic Net Training

Test Function
```{r test fxn parallel predict}

#### TEST VALUES
# age_vector <- metaPred[,varCol]
# predictedVar <- as.integer(metaPred[,varCol])
# age_vector <- as.integer(metaPred[,varCol])
# counts_file <- residsPred
# sample_type <- "GE"
# alphas <- seq(.1, 1, by = .1)
# sample_trt <- NULL
# lpsANDnc <- NULL
# norm_reads <- TRUE

parallel_predict <- function(age_vector, counts_file, sample_type, no_cores = NULL, alphas, 
                             lpsANDnc = FALSE, sample_trt = NULL, norm_reads = TRUE, modFam = "gaussian") {
  
  no_cores <- detectCores() - 1
  
  N <- length(age_vector)
  cl <- makeCluster(no_cores)
  clusterExport(cl = cl, varlist = ls(), envir = environment())
  #clusterEvalQ(cl, library(glmnet),.libPaths(libs))
  clusterEvalQ(cl, library(glmnet))
  predicted <- matrix(NA, nrow = N, ncol = length(alphas))
  colnames(predicted) <- alphas
  
  par_out <- parLapply(cl, X = alphas, function(z) {
    for (i in 1:N) {
      norm_counts <- counts_file

      norm_train <- norm_counts[, -i]
      norm_test <- norm_counts[, i]
      sample_trt_train <- sample_trt[-i]

      if (sample_type == "epi") {
        trainreads_norm <- as.matrix(apply(norm_train, 
                                           1, function(y) {
                                             return(qqnorm(y, plot = F)$x)
                                           }))
      } else if (sample_type == "GE") {
        if (norm_reads) {
        trainreads_norm <- as.matrix(apply(norm_train, 
                                 1, function(x) { 
                                   #return(getZscore(x))
                                      mean_x<-mean(x)
                                      sd_x<-sd(x)
                                      z<-(x-mean_x)/sd_x
                                      return(z)
                                   }))
        } else {
          trainreads_norm <- norm_train
        }
      } else {
        return("invalid sample_type")
      }
      
      trainage <- age_vector[-i]
      testage <- age_vector[i]
      
      if (sample_type == "epi") {
        testreads_normalized <- norm_test
        for (d in 1:dim(norm_counts)[1]) {
          a <- ecdf(norm_train[d, ])
          probs <- a(norm_test[d])
          probs[probs == 1] <- 0.99
          probs[probs == 0] <- 0.01
          testreads_normalized[d] <- qnorm(probs)
        }
      } else if (sample_type == "GE") {
        testreads_normalized <- norm_test
        if (norm_reads) {
        
        for (d in 1:dim(norm_counts)[1]) {
          mean_d <- mean(norm_train[d, ])
          sd_d <- sd(norm_train[d, ])
          testreads_normalized[d] <- (norm_test[d] - mean_d)/sd_d
          }
        }
      } else {
        return("invalid sample_type")
      }
      if (modFam == "binomial") {
      model <- cv.glmnet(trainreads_norm, 
                         trainage, 
                         nfolds = (N - 1), 
                         alpha = z, 
                         family = "binomial", 
                         standardize = F)
      predicted[i, colnames(predicted) == z] <- predict(model, 
                                                        newx = testreads_normalized, 
                                                        s = "lambda.min")
      } else {
              model <- cv.glmnet(trainreads_norm, 
                         trainage, 
                         nfolds = (N - 1), 
                         alpha = z, 
                         standardize = F)
      predicted[i, colnames(predicted) == z] <- predict(model, 
                                                        newx = testreads_normalized, 
                                                        s = "lambda.min")
      }
    }
    return(predicted)
  })
  stopCluster(cl)
  return(par_out)
}

###########################
#Predicting preg and status
###########################
deGenesOnly <- TRUE
trtA <- "LPS"
varA <- "Preg"
geneSet <- "deGenes"

modelFamily <- "binomial" #"gaussian"
for (modelFamily in c("binomial","gaussian")) {
  varFormat <- "TF" #"01"
  
  for (trtA in c("LPS","Ctrl","Gard","Dex")) {
    for (varA in c("Preg","Status")) {
      print(paste0(trtA," ",varA))
      print(date())
      fileList <- list.files(paste0(figDir,"prediction/"))
      if (!paste0(varA,"_in_",trtA,"_allAlphas_",varFormat,modelFamily,"_",geneSet,".png") %in% fileList) {
    
        if (trtA %in% c("LPS","Ctrl")) {
          modelPreg <- "modelR"
          modelStatus <- "modelP"
        } else {
          modelPreg <- "modelS"
          modelStatus <- "modelQ"
        }
        
        #modelPreg = controls for status
        #modelStatus = controls for preg
        
        if (varA == "Status") {
          residsPred <- readRDS(paste0(outDir,"allBatches_F_",trtA,"only_10000genes_5lCPM_",modelStatus,"_resids.RDS"))
          metaPred <- readRDS(paste0(outDir,"allBatches_F_",trtA,"only_10000genes_5lCPM_",modelStatus,"_dfMeta.RDS"))
          mrmlPred <- read.table(paste0(outDir,"allBatches_F_",trtA,"only_10000genes_5lCPM_",modelStatus,"_basicPreg_emmreml"))
          varCol <- which(colnames(metaPred) == "status_dom_sub")
          if (varFormat == "01") {
            predictedVar <- as.integer(metaPred[,varCol] == "D")
          } else {
            predictedVar <- metaPred[,varCol] == "D"
          }
          if (deGenesOnly) {
            deGeneList <- rownames(mrmlPred[mrmlPred$pval_status < .05,])
            residsPred <- residsPred[rownames(residsPred) %in% deGeneList,]
            geneSet <- "deGenes"
          }
        } else {
          residsPred <- readRDS(paste0(outDir,"allBatches_F_",trtA,"only_10000genes_5lCPM_",modelPreg,"_resids.RDS"))
          metaPred <- readRDS(paste0(outDir,"allBatches_F_",trtA,"only_10000genes_5lCPM_",modelPreg,"_dfMeta.RDS"))
          mrmlPred <- read.table(paste0(outDir,"allBatches_F_",trtA,"only_10000genes_5lCPM_",modelPreg,"_basicPreg_emmreml"))
          varCol <- which(colnames(metaPred) == "pregStatusBackDate35")
          if (varFormat == "01") {
            predictedVar <- as.integer(metaPred[,varCol])
          } else {
            predictedVar <- (metaPred[,varCol])
          }
          if (deGenesOnly) {
            deGeneList <- rownames(mrmlPred[mrmlPred$pval_preg < .05,])
            residsPred <- residsPred[rownames(residsPred) %in% deGeneList,]
            geneSet <- "deGenes"
          }
        }
        
        predicted_female_SI <- matrix(NA, nrow=length(predictedVar), ncol=10)
        
        f <- 10
        for(f in 1:10){
          predicted_female_SI[,f] <- parallel_predict(age_vector = predictedVar,
                                                      counts_file = residsPred,
                                                      sample_type = "GE",
                                                      modFam = modelFamily,
                                                      alphas = seq(.1,1,by = .1)[f])[[1]]
          print(f)
        }
        
        head(predicted_female_SI)
        
        rsq <- 1:10
        for(f in 1:10){
          rsq[f]<-summary(lm(predicted_female_SI[,f]~predictedVar))$r.squared
        }
        
        rsq
        
        bestAlpha <- which(rsq == max(rsq))
        
        par(mfrow=c(1,1),pty="s")
        plot(predicted_female_SI[,bestAlpha]~predictedVar,xlab="Pregnancy (1 = Preg)",ylab="Predicted Pregnancy",pch=20)
        abline(lm(predicted_female_SI[,bestAlpha]~predictedVar),lty=2)
        summary(lm(predicted_female_SI[,bestAlpha]~predictedVar))
  
        #print the Alpha curve
        ggplot() +
          geom_point(aes(x = 1:10/1,
                         y = rsq)) +
          ggtitle(paste0("R-Squared by Alpha"),
                  subtitle = paste0(varA," variable in ",trtA)) +
          xlab("Alphas") + ylab("R-Squared")
        ggsave(paste0(figDir,"prediction/",varA,"_in_",trtA,"_allAlphas_",varFormat,modelFamily,"_",geneSet,".png"),
               width = 6, height = 4)
        
        #print the results for the best Alpha
        alphaPlot <- ggplot() +
          geom_smooth(aes(x = predictedVar, 
                         y = predicted_female_SI[,bestAlpha]),
                     formula = "y~x", method = "lm", col = "darkgray") +
          geom_point(aes(x = predictedVar, 
                         y = predicted_female_SI[,bestAlpha],
                         col = as.character(predictedVar)),
                     size = 3, alpha = 2/3) +
          ggtitle(paste0("Prediction of ",varA," from GE"),
                  subtitle = paste0("best alpha = ",bestAlpha/10,"  |  R^2=",signif(rsq[bestAlpha], digits = 2))) +
          labs(color = varA) + xlab("Actual Value") + ylab("Predicted Value")
        
        ggsave(plot = alphaPlot,
               paste0(figDir,"prediction/",varA,"_in_",trtA,"_bestAlpha_",varFormat,modelFamily,"_",geneSet,".png"),
               width = 6, height = 4)
        
        if (varA == "Preg") {
        alphaPlotWdates <- alphaPlot + geom_text_repel(aes(x = predictedVar[metaPred$daysPrePreg > 0],
                                  y = predicted_female_SI[metaPred$daysPrePreg > 0,bestAlpha],
                                  label = metaPred$daysPrePreg[metaPred$daysPrePreg > 0]),
                                  max.overlaps = 15)
          ggsave(plot = alphaPlotWdates,
               paste0(figDir,"prediction/",varA,"_in_",trtA,"_bestAlpha_Results_pregDays_",varFormat,modelFamily,"_",geneSet,".png"),
               width = 6, height = 4)
        }
      }
    }
  }
}

```


```{r}
########################################
#Predicting trt and control (as a test)
########################################

varA <- "Trt"
trtA <- "LPS"
shortVersion <- FALSE

for (modelFamily in c("binomial","gaussian")) {
  #modelFamily <- "binomial"
  
  for (varFormat in c("TF","01")) {
    #varFormat <- "01"

    print(paste0(trtA,"-Ctrl ",varA))
    print(date())
    
    residsPred <- readRDS(paste0(outDir,"allBatches_F_LPS_10000genes_5lCPM_modelG_resids.RDS"))
    metaPred <- readRDS(paste0(outDir,"allBatches_F_LPS_10000genes_5lCPM_modelG_dfMeta.RDS"))
      
    varCol <- which(colnames(metaPred) == "Trt")
    predictedVarNum <- as.integer(metaPred[,varCol] == "LPS")
    predictedVarBin <- metaPred[,varCol] == "LPS"
    
    if (shortVersion) {
      predicted_female_SI <- matrix(NA, nrow=length(predictedVarNum[1:20]), ncol=10)
      residsPred <- residsPred[,1:20]
      predictedVarNum <- predictedVarNum[1:20]
      predictedVarBin <- predictedVarBin[1:20]
    } else {
      predicted_female_SI <- matrix(NA, nrow=length(predictedVarNum), ncol=10)
    }
    
    #which method
    if (varFormat == "TF") {
      predictedVar <- predictedVarBin
    } else {
      predictedVar <- predictedVarNum
    }
    
    #f <- 10
    for(f in 1:10){
      predicted_female_SI[,f] <- parallel_predict(age_vector = predictedVar,
                                                  counts_file = residsPred,
                                                  sample_type = "GE",
                                                  modFam = modelFamily,
                                                  alphas = seq(.1,1,by = .1)[f])[[1]]
      print(f)
    }
    
    head(predicted_female_SI)
    
    dataSize <- dim(predicted_female_SI)[1]
    
    rsq <- 1:10
    for(f in 1:10){
      rsq[f]<-summary(lm(predicted_female_SI[,f]~predictedVar))$r.squared
    }
    
    rsq
    
    bestAlpha <- which(rsq == max(rsq))
    
    #print the Alpha curve
    ggplot() +
      geom_point(aes(x = 1:10/1,
                     y = rsq)) +
      ggtitle(paste0("R-Squared by Alpha"),
              subtitle = paste0(varA," variable in ",trtA)) +
      xlab("Alphas") + ylab("R-Squared")
    ggsave(paste0(figDir,"prediction/",varA,"-Ctrl_in_",trtA,"_allAlphas_",modelFamily,varFormat,"_n",dataSize,".png"),
           width = 6, height = 4)
    
    #print the results for the best Alpha
    alphaPlot <- ggplot() +
      geom_smooth(aes(x = predictedVar, 
                     y = predicted_female_SI[,bestAlpha]),
                 formula = "y~x", method = "lm", col = "darkgray") +
      geom_point(aes(x = predictedVar, 
                     y = predicted_female_SI[,bestAlpha],
                     col = as.character(predictedVar)),
                 size = 3, alpha = 2/3) +
      ggtitle(paste0("Prediction of ",varA," from GE"),
              subtitle = paste0("best alpha = ",bestAlpha/10,"  |  R^2=",signif(rsq[bestAlpha], digits = 2))) +
      labs(color = varA) + xlab("Actual Value") + ylab("Predicted Value")
    
    ggsave(plot = alphaPlot,
           paste0(figDir,"prediction/",varA,"-Ctrl_in_",trtA,"_bestAlpha_Results_",modelFamily,varFormat,"_n",dataSize,".png"),
           width = 6, height = 4)
  }
}

```


```{r plot results}
#r squared
ggplot() +
  geom_point(aes(x = 1:10/10, y = rsqNC), col = "blue") +
  geom_point(aes(x = 1:10/10, y = rsqLPS), col = "red") +
  ylim(c(min(rsqNC,rsqLPS)-.05,max(rsqNC,rsqLPS)+.05)) +
  xlab("Alpha") + ylab("Prediction R-Squared")

ggsave(paste0(figDir,"rSquared_by_alpha_nullAndlps.png"))

#null
bestAlpha <- which(rsqNC == max(rsqNC))

plotCor <- summary(lm(predicted_female_NC[,bestAlpha]~cols$Elo[cols$Condition=="NC"]))

ggplot() +
  geom_abline(slope = 1, intercept = 0, alpha = .2) +
  geom_point(aes(x = cols$Elo[cols$Condition=="NC"],
                 y = predicted_female_NC[,bestAlpha])) +
  geom_smooth(aes(x = cols$Elo[cols$Condition=="NC"],
                 y = predicted_female_NC[,bestAlpha]),
              method = "lm", formula = y~x) +
  xlab("Observed Elo ") + ylab("Predicted Elo") +
  ggtitle(paste0("NC - Predicted v. Observed Elo | alpha = ",bestAlpha/10),
          subtitle = paste0("R^2 = ",signif(plotCor$r.squared, digits = 3)))

ggsave(paste0(figDir,"basicModel_nullSamples_obsVpred.png"))


#lps
bestAlpha <- which(rsqLPS == max(rsqLPS))

plotCor <- summary(lm(predicted_female_LPS[,bestAlpha]~cols$Elo[cols$Condition=="LPS"]))

ggplot() +
  geom_abline(slope = 1, intercept = 0, alpha = .2) +
  geom_point(aes(x = cols$Elo[cols$Condition=="LPS"],
                 y = predicted_female_LPS[,bestAlpha])) +
  geom_smooth(aes(x = cols$Elo[cols$Condition=="LPS"],
                 y = predicted_female_LPS[,bestAlpha]),
              method = "lm", formula = y~x) +
  xlab("Observed Elo ") + ylab("Predicted Elo") +
  ggtitle(paste0("LPS - Predicted v. Observed Elo | alpha = ",bestAlpha/10),
          subtitle = paste0("R^2 = ",signif(plotCor$r.squared, digits = 3)))

ggsave(paste0(figDir,"basicModel_lpsSamples_obsVpred.png"))
```


Across Status & Preg, across all 4 conditions (Ctrl, LPS, Gard, Dex)

full data - can we predict using all data?


leave one out - can we predict without the individual in question?

```{r prediction}
###########################
#Predicting dominance rank 
###########################

#######################
#Within sex predictions
#######################

#######################
#Females
#######################

###########
#NULL
###########



#predicted_female_SI<-matrix(NA,nrow=length(which(meta_info_female$treatment=="NULL")),ncol=10)
predicted_female_SI <- matrix(NA, nrow=length(which(cols$Condition=="NC")), ncol=10)


#parallel_predict(age_vector = cols$Elo[cols$Condition=="NC"],
#                 counts_file = sge1resids[,cols$Condition=="NC"],
#                 sample_type = "GE",
#                 alphas = seq(.1,1,by = .1))


for(f in 1:10){
  predicted_female_SI[,f] <- parallel_predict(#age_vector = meta_info_female$rank[meta_info_female$treatment=="NULL"],
                                           age_vector = cols$Elo[cols$Condition=="NC"],
                                          #counts_file = resids_female[,meta_info_female$treatment=="NULL" ],
                                          counts_file = sge1resids[,cols$Condition=="NC"],
                                          sample_type = "GE",
                                          alphas = seq(.1,1,by = .1)[f])[[1]]
  print(f)
}
head(predicted_female_SI)

predicted_female_NC <- predicted_female_SI

rsq <- 1:10
for(f in 1:10){
  #rsq[f]<-summary(lm(predicted_female_SI[which(meta_info_female$sname[meta_info_female$treatment=="NULL"]!="AMB_2"),f]~meta_info_female$rank[meta_info_female$treatment=="NULL" & meta_info_female$sname!="AMB_2"]))$r.squared
  rsq[f]<-summary(lm(predicted_female_SI[,f]~cols$Elo[cols$Condition=="NC"]))$r.squared
}

rsq

rsqNC <- rsq

bestAlpha <- which(rsq == max(rsq))

par(mfrow=c(1,1),pty="s")
plot(predicted_female_SI[,bestAlpha]~cols$Elo[cols$Condition=="NC"],xlab="Elo",ylab="Predicted Elo",pch=20)
abline(lm(predicted_female_SI[,bestAlpha]~cols$Elo[cols$Condition=="NC"]),lty=2)
summary(lm(predicted_female_SI[,bestAlpha]~cols$Elo[cols$Condition=="NC"]))



###########
#LPS
###########



#predicted_female_SI<-matrix(NA,nrow=length(which(meta_info_female$treatment=="NULL")),ncol=10)
predicted_female_SI <- matrix(NA, nrow=length(which(cols$Condition=="LPS")), ncol=10)


#parallel_predict(age_vector = cols$Elo[cols$Condition=="NC"],
#                 counts_file = sge1resids[,cols$Condition=="NC"],
#                 sample_type = "GE",
#                 alphas = seq(.1,1,by = .1))


for(f in 1:10){
  predicted_female_SI[,f] <- parallel_predict(#age_vector = meta_info_female$rank[meta_info_female$treatment=="NULL"],
                                           age_vector = cols$Elo[cols$Condition=="LPS"],
                                          #counts_file = resids_female[,meta_info_female$treatment=="NULL" ],
                                          counts_file = sge1resids[,cols$Condition=="LPS"],
                                          sample_type = "GE",
                                          alphas = seq(.1,1,by = .1)[f])[[1]]
  print(f)
}
head(predicted_female_SI)

predicted_female_LPS <- predicted_female_SI

rsq <- 1:10
for(f in 1:10){
  #rsq[f]<-summary(lm(predicted_female_SI[which(meta_info_female$sname[meta_info_female$treatment=="NULL"]!="AMB_2"),f]~meta_info_female$rank[meta_info_female$treatment=="NULL" & meta_info_female$sname!="AMB_2"]))$r.squared
  rsq[f]<-summary(lm(predicted_female_SI[,f]~cols$Elo[cols$Condition=="LPS"]))$r.squared
}

rsq

rsqLPS <- rsq

bestAlpha <- which(rsq == max(rsq))

par(mfrow=c(1,1),pty="s")
plot(predicted_female_SI[,bestAlpha]~cols$Elo[cols$Condition=="LPS"],xlab="Elo",ylab="Predicted Elo",pch=20)
abline(lm(predicted_female_SI[,bestAlpha]~cols$Elo[cols$Condition=="LPS"]),lty=2)
summary(lm(predicted_female_SI[,bestAlpha]~cols$Elo[cols$Condition=="LPS"]))







```

KMP Talk
```{r general info}
mColor <- "#00A2FF"
fColor <- "#EA8777"

sColor <- "#FFD479"
dColor <- "#009051"
```


```{r female LPS status example}
#load data
c <- "status"
trt <- "LPS"
thresh <- "5lCPM"
focalSex <- "F"

shortName <- paste0(c,"_",trt,focalSex,"_",thresh)

model <- "modelR"
modelpreg <- "modelP"

if (trt %in% c("Dex","Gard","allTrt")) {
  model <- "modelS"
  modelpreg <- "modelQ"
}

emmremlResults <- read.table(paste0(outDir,"allBatches_F_",trt,"only_10000genes_",thresh,"_",modelpreg,"_basicPreg_emmreml"))
emmremlResults$stdBeta_status <- emmremlResults$beta_status / sqrt(emmremlResults$var_beta_status)

topStatusGenes <- rownames(head(emmremlResults[order(emmremlResults$pval_status),], n = 20))

modelResids <- readRDS(paste0(outDir,"allBatches_F_",trt,"only_10000genes_",thresh,"_",modelpreg,"_resids.RDS"))
modelRawGE <- readRDS(paste0(outDir,"allBatches_F_",trt,"only_10000genes_",thresh,"_filteredCounts.RDS"))
modellcpmGE <- cpm(modelRawGE, log = TRUE)
modelmetaGE <- readRDS(paste0(outDir,"allBatches_F_",trt,"only_10000genes_",thresh,"_metadata.RDS"))

#single gene plot - loop through top 20 genes

g <- topStatusGenes[14]

all(colnames(modelResids) == colnames(modelRawGE))

all(colnames(modelResids) == modelmetaGE$sampleID)

for (g in topStatusGenes) {
  geneDF <- cbind.data.frame(modelResids[rownames(modelResids) == g,],
                             modellcpmGE[rownames(modellcpmGE) == g,],
                             modelmetaGE$sampleID,
                             modelmetaGE$status_dom_sub,
                             modelmetaGE$animal_id)
  
  colnames(geneDF) <- c("geResid","geLCPM","sampleID","status","animal")
  
  geneDF$status <- factor(geneDF$status, levels = c("S","D"))
  
  ggplot(data = geneDF,
         aes(x = status,
             y = geResid,
             fill = status)) +
    geom_violin(draw_quantiles = c(.25,.5,.75)) +
    geom_point(size = 3, alpha = .33) +
    ggtitle(paste0(g," ",trt," ",focalSex)) +
    scale_fill_manual(values = c(sColor,dColor)) +
    theme_minimal()
  ggsave(paste0(figDir,"kmpTalk/drafts/geResid_statusComp_",focalSex,"_",trt,"_",thresh,"_",g,".png"), width = 5, height = 3)
  
  ggplot(data = geneDF,
         aes(x = status,
             y = geLCPM,
             fill = status)) +
    geom_violin(draw_quantiles = c(.25,.5,.75)) +
    geom_point(size = 3, alpha = .33) +
    ggtitle(paste0(g," ",trt," ",focalSex)) +
    scale_fill_manual(values = c(sColor,dColor)) +
    theme_minimal()
  ggsave(paste0(figDir,"kmpTalk/drafts/geLCPM_statusComp_",focalSex,"_",trt,"_",thresh,"_",g,".png"), width = 5, height = 3)
}



```

```{r count significant genes across treatment to compare male and female}

c <- "status"
trt <- "LPS"
thresh <- "5lCPM"
focalSex <- "F"
fdrThresh <- .1

sigGeneCount4DF <- vector()
treatment4DF <- vector()
sex4DF <- vector()
fdrThresh4DF <- vector()
geThresh4DF <- vector()

for (focalSex in c("M","F")) {
  for (trt in c("Ctrl","Dex","Gard","LPS","allTrt")) {

    modelpreg <- "modelP"

    if (trt %in% c("Dex","Gard","allTrt")) {
      modelpreg <- "modelQ"
    }
    
    for (thresh in c("5lCPM","7lCPM")) {
    
      if (trt == "allTrt") {
        if (focalSex == "F") {
          emmremlResults <- read.table(paste0(outDir,"allBatches_",focalSex,"_",trt,
                                            "_10000genes_",thresh,"_",modelpreg,"_allTrt",focalSex,"_emmreml"))
        } else {
          model <- "F"
          if (trt %in% c("Dex","Gard","allTrt")) {
                model <- "modelG"
          }
                    emmremlResults <- read.table(paste0(outDir,"allBatches_",focalSex,"_",trt,
                                            "_10000genes_",thresh,"_",model,"_allTrt",focalSex,"_emmreml"))
        }
      } else {
        if (focalSex == "F") {
          emmremlResults <- read.table(paste0(outDir,"allBatches_",focalSex,"_",trt,
                                              "only_10000genes_",thresh,"_",modelpreg,"_basicPreg_emmreml"))
        } else {
          model <- "modelF"
          if (trt %in% c("Dex","Gard","allTrt")) {
                model <- "modelG"
          }
          emmremlResults <- read.table(paste0(outDir,"allBatches_",focalSex,"_",trt,
                                                "only_10000genes_",thresh,"_",model,"_basic_emmreml"))

        }
      }
    
      for (fdrThresh in c(.01,.05,.10,.20)) {
        sigCountGenes <- sum(qvalue(emmremlResults$pval_status)$qvalue < fdrThresh)
        
        sigGeneCount4DF <- c(sigGeneCount4DF,sigCountGenes)
        treatment4DF <- c(treatment4DF,trt)
        sex4DF <- c(sex4DF,focalSex)
        fdrThresh4DF <- c(fdrThresh4DF,fdrThresh)
        geThresh4DF <- c(geThresh4DF,thresh)
        
      }
    }
  }
}

sigStatusGenes <- cbind.data.frame(sigGeneCount4DF,
                                   treatment4DF,
                                   sex4DF,
                                   fdrThresh4DF,
                                   geThresh4DF)

subset(sigStatusGenes, geThresh4DF == "7lCPM" & fdrThresh4DF == .1)

### GGplot bar graph here

plotFDRthresh <- .1
plotGEthresh <- "7lCPM"

ggplot(data = subset(sigStatusGenes, geThresh4DF == plotGEthresh & fdrThresh4DF == plotFDRthresh),
       aes(x = paste0(treatment4DF,"_",sex4DF),
           y = sigGeneCount4DF,
           col = sex4DF)) +
  geom_hline(yintercept = 0) +
  geom_point(size = 10, shape = "square") +
  scale_color_manual(values = c(fColor,mColor)) +
  ggtitle(paste0("MvF FDR<",plotFDRthresh," &  GE>",plotGEthresh),
          subtitle = "") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.text.y = element_text(size = 15))
ggsave(paste0(figDir,"kmpTalk/statusSigGene_MFComp_",plotFDRthresh,"_",plotGEthresh,".png"), width = 5, height = 3)


ggplot(data = subset(sigStatusGenes, geThresh4DF == plotGEthresh & fdrThresh4DF == plotFDRthresh),
       aes(x = paste0(treatment4DF,"_",sex4DF),
           y = sigGeneCount4DF,
           fill = sex4DF)) +
  #geom_hline(yintercept = 0) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c(fColor,mColor)) +
  ggtitle(paste0("MvF FDR<",plotFDRthresh," &  GE>",plotGEthresh),
          subtitle = "") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.text.y = element_text(size = 15))
ggsave(paste0(figDir,"kmpTalk/statusSigGene_MFComp_",plotFDRthresh,"_",plotGEthresh,"_barplot.png"), width = 5, height = 3)

ggplot(data = subset(sigStatusGenes, geThresh4DF == plotGEthresh & fdrThresh4DF == plotFDRthresh),
       aes(x = paste0(treatment4DF,"_",sex4DF),
           y = sigGeneCount4DF,
           fill = sex4DF)) +
  #geom_hline(yintercept = 0) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c(fColor,mColor)) +
  ggtitle(paste0("MvF FDR<",plotFDRthresh," &  GE>",plotGEthresh),
          subtitle = "") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.text.y = element_text(size = 15))
ggsave(paste0(figDir,"kmpTalk/statusSigGene_MFComp_",plotFDRthresh,"_",plotGEthresh,"_barplot_noXaxiss.png"), width = 5, height = 3)
```



```{r qqplots for status controlling for preg}
treatment <- "LPS"
for (treatment in c("Ctrl","LPS","Dex","Gard")) {
  #model Var is the variable to check the effect of before and after controlling for the OTHER variable
  modelVar <- "Status"
  for (modelVar in c("Preg","Status")) {

    if (modelVar == "Status") {
      modelTitle <- "modeling Preg as Tech Var."
    } else {
      modelTitle <- "modeling Status as Tech Var."
    }
    
    #LPS/Ctrl
    #P: F + Preg
    #Dex/Guard
    #Q: G + Preg
    
    #R: F + Status
    #S: G + Status
    
    if (modelVar == "Preg") {
      ctrlModel <- "R"
      origModel <- "F"
    } else { #if it is Status
      ctrlModel <- "P"
      origModel <- "F"
    }
    
    
    if (treatment %in% c("Dex","Gard")) {
      if (origModel == "F") {
        origModel <- "G"
      }
      if (ctrlModel == "R") {
        ctrlModel <- "S"
      }
      if (ctrlModel == "P") {
        ctrlModel <- "Q"
      }
    }
    
    #Q control for preg directly
    #
    emremlOrigAll <- read.table(paste0(outDir,"allBatches_F_",
                                       treatment,"only_10000genes_5lCPM_model",
                                       origModel,"_basicPreg_emmreml"))
    emremlCtrlAll <- read.table(paste0(outDir,"allBatches_F_",
                                       treatment,"only_10000genes_5lCPM_model",
                                       ctrlModel,"_basicPreg_emmreml"))
    
    emremlOrigTop <- read.table(paste0(outDir,"allBatches_F_",
                                       treatment,"only_10000genes_7lCPM_model",
                                       origModel,"_basicPreg_emmreml"))
    emremlCtrlTop <- read.table(paste0(outDir,"allBatches_F_",
                                       treatment,"only_10000genes_7lCPM_model",
                                       ctrlModel,"_basicPreg_emmreml"))
    
    emremlOrigAll$geneID <- rownames(emremlOrigAll)
    emremlCtrlAll$geneID <- rownames(emremlCtrlAll)
    emremlOrigTop$geneID <- rownames(emremlOrigTop)
    emremlCtrlTop$geneID <- rownames(emremlCtrlTop)
    
    emremlAllComp <- merge(emremlOrigAll, emremlCtrlAll, by = "geneID", suffixes = c(".orig",".ctrl"))
    emremlTopComp <- merge(emremlOrigTop, emremlCtrlTop, by = "geneID", suffixes = c(".orig",".ctrl"))
    
    
    
    emremlAllComp$stdbeta_status.orig <- emremlAllComp$beta_status.orig / sqrt(emremlAllComp$var_beta_status.orig)
    emremlAllComp$stdbeta_status.ctrl <- emremlAllComp$beta_status.ctrl / sqrt(emremlAllComp$var_beta_status.ctrl)
    
    emremlAllComp$stdbeta_preg.orig <- emremlAllComp$beta_preg.orig / sqrt(emremlAllComp$var_beta_preg.orig)
    emremlAllComp$stdbeta_preg.ctrl <- emremlAllComp$beta_preg.ctrl / sqrt(emremlAllComp$var_beta_preg.ctrl)

    #want to compare the betas of modelVar
    
    if (modelVar == "Preg") {

          emremlAllComp$sig <- ifelse(emremlAllComp$pval_preg.ctrl < 0.05 & emremlAllComp$pval_preg.orig < 0.05, "Both",
                                ifelse(emremlAllComp$pval_preg.ctrl < 0.05, "Ctrl Only",
                                       ifelse(emremlAllComp$pval_preg.orig < 0.05, "Ctrl Only","N.S.")))

    ggplot(data = emremlAllComp,
           aes(x = stdbeta_preg.orig,
               y = stdbeta_preg.ctrl,
               col = sig)) +
      geom_abline(slope = 1, intercept = 0, col = "grey70") +
      geom_point(size = 3, alpha = .15) +
      xlab("Beta Status Original Model") +
      ylab("Beta Status Control Model") +
      labs(col = "Significance") +
      ggtitle("All Genes - Status Beta Comparison",
              subtitle = paste0(modelTitle," - ",treatment," only")) +
      theme_minimal() +
        theme(axis.text = element_text(size = 15)) +
      scale_color_manual(values = c("purple","red","grey70"))
    ggsave(paste0(figDir,"ctrl_v_original_pregStdBetas_",treatment,"_",modelVar,"_allGenes_kmpTalk.png"),
           width = 5, height = 3)
    } else {
      
          emremlAllComp$sig <- ifelse(emremlAllComp$pval_status.ctrl < 0.05 & emremlAllComp$pval_status.orig < 0.05, "Both",
                                ifelse(emremlAllComp$pval_status.ctrl < 0.05, "Ctrl Only",
                                       ifelse(emremlAllComp$pval_status.orig < 0.05, "Ctrl Only","N.S.")))

          ggplot(data = emremlAllComp,
           aes(x = stdbeta_status.orig,
               y = stdbeta_status.ctrl,
               col = sig)) +
      geom_abline(slope = 1, intercept = 0, col = "grey70") +
      geom_point(size = 3, alpha = .15) +
      xlab("Beta Preg Original Model") +
      ylab("Beta Preg Control Model") +
      labs(col = "Significance") +
      ggtitle("All Genes - Preg Beta Comparison",
              subtitle = paste0(modelTitle," - ",treatment," only")) +
      theme_minimal() +
        theme(axis.text = element_text(size = 15)) +
      scale_color_manual(values = c("purple","red","grey70"))
    ggsave(paste0(figDir,"ctrl_v_original_statusStdBetas_",treatment,"_",modelVar,"_allGenes_kmpTalk.png"),
           width = 5, height = 3)
    }

  
  }
}



```

Are male and female status effect similar in direction (if not significance)
```{r}
c <- "status"
trt <- "allTrt"
thresh <- "5lCPM"
animalSex <- "M"

for (thresh in c("5lCPM","7lCPM")) {
  
  for (animalSex in c("M","F")) {
  
    for (c in c("status")) {
      
      m <- "emmreml"
    
      for (trt in c("allTrt")) {
        shortName <- paste0(c,"_",trt,animalSex,"_",thresh)
        
        if (animalSex == "M") {
          modelpreg <- "modelG"
        } else {
          modelpreg <- "modelQ"
        }
        
        emmremlResults <- read.table(paste0(outDir,"allBatches_",animalSex,"_",trt,"_10000genes_",thresh,"_",modelpreg,
                                            "_allTrt",animalSex,"_emmreml"))
        
        betas <- emmremlResults$beta_status
        stdBetas <- emmremlResults$beta_status / sqrt(emmremlResults$var_beta_status)
        pvals <- emmremlResults$pval_status
        qvals <- qvalue(pvals)$qvalue
        
        statusResults <- cbind.data.frame(betas,stdBetas,pvals,qvals)
        statusResults$geneID <- rownames(emmremlResults)

        assign(value = statusResults, x = paste0("status",animalSex,thresh))
      
      }
    }
  }
}

status5lCPMmf <- merge(statusM5lCPM,statusF5lCPM, by = "geneID", suffixes = c(".M",".F"))
status7lCPMmf <- merge(statusM7lCPM,statusF7lCPM, by = "geneID", suffixes = c(".M",".F"))

status5lCPMmf$sig <- ifelse(status5lCPMmf$qvals.M < 0.1 & status5lCPMmf$qvals.F < 0.1, "Both",
                            ifelse(status5lCPMmf$qvals.M < 0.1, "Male Only",
                                   ifelse(status5lCPMmf$qvals.F < 0.05, "Female Only","N.S.")))


ggplot(data = status5lCPMmf,
       aes(x = `stdBetas.F`,
           y = `stdBetas.M`)) + 
  geom_point(aes(col = sig), alpha = 2/3) +
  geom_smooth(method = "lm", formula = "y~x", col = "black") +
  ggtitle("All Treatment Analysis - Male v. Female \nStatus Betas",
          subtitle = paste0("R = ",signif(cor.test(status5lCPMmf$stdBetas.M,status5lCPMmf$stdBetas.F)$estimate, digits = 1),
                            " | p = ",signif(cor.test(status5lCPMmf$stdBetas.M,status5lCPMmf$stdBetas.F)$p.value, digits = 2))) +
  xlab("Female Status Betas") + ylab("Male Status Betas") +
  labs(col = "Significance") +
  scale_color_manual(values = c(fColor,"gray60"))  +
      theme_minimal() +
        theme(axis.text = element_text(size = 15))
ggsave(paste0(figDir,"male_v_female_statusBetas_5lCPM_kmpTalk.png"), width = 6, height = 4)


status7lCPMmf$sig <- ifelse(status7lCPMmf$qvals.M < 0.1 & status7lCPMmf$qvals.F < 0.1, "Both",
                            ifelse(status7lCPMmf$qvals.M < 0.1, "Male Only",
                                   ifelse(status7lCPMmf$qvals.F < 0.05, "Female Only","N.S.")))


ggplot(data = status7lCPMmf,
       aes(x = `stdBetas.F`,
           y = `stdBetas.M`)) + 
  geom_point(aes(col = sig), alpha = 2/3) +
  geom_smooth(method = "lm", formula = "y~x", col = "black") +
  ggtitle("All Treatment Analysis - Male v. Female \nStatus Betas",
          subtitle = paste0("R = ",signif(cor.test(status7lCPMmf$stdBetas.M,status7lCPMmf$stdBetas.F)$estimate, digits = 1),
                            " | p = ",signif(cor.test(status7lCPMmf$stdBetas.M,status7lCPMmf$stdBetas.F)$p.value, digits = 2))) +
  xlab("Female Status Betas") + ylab("Male Status Betas") +
  labs(col = "Significance") +
  scale_color_manual(values = c(fColor,"gray60"))  +
      theme_minimal() +
        theme(axis.text = element_text(size = 15))
ggsave(paste0(figDir,"male_v_female_statusBetas_7lCPM_kmpTalk.png"), width = 6, height = 4)


```


```{r compare status sans preg nested status betas across top 25 percent models}

dir.create(paste0(figDir,"betaComp7cpm"))

#NonPregxStatus

rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_7lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

varIndex <- c("Ctrl","LPS","Dex","Gard")

for (varA in c("Ctrl","LPS","Dex","Gard")) {
  varAvalue <- which(varIndex == varA)
  
  for (varB in c("Ctrl","LPS","Dex","Gard")) {
    
    varBvalue <- which(varIndex == varB)
    modelA <- "modelR"
    modelApreg <- "modelP"
    modelB <- "modelR"
    modelBpreg <- "modelP"

    if (varA %in% c("Dex","Gard")) {
      modelA <- "modelS"
      modelApreg <- "modelQ"
    }

    if (varB %in% c("Dex","Gard")) {
      modelB <- "modelS"
      modelBpreg <- "modelQ"
    }
    
    focalVariableA <- "preg"
    focalVariableB <- "status"
    
    #within a treatment
    if (varAvalue == varBvalue) {
      #status (no-preg) v preg beta
      compLMMBeta(emremlX = paste0(outDir,"allBatches_F_",varA,"only_10000genes_7lCPM_",modelA,"_basicPreg_emmreml"),
            colnameX = focalVariableA, Xtitle = paste0(varA,"only"),
            emremlY = paste0(outDir,"allBatches_F_",varB,"only_10000genes_7lCPM_",modelBpreg,"_basicPreg_emmreml"),
            colnameY = focalVariableB, Ytitle = paste0(varB,"only"),
            figBetaDir = paste0(figDir,"betaComp7cpm"), meanGE = rowMeans(rnaCounts), topNpercent = 25,
                  sigThresh = 0.20, useQval = TRUE)
    }
    
    #across treatments
  }
}

#compare all-treatment betas
compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_allTrt_10000genes_7lCPM_modelS_allTrtF_emmreml",
      colnameX = "preg", Xtitle = "allTrt",
      emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_allTrt_10000genes_7lCPM_modelQ_allTrtF_emmreml",
      colnameY = "status", Ytitle = "allTrt",
      figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25, sigThresh = 0.10)


rnaCounts <- readRDS("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_Ctrlonly_10000genes_5lCPM_counts.RDS")
meanGE <- rowMeans(rnaCounts)

varIndex <- c("Ctrl","LPS","Dex","Gard")

for (varA in c("Ctrl","LPS","Dex","Gard")) {
  varAvalue <- which(varIndex == varA)
  
  for (varB in c("Ctrl","LPS","Dex","Gard")) {
    
    varBvalue <- which(varIndex == varB)
    modelA <- "modelR"
    modelApreg <- "modelP"
    modelB <- "modelR"
    modelBpreg <- "modelP"

    if (varA %in% c("Dex","Gard")) {
      modelA <- "modelS"
      modelApreg <- "modelQ"
    }

    if (varB %in% c("Dex","Gard")) {
      modelB <- "modelS"
      modelBpreg <- "modelQ"
    }
    
    focalVariableA <- "preg"
    focalVariableB <- "status"
    
    #within a treatment
    if (varAvalue == varBvalue) {
      #status (no-preg) v preg beta
      compLMMBeta(emremlX = paste0(outDir,"allBatches_F_",varA,"only_10000genes_5lCPM_",modelA,"_basicPreg_emmreml"),
            colnameX = focalVariableA, Xtitle = paste0(varA,"only"),
            emremlY = paste0(outDir,"allBatches_F_",varB,"only_10000genes_5lCPM_",modelBpreg,"_basicPreg_emmreml"),
            colnameY = focalVariableB, Ytitle = paste0(varB,"only"),
            figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25,
                  sigThresh = 0.20, useQval = TRUE)
    }
  }
}

#compare all-treatment betas
compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_allTrt_10000genes_5lCPM_modelS_allTrtF_emmreml",
      colnameX = "preg", Xtitle = "allTrt",
      emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_allTrt_10000genes_5lCPM_modelQ_allTrtF_emmreml",
      colnameY = "status", Ytitle = "allTrt",
      figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25, sigThresh = 0.10)

```

```{r k matrix beta comparison}
#all treatments
compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_allTrt_10000genes_5lCPM_modelG_allTrtF_emmreml",
      colnameX = "preg", Xtitle = "allTrt",
      emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_allTrt_10000genes_5lCPM_modelG_allTrtFwKmatrix_emmreml",
      colnameY = "preg", Ytitle = "allTrtKMat",
      figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25, sigThresh = 0.10)

compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_allTrt_10000genes_5lCPM_modelG_allTrtF_emmreml",
      colnameX = "status", Xtitle = "allTrt",
      emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_allTrt_10000genes_5lCPM_modelG_allTrtFwKmatrix_emmreml",
      colnameY = "status", Ytitle = "allTrtKMat",
      figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25, sigThresh = 0.10)

compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_allTrt_10000genes_5lCPM_modelG_allTrtF+Weight_emmreml",
      colnameX = "weight", Xtitle = "allTrt",
      emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_allTrt_10000genes_5lCPM_modelG_allTrtF+WeightwKmatrix_emmreml",
      colnameY = "weight", Ytitle = "allTrtKMat",
      figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25, sigThresh = 0.10)

#LPSonly
compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPSonly_10000genes_5lCPM_modelF_basicPreg_emmreml",
      colnameX = "status", Xtitle = "lpsOnly",
      emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPSonly_10000genes_5lCPM_modelF_basicPregwKmatrix_emmreml",
      colnameY = "status", Ytitle = "lpsOnlyKMat",
      figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25, sigThresh = 0.10)
compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPSonly_10000genes_5lCPM_modelF_basicPreg_emmreml",
      colnameX = "preg", Xtitle = "lpsOnly",
      emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPSonly_10000genes_5lCPM_modelF_basicPregwKmatrix_emmreml",
      colnameY = "preg", Ytitle = "lpsOnlyKMat",
      figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25, sigThresh = 0.10)

compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPSonly_10000genes_5lCPM_modelF_basicPreg+Weight_emmreml",
      colnameX = "status", Xtitle = "lpsOnly+W",
      emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPSonly_10000genes_5lCPM_modelF_basicPreg+WeightwKmatrix_emmreml",
      colnameY = "status", Ytitle = "lpsOnly+WKMat",
      figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25, sigThresh = 0.10)
compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPSonly_10000genes_5lCPM_modelF_basicPreg+Weight_emmreml",
      colnameX = "preg", Xtitle = "lpsOnly+W",
      emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPSonly_10000genes_5lCPM_modelF_basicPreg+WeightwKmatrix_emmreml",
      colnameY = "preg", Ytitle = "lpsOnly+WKMat",
      figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25, sigThresh = 0.10)
compLMMBeta(emremlX = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPSonly_10000genes_5lCPM_modelF_basicPreg+Weight_emmreml",
      colnameX = "weight", Xtitle = "lpsOnly+W",
      emremlY = "~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPSonly_10000genes_5lCPM_modelF_basicPreg+WeightwKmatrix_emmreml",
      colnameY = "weight", Ytitle = "lpsOnly+WKMat",
      figBetaDir = paste0(figDir,"betaComp"), meanGE = rowMeans(rnaCounts), topNpercent = 25, sigThresh = 0.10)
```



```{r sampling timeframe}

```

what is the effect on weight on LPS response?
the weight of females isn't necessarily predictive of status (overlaps)
there is an effect of weight in the LPS GE, but not in Ctrl
Model F + BasicPreg+Weight is a single treatment with pregnancy and weight modeled in emreml
```{r}

c <- "status"
trt <- "LPS"
thresh <- "5lCPM"
animalSex <- "F"
modelpreg <- "modelF"

emmremlResults <- read.table("~/Dropbox (Personal)/meerkats/RNA/fullAnalysis/output/allBatches_F_LPS_10000genes_5lCPM_modelF_basic_emmreml")
emmremlResults[order(emmremlResults$pval_treatment),]
```
